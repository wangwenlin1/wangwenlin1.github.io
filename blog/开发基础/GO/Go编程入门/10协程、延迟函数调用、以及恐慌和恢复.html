<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>协程、延迟函数调用、以及恐慌和恢复 | 一名GO+PHP工程师</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/blog/assets/css/0.styles.b3aba94c.css" as="style"><link rel="preload" href="/blog/assets/js/app.3a2a0635.js" as="script"><link rel="preload" href="/blog/assets/js/3.21e2e031.js" as="script"><link rel="preload" href="/blog/assets/js/51.29fb5c68.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.d053698b.js"><link rel="prefetch" href="/blog/assets/js/100.d5cb88cb.js"><link rel="prefetch" href="/blog/assets/js/101.6bbce255.js"><link rel="prefetch" href="/blog/assets/js/102.968ea43c.js"><link rel="prefetch" href="/blog/assets/js/103.c5c5130e.js"><link rel="prefetch" href="/blog/assets/js/104.161b590d.js"><link rel="prefetch" href="/blog/assets/js/105.eaae1ece.js"><link rel="prefetch" href="/blog/assets/js/106.8bdfd9bf.js"><link rel="prefetch" href="/blog/assets/js/107.c9b230ac.js"><link rel="prefetch" href="/blog/assets/js/108.a5880443.js"><link rel="prefetch" href="/blog/assets/js/109.bab44539.js"><link rel="prefetch" href="/blog/assets/js/11.bc7d0bf1.js"><link rel="prefetch" href="/blog/assets/js/110.7ba602f1.js"><link rel="prefetch" href="/blog/assets/js/111.a11c7d35.js"><link rel="prefetch" href="/blog/assets/js/112.bb76db96.js"><link rel="prefetch" href="/blog/assets/js/113.9b314292.js"><link rel="prefetch" href="/blog/assets/js/114.f28a4d47.js"><link rel="prefetch" href="/blog/assets/js/115.6a21a21a.js"><link rel="prefetch" href="/blog/assets/js/116.1fd8cdf3.js"><link rel="prefetch" href="/blog/assets/js/117.193b54e8.js"><link rel="prefetch" href="/blog/assets/js/118.d91f7ec2.js"><link rel="prefetch" href="/blog/assets/js/119.857d484f.js"><link rel="prefetch" href="/blog/assets/js/12.2003a6c5.js"><link rel="prefetch" href="/blog/assets/js/120.c2fc1bab.js"><link rel="prefetch" href="/blog/assets/js/121.e93dfc27.js"><link rel="prefetch" href="/blog/assets/js/122.0ea0246a.js"><link rel="prefetch" href="/blog/assets/js/123.31436cd9.js"><link rel="prefetch" href="/blog/assets/js/124.6b522c49.js"><link rel="prefetch" href="/blog/assets/js/125.7be39e4f.js"><link rel="prefetch" href="/blog/assets/js/126.8b8a9b2d.js"><link rel="prefetch" href="/blog/assets/js/127.7d06eb7f.js"><link rel="prefetch" href="/blog/assets/js/128.3498b329.js"><link rel="prefetch" href="/blog/assets/js/129.b4fdbe4d.js"><link rel="prefetch" href="/blog/assets/js/13.d2837ebd.js"><link rel="prefetch" href="/blog/assets/js/130.4acdc8e4.js"><link rel="prefetch" href="/blog/assets/js/131.ef9fa33c.js"><link rel="prefetch" href="/blog/assets/js/132.1f9b4bbb.js"><link rel="prefetch" href="/blog/assets/js/133.a417b118.js"><link rel="prefetch" href="/blog/assets/js/134.6a6cf86d.js"><link rel="prefetch" href="/blog/assets/js/135.313b60a3.js"><link rel="prefetch" href="/blog/assets/js/136.2c3aff88.js"><link rel="prefetch" href="/blog/assets/js/137.50106a44.js"><link rel="prefetch" href="/blog/assets/js/138.87124965.js"><link rel="prefetch" href="/blog/assets/js/139.cb5c4cb6.js"><link rel="prefetch" href="/blog/assets/js/14.48fb5c32.js"><link rel="prefetch" href="/blog/assets/js/140.9719663d.js"><link rel="prefetch" href="/blog/assets/js/141.b0090c83.js"><link rel="prefetch" href="/blog/assets/js/142.e385a422.js"><link rel="prefetch" href="/blog/assets/js/143.9d960553.js"><link rel="prefetch" href="/blog/assets/js/144.e3ef5a71.js"><link rel="prefetch" href="/blog/assets/js/145.95b58ec4.js"><link rel="prefetch" href="/blog/assets/js/146.92cd1d56.js"><link rel="prefetch" href="/blog/assets/js/147.1aad7186.js"><link rel="prefetch" href="/blog/assets/js/148.b0a6ba25.js"><link rel="prefetch" href="/blog/assets/js/149.cf51c7a4.js"><link rel="prefetch" href="/blog/assets/js/15.977c5e43.js"><link rel="prefetch" href="/blog/assets/js/150.8961d634.js"><link rel="prefetch" href="/blog/assets/js/151.d4337140.js"><link rel="prefetch" href="/blog/assets/js/152.d4fcbdac.js"><link rel="prefetch" href="/blog/assets/js/153.8f0df288.js"><link rel="prefetch" href="/blog/assets/js/154.3108e3fe.js"><link rel="prefetch" href="/blog/assets/js/155.1c76998b.js"><link rel="prefetch" href="/blog/assets/js/156.14a1e6f8.js"><link rel="prefetch" href="/blog/assets/js/157.2a90db8a.js"><link rel="prefetch" href="/blog/assets/js/158.f649eaa4.js"><link rel="prefetch" href="/blog/assets/js/159.bde474db.js"><link rel="prefetch" href="/blog/assets/js/16.cc3bb18b.js"><link rel="prefetch" href="/blog/assets/js/160.da7deb2a.js"><link rel="prefetch" href="/blog/assets/js/161.5124a074.js"><link rel="prefetch" href="/blog/assets/js/162.7f4358a0.js"><link rel="prefetch" href="/blog/assets/js/163.76da1c99.js"><link rel="prefetch" href="/blog/assets/js/164.ebc9b6a7.js"><link rel="prefetch" href="/blog/assets/js/165.f7cbff8f.js"><link rel="prefetch" href="/blog/assets/js/166.5bcaa3dd.js"><link rel="prefetch" href="/blog/assets/js/167.b4296d08.js"><link rel="prefetch" href="/blog/assets/js/168.27dc81ce.js"><link rel="prefetch" href="/blog/assets/js/169.4614ac4e.js"><link rel="prefetch" href="/blog/assets/js/17.180fd8e8.js"><link rel="prefetch" href="/blog/assets/js/170.e41001f5.js"><link rel="prefetch" href="/blog/assets/js/171.0724bbd4.js"><link rel="prefetch" href="/blog/assets/js/172.2d5b541f.js"><link rel="prefetch" href="/blog/assets/js/173.f03b20a0.js"><link rel="prefetch" href="/blog/assets/js/174.092074fb.js"><link rel="prefetch" href="/blog/assets/js/175.bbae3a5c.js"><link rel="prefetch" href="/blog/assets/js/176.2380b0cf.js"><link rel="prefetch" href="/blog/assets/js/177.67fa30a9.js"><link rel="prefetch" href="/blog/assets/js/178.7f4bf5e6.js"><link rel="prefetch" href="/blog/assets/js/18.fa5bec70.js"><link rel="prefetch" href="/blog/assets/js/19.82d0b6cb.js"><link rel="prefetch" href="/blog/assets/js/2.cf693890.js"><link rel="prefetch" href="/blog/assets/js/20.8d88eb5f.js"><link rel="prefetch" href="/blog/assets/js/21.04aa936c.js"><link rel="prefetch" href="/blog/assets/js/22.6f38dceb.js"><link rel="prefetch" href="/blog/assets/js/23.00b0c454.js"><link rel="prefetch" href="/blog/assets/js/24.4949647c.js"><link rel="prefetch" href="/blog/assets/js/25.f090d9de.js"><link rel="prefetch" href="/blog/assets/js/26.64e9b11e.js"><link rel="prefetch" href="/blog/assets/js/27.f6f1b280.js"><link rel="prefetch" href="/blog/assets/js/28.ba46dc32.js"><link rel="prefetch" href="/blog/assets/js/29.08dd160e.js"><link rel="prefetch" href="/blog/assets/js/30.1f6b9a8b.js"><link rel="prefetch" href="/blog/assets/js/31.edcef4fa.js"><link rel="prefetch" href="/blog/assets/js/32.763b7b98.js"><link rel="prefetch" href="/blog/assets/js/33.10fa82ac.js"><link rel="prefetch" href="/blog/assets/js/34.783e6db1.js"><link rel="prefetch" href="/blog/assets/js/35.86d13f87.js"><link rel="prefetch" href="/blog/assets/js/36.c81ca450.js"><link rel="prefetch" href="/blog/assets/js/37.6c8b6e4d.js"><link rel="prefetch" href="/blog/assets/js/38.fed1555d.js"><link rel="prefetch" href="/blog/assets/js/39.d8367356.js"><link rel="prefetch" href="/blog/assets/js/4.33e3eeff.js"><link rel="prefetch" href="/blog/assets/js/40.890bdfe6.js"><link rel="prefetch" href="/blog/assets/js/41.351a2bb7.js"><link rel="prefetch" href="/blog/assets/js/42.7dc0997f.js"><link rel="prefetch" href="/blog/assets/js/43.b1eb7b31.js"><link rel="prefetch" href="/blog/assets/js/44.96773f8a.js"><link rel="prefetch" href="/blog/assets/js/45.14984c3f.js"><link rel="prefetch" href="/blog/assets/js/46.360c94b5.js"><link rel="prefetch" href="/blog/assets/js/47.6ba6e036.js"><link rel="prefetch" href="/blog/assets/js/48.7e30092c.js"><link rel="prefetch" href="/blog/assets/js/49.cffe09bd.js"><link rel="prefetch" href="/blog/assets/js/5.93c02369.js"><link rel="prefetch" href="/blog/assets/js/50.10849ea7.js"><link rel="prefetch" href="/blog/assets/js/52.c183fd4d.js"><link rel="prefetch" href="/blog/assets/js/53.2102d53f.js"><link rel="prefetch" href="/blog/assets/js/54.a7def65b.js"><link rel="prefetch" href="/blog/assets/js/55.e1462b05.js"><link rel="prefetch" href="/blog/assets/js/56.d35a7dec.js"><link rel="prefetch" href="/blog/assets/js/57.f908b76a.js"><link rel="prefetch" href="/blog/assets/js/58.8c699c1a.js"><link rel="prefetch" href="/blog/assets/js/59.013048e6.js"><link rel="prefetch" href="/blog/assets/js/6.bf46d9ef.js"><link rel="prefetch" href="/blog/assets/js/60.96011719.js"><link rel="prefetch" href="/blog/assets/js/61.c57dc954.js"><link rel="prefetch" href="/blog/assets/js/62.24bf6999.js"><link rel="prefetch" href="/blog/assets/js/63.2f87f55d.js"><link rel="prefetch" href="/blog/assets/js/64.68cd3b45.js"><link rel="prefetch" href="/blog/assets/js/65.d1a0e0c0.js"><link rel="prefetch" href="/blog/assets/js/66.d694b5d5.js"><link rel="prefetch" href="/blog/assets/js/67.1d93ad03.js"><link rel="prefetch" href="/blog/assets/js/68.7a922734.js"><link rel="prefetch" href="/blog/assets/js/69.e8dc5f21.js"><link rel="prefetch" href="/blog/assets/js/7.965a7048.js"><link rel="prefetch" href="/blog/assets/js/70.0ab39b68.js"><link rel="prefetch" href="/blog/assets/js/71.32fb9ba8.js"><link rel="prefetch" href="/blog/assets/js/72.d7621fb4.js"><link rel="prefetch" href="/blog/assets/js/73.f0b18643.js"><link rel="prefetch" href="/blog/assets/js/74.f4b27305.js"><link rel="prefetch" href="/blog/assets/js/75.d52134dd.js"><link rel="prefetch" href="/blog/assets/js/76.af8a1eb5.js"><link rel="prefetch" href="/blog/assets/js/77.be15b0d2.js"><link rel="prefetch" href="/blog/assets/js/78.d456dcce.js"><link rel="prefetch" href="/blog/assets/js/79.12735350.js"><link rel="prefetch" href="/blog/assets/js/8.78eeb959.js"><link rel="prefetch" href="/blog/assets/js/80.2120e0e9.js"><link rel="prefetch" href="/blog/assets/js/81.04f50a1e.js"><link rel="prefetch" href="/blog/assets/js/82.db879ca5.js"><link rel="prefetch" href="/blog/assets/js/83.e89b8863.js"><link rel="prefetch" href="/blog/assets/js/84.07410b58.js"><link rel="prefetch" href="/blog/assets/js/85.d3e35fad.js"><link rel="prefetch" href="/blog/assets/js/86.f855e246.js"><link rel="prefetch" href="/blog/assets/js/87.bf22bce7.js"><link rel="prefetch" href="/blog/assets/js/88.6ed1a43d.js"><link rel="prefetch" href="/blog/assets/js/89.50e298db.js"><link rel="prefetch" href="/blog/assets/js/9.009d1183.js"><link rel="prefetch" href="/blog/assets/js/90.391f76ed.js"><link rel="prefetch" href="/blog/assets/js/91.d1662d38.js"><link rel="prefetch" href="/blog/assets/js/92.a65aa479.js"><link rel="prefetch" href="/blog/assets/js/93.bc850b53.js"><link rel="prefetch" href="/blog/assets/js/94.7dc858d7.js"><link rel="prefetch" href="/blog/assets/js/95.fce3d2c0.js"><link rel="prefetch" href="/blog/assets/js/96.7e3abf55.js"><link rel="prefetch" href="/blog/assets/js/97.64d3b035.js"><link rel="prefetch" href="/blog/assets/js/98.fdb7d67a.js"><link rel="prefetch" href="/blog/assets/js/99.9a416d3b.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.b3aba94c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">一名GO+PHP工程师</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://gitee.com/ColinWWL/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://gitee.com/ColinWWL/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/Go类型系统/1Go类型系统概述" class="sidebar-heading clickable"><span>Go类型系统</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/Go类型系统/1Go类型系统概述.html" class="sidebar-link">Go类型系统概述</a></li><li><a href="/blog/开发基础/GO/Go类型系统/2指针.html" class="sidebar-link">指针</a></li><li><a href="/blog/开发基础/GO/Go类型系统/3结构体.html" class="sidebar-link">结构体</a></li><li><a href="/blog/开发基础/GO/Go类型系统/4值部.html" class="sidebar-link">值部</a></li><li><a href="/blog/开发基础/GO/Go类型系统/5数组、切片和映射.html" class="sidebar-link">数组、切片和映射</a></li><li><a href="/blog/开发基础/GO/Go类型系统/6通道.html" class="sidebar-link">通道</a></li><li><a href="/blog/开发基础/GO/Go类型系统/7方法.html" class="sidebar-link">方法</a></li><li><a href="/blog/开发基础/GO/Go类型系统/8接口.html" class="sidebar-link">接口</a></li><li><a href="/blog/开发基础/GO/Go类型系统/9类型内嵌.html" class="sidebar-link">类型内嵌</a></li><li><a href="/blog/开发基础/GO/Go类型系统/10非类型安全指针.html" class="sidebar-link">非类型安全指针</a></li><li><a href="/blog/开发基础/GO/Go类型系统/11泛型.html" class="sidebar-link">泛型</a></li><li><a href="/blog/开发基础/GO/Go类型系统/12反射.html" class="sidebar-link">反射</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/Go编程入门/1程序源代码基本元素介绍" class="sidebar-heading clickable open"><span>Go编程入门</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/Go编程入门/1程序源代码基本元素介绍.html" class="sidebar-link">程序源代码基本元素介绍</a></li><li><a href="/blog/开发基础/GO/Go编程入门/2关键字和标识符.html" class="sidebar-link">关键字和标识符</a></li><li><a href="/blog/开发基础/GO/Go编程入门/3基本类型和它们的字面量表示.html" class="sidebar-link">基本类型和它们的字面量表示</a></li><li><a href="/blog/开发基础/GO/Go编程入门/4常量和变量.html" class="sidebar-link">常量和变量</a></li><li><a href="/blog/开发基础/GO/Go编程入门/5运算操作符.html" class="sidebar-link">运算操作符</a></li><li><a href="/blog/开发基础/GO/Go编程入门/6函数声明和调用.html" class="sidebar-link">函数声明和调用</a></li><li><a href="/blog/开发基础/GO/Go编程入门/7代码包和包引入.html" class="sidebar-link">代码包和包引入</a></li><li><a href="/blog/开发基础/GO/Go编程入门/8表达式、语句和简单语句.html" class="sidebar-link">表达式、语句和简单语句</a></li><li><a href="/blog/开发基础/GO/Go编程入门/9基本流程控制语法.html" class="sidebar-link">基本流程控制语法</a></li><li><a href="/blog/开发基础/GO/Go编程入门/10协程、延迟函数调用、以及恐慌和恢复.html" class="active sidebar-link">协程、延迟函数调用、以及恐慌和恢复</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go编程入门/10协程、延迟函数调用、以及恐慌和恢复.html#协程-goroutine" class="sidebar-link">协程（goroutine）</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go编程入门/10协程、延迟函数调用、以及恐慌和恢复.html#并发同步-concurrency-synchronization" class="sidebar-link">并发同步（concurrency synchronization）</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go编程入门/10协程、延迟函数调用、以及恐慌和恢复.html#协程的状态" class="sidebar-link">协程的状态</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go编程入门/10协程、延迟函数调用、以及恐慌和恢复.html#协程的调度" class="sidebar-link">协程的调度</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go编程入门/10协程、延迟函数调用、以及恐慌和恢复.html#延迟函数调用-deferred-function-call" class="sidebar-link">延迟函数调用（deferred function call）</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go编程入门/10协程、延迟函数调用、以及恐慌和恢复.html#一个延迟调用可以修改包含此延迟调用的最内层函数的返回值" class="sidebar-link">一个延迟调用可以修改包含此延迟调用的最内层函数的返回值</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go编程入门/10协程、延迟函数调用、以及恐慌和恢复.html#延迟函数调用的必要性和好处" class="sidebar-link">延迟函数调用的必要性和好处</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go编程入门/10协程、延迟函数调用、以及恐慌和恢复.html#协程和延迟调用的实参的估值时刻" class="sidebar-link">协程和延迟调用的实参的估值时刻</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go编程入门/10协程、延迟函数调用、以及恐慌和恢复.html#恐慌-panic-和恢复-recover" class="sidebar-link">恐慌（panic）和恢复（recover）</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go编程入门/10协程、延迟函数调用、以及恐慌和恢复.html#一些致命性错误不属于恐慌" class="sidebar-link">一些致命性错误不属于恐慌</a></li></ul></li><li><a href="/blog/开发基础/GO/Go编程入门/GO官方链接工具.html" class="sidebar-link">GO官方链接工具</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/其他文章/Go技巧" class="sidebar-heading clickable"><span>其他文章</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/其他文章/Go技巧.html" class="sidebar-link">Go技巧</a></li><li><a href="/blog/开发基础/GO/其他文章/Go细节.html" class="sidebar-link">Go细节</a></li><li><a href="/blog/开发基础/GO/其他文章/Go问答.html" class="sidebar-link">Go问答</a></li><li><a href="/blog/开发基础/GO/其他文章/命令-mod.html" class="sidebar-link">命令-mod</a></li><li><a href="/blog/开发基础/GO/其他文章/基础-Golang的time.NewTimer单次定时器使用案例.html" class="sidebar-link">基础-Golang的time. NewTimer单次定时器使用案例</a></li><li><a href="/blog/开发基础/GO/其他文章/基础-Go中的nil.html" class="sidebar-link">Go中的 nil</a></li><li><a href="/blog/开发基础/GO/其他文章/基础-Go代码断行规则.html" class="sidebar-link">Go代码断行规则</a></li><li><a href="/blog/开发基础/GO/其他文章/基础-表达式估值顺序规则.html" class="sidebar-link">表达式估值顺序规则</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/学习资料" class="sidebar-heading clickable"><span>GO</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/学习资料.html" class="sidebar-link">教学书籍</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/并发编程/1并发同步概述" class="sidebar-heading clickable"><span>并发编程</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/并发编程/1并发同步概述.html" class="sidebar-link">并发同步概述</a></li><li><a href="/blog/开发基础/GO/并发编程/2通道用例大全.html" class="sidebar-link">通道用例大全</a></li><li><a href="/blog/开发基础/GO/并发编程/3如何优雅地关闭通道.html" class="sidebar-link">如何优雅地关闭通道</a></li><li><a href="/blog/开发基础/GO/并发编程/4其它并发同步技术.html" class="sidebar-link">sync 标准库包中提供的并发同步技术</a></li><li><a href="/blog/开发基础/GO/并发编程/5原子操作 .html" class="sidebar-link">sync/atomic 标准库包中提供的原子操作</a></li><li><a href="/blog/开发基础/GO/并发编程/6Go中的内存顺序保证.html" class="sidebar-link">Go中的内存顺序保证</a></li><li><a href="/blog/开发基础/GO/并发编程/7一些常见并发编程错误.html" class="sidebar-link">一些常见并发编程错误</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/开发环境搭建/Docker和VS Code的Go开发环境" class="sidebar-heading clickable"><span>开发环境搭建</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/开发环境搭建/Docker和VS Code的Go开发环境.html" class="sidebar-link">Docker和VS Code的Go开发环境</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="协程、延迟函数调用、以及恐慌和恢复"><a href="#协程、延迟函数调用、以及恐慌和恢复" class="header-anchor">#</a> 协程、延迟函数调用、以及恐慌和恢复</h1> <p>此篇文章将介绍协程和延迟函数调用。协程和延迟函数调用是Go中比较独特的两个特性。 恐慌和恢复也将在此篇文章中得到简单介绍。本文并非全面地对这些特性进行介绍，后面的其它文章会陆续补全本文的未介绍的内容。</p> <h2 id="协程-goroutine"><a href="#协程-goroutine" class="header-anchor">#</a> 协程（goroutine）</h2> <p>现代CPU一般含有多个核，并且一个核可能支持多线程。换句话说，现代CPU可以同时执行多条指令流水线。 为了将CPU的能力发挥到极致，我们常常需要使我们的程序支持并发（concurrent）计算。</p> <p>并发计算是指若干计算可能在某些时间片段内同时运行的情形。 下面这两张图描绘了两种并发计算的场景。在此图中，A和B表示两个计算。 在第一种情形中，两个计算只在某些时间片段同时运行。 第二种情形称为并行（parallel）计算。在并行计算中，多个计算在任何时间点都在同时运行。并行计算属于特殊的并发计算。</p> <p><img src="data:image/png;base64,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" alt="并发和并行"></p> <p>并发计算可能发生在同一个程序中、同一台电脑上、或者同一个网络中。 在《Go语言101》中，我们只谈及发生在同一个程序中的并发计算。 在Go编程中，协程是创建计算的唯一途径。</p> <p>协程有时也被称为绿色线程。绿色线程是由程序的运行时（runtime）维护的线程。一个绿色线程的内存开销和情景转换（context switching）时耗比一个系统线程常常小得多。 只要内存充足，一个程序可以轻松支持上万个并发协程。</p> <p>Go不支持创建系统线程，所以协程是一个Go程序内部唯一的并发实现方式。</p> <p>每个Go程序启动的时候只有一个对用户可见的协程，我们称之为主协程。 一个协程可以开启更多其它新的协程。在Go中，开启一个新的协程是非常简单的。 我们只需在一个函数调用之前使用一个 <code>go</code> 关键字，即可让此函数调用运行在一个新的协程之中。 当此函数调用退出后，这个新的协程也随之结束了。我们可以称此函数调用为一个协程调用（或者为此协程的启动调用）。 一个协程调用的所有返回值（如果存在的话）必须被全部舍弃。</p> <p>在下面的例子程序中，主协程创建了两个新的协程。在此例中， <code>time.Duration</code> 是一个在 <code>time</code> 标准库包中定义的类型。 此类型的底层类型为内置类型 <code>int64</code> 。 底层类型这个概念将在<a href="https://gfw.go101.org/article/type-system-overview.html#underlying-type" target="_blank" rel="noopener noreferrer">下一篇文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中介绍。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;math/rand&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">SayGreetings</span><span class="token punctuation">(</span>greeting <span class="token builtin">string</span><span class="token punctuation">,</span> times <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> times<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>greeting<span class="token punctuation">)</span>
		d <span class="token operator">:=</span> time<span class="token punctuation">.</span>Second <span class="token operator">*</span> time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token comment">// 睡眠片刻（随机0到2.5秒）</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rand<span class="token punctuation">.</span><span class="token function">Seed</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">SetFlags</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">SayGreetings</span><span class="token punctuation">(</span><span class="token string">&quot;hi!&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">SayGreetings</span><span class="token punctuation">(</span><span class="token string">&quot;hello!&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>非常简单！我们编写了一个并发程序！ 此程序在运行的时候在某一时刻将很可能会有三个协程并存。 运行之，可能会得到如下的结果（也可能是其它结果）：</p> <div class="language- extra-class"><pre class="language-text"><code>
hi!
hello!
hello!
hello!
hello!
hi!
</code></pre></div><p>当一个程序的主协程退出后，此程序也就退出了，即使还有一些其它协程在运行。</p> <p>和前面的几篇文章不同，上面的例子程序使用了 <code>log</code> 标准库而不是 <code>fmt</code> 标准库中的 <code>Println</code> 函数。 原因是 <code>log</code> 标准库中的打印函数是经过了同步处理的（下一节将解释什么是并发同步），而 <code>fmt</code> 标准库中的打印函数却没有被同步。 如果我们在上例中使用 <code>fmt</code> 标准库中的 <code>Println</code> 函数，则不同协程的打印可能会交织在一起。（虽然对此例来说，交织的概率很低。）</p> <h2 id="并发同步-concurrency-synchronization"><a href="#并发同步-concurrency-synchronization" class="header-anchor">#</a> 并发同步（concurrency synchronization）</h2> <p>不同的并发计算可能共享一些资源，其中共享内存资源最为常见。 在一个并发程序中，常常会发生下面的情形：</p> <ul><li>在一个计算向一段内存写数据的时候，另一个计算从此内存段读数据，结果导致读出的数据的完整性得不到保证。</li> <li>在一个计算向一段内存写数据的时候，另一个计算也向此段内存写数据，结果导致被写入的数据的完整性得不到保证。</li></ul> <p>这些情形被称为数据竞争（data race）。并发编程的一大任务就是要调度不同计算，控制它们对资源的访问时段，以使数据竞争的情况不会发生。 此任务常称为并发同步（或者数据同步）。Go支持几种并发同步技术，这些并发同步技术将在后面的章节中逐一介绍。</p> <p>并发编程中的其它任务包括：</p> <ul><li>决定需要开启多少计算；</li> <li>决定何时开启、阻塞、解除阻塞和结束哪些计算；</li> <li>决定如何在不同的计算中分担工作负载。</li></ul> <p>上一节中这个并发程序是有缺陷的。我们本期望每个新创建的协程打印出10条问候语，但是主协程（和程序）在这20条问候语还未都打印出来的时候就退出了。 如何确保主协程在这20条问候语都打印完毕之后才退出呢？我们必须使用某种并发同步技术来达成这一目标。</p> <p>Go支持几种<a href="https://gfw.go101.org/article/concurrent-synchronization-overview.html" target="_blank" rel="noopener noreferrer">并发同步技术<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。 其中， <a href="https://gfw.go101.org/article/channel.html" target="_blank" rel="noopener noreferrer">通道<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是最独特和最常用的。 但是，为了简单起见，这里我们将使用 <code>sync</code> 标准库包中的 <code>WaitGroup</code> 来同步上面这个程序中的主协程和两个新创建的协程。</p> <p><code>WaitGroup</code> 类型有三个方法（特殊的函数，将在以后的文章中详解）： <code>Add</code> 、 <code>Done</code> 和 <code>Wait</code> 。 此类型将在后面的某篇文章中详细解释，目前我们可以简单地认为：</p> <ul><li><code>Add</code>方法用来注册新的需要完成的任务数。</li> <li><code>Done</code>方法用来通知某个任务已经完成了。</li> <li>一个<code>Wait</code>方法调用将阻塞（等待）到所有任务都已经完成之后才继续执行其后的语句。</li></ul> <p>示例：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;math/rand&quot;</span>
	<span class="token string">&quot;time&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup

<span class="token keyword">func</span> <span class="token function">SayGreetings</span><span class="token punctuation">(</span>greeting <span class="token builtin">string</span><span class="token punctuation">,</span> times <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> times<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>greeting<span class="token punctuation">)</span>
		d <span class="token operator">:=</span> time<span class="token punctuation">.</span>Second <span class="token operator">*</span> time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 通知当前任务已经完成。</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rand<span class="token punctuation">.</span><span class="token function">Seed</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">SetFlags</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 注册两个新任务。</span>
	<span class="token keyword">go</span> <span class="token function">SayGreetings</span><span class="token punctuation">(</span><span class="token string">&quot;hi!&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">SayGreetings</span><span class="token punctuation">(</span><span class="token string">&quot;hello!&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 阻塞在这里，直到所有任务都已完成。</span>
<span class="token punctuation">}</span>
</code></pre></div><p>运行这个修改后的程序，我们将会发现所有的20条问候语都将在程序退出之前打印出来。</p> <h2 id="协程的状态"><a href="#协程的状态" class="header-anchor">#</a> 协程的状态</h2> <p>从上面这个的例子，我们可以看到一个活动中的协程可以处于两个状态：<strong>运行状态</strong>和<strong>阻塞状态</strong>。一个协程可以在这两个状态之间切换。 比如上例中的主协程在调用 <code>wg.Wait</code> 方法的时候，将从运行状态切换到阻塞状态；当两个新协程完成各自的任务后，主协程将从阻塞状态切换回运行状态。</p> <p>下面的图片显示了一个协程的生命周期。</p> <p><img src="data:image/png;base64,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" alt="协程状态"></p> <p>注意，一个处于睡眠中的（通过调用 <code>time.Sleep</code> ）或者在等待系统调用返回的协程被认为是处于运行状态，而不是阻塞状态。</p> <p>当一个新协程被创建的时候，它将自动进入运行状态，一个协程只能从运行状态而不能从阻塞状态退出。 如果因为某种原因而导致某个协程一直处于阻塞状态，则此协程将永远不会退出。 除了极个别的应用场景，在编程时我们应该尽量避免出现这样的情形。</p> <p>一个处于阻塞状态的协程不会自发结束阻塞状态，它必须被另外一个协程通过某种并发同步方法来被动地结束阻塞状态。 如果一个运行中的程序当前所有的协程都出于阻塞状态，则这些协程将永远阻塞下去，程序将被视为死锁了。 当一个程序死锁后，官方标准编译器的处理是让这个程序崩溃。</p> <p>比如下面这个程序将在运行两秒钟后崩溃。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;sync&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
		wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 阻塞在此</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 阻塞在此</span>
<span class="token punctuation">}</span>
</code></pre></div><p>它的输出：</p> <div class="language- extra-class"><pre class="language-text"><code>
fatal error: all goroutines are asleep - deadlock!

...
</code></pre></div><p>以后我们将学习到更多可以让一个协程进入到阻塞状态的操作。</p> <h2 id="协程的调度"><a href="#协程的调度" class="header-anchor">#</a> 协程的调度</h2> <p>并非所有处于运行状态的协程都在执行。在任一时刻，只能最多有和逻辑CPU数目一样多的协程在同时执行。 我们可以调用<a href="https://golang.google.cn/pkg/runtime/#NumCPU" target="_blank" rel="noopener noreferrer"><code>runtime.NumCPU</code> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>函数来查询当前程序可利用的逻辑CPU数目。 每个逻辑CPU在同一时刻只能最多执行一个协程。Go运行时（runtime）必须让逻辑CPU频繁地在不同的处于运行状态的协程之间切换，从而每个处于运行状态的协程都有机会得到执行。 这和操作系统执行系统线程的原理是一样的。</p> <p>下面这张图显示了一个协程的更详细的生命周期。在此图中，运行状态被细分成了多个子状态。 一个处于排队子状态的协程等待着进入执行子状态。一个处于执行子状态的协程在被执行一会儿（非常短的时间片）之后将进入排队子状态。</p> <p><img src="/blog/assets/img/goroutine-schedule.639f6cbc.png" alt="协程详细状态"></p> <p>请注意，为了解释的简单性，在以后其它的《Go语言101》文章中，上图中所示的子状态将不会再提及。 重申一下，睡眠和等待系统调用返回子状态被认为是运行状态，而不是阻塞状态。</p> <p>标准编译器采纳了一种被称为<a href="https://docs.google.com/document/d/1TTj4T2JO42uD5ID9e89oa0sLKhJYD0Y_kqxDv3I3XMw" target="_blank" rel="noopener noreferrer">M-P-G模型<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的算法来实现协程调度。 其中，<strong>M</strong>表示系统线程，<strong>P</strong>表示逻辑处理器（并非上述的逻辑CPU），<strong>G</strong>表示协程。 大多数的调度工作是通过逻辑处理器（<strong>P</strong>）来完成的。 逻辑处理器像一个监工一样通过将不同的处于运行状态协程（<strong>G</strong>）交给不同的系统线程（<strong>M</strong>）来执行。 一个协程在同一时刻只能在一个系统线程中执行。一个执行中的协程运行片刻后将自发地脱离让出一个系统线程，从而使得其它处于等待子状态的协程得到执行机会。</p> <p>在运行时刻，我们可以调用<a href="https://golang.google.cn/pkg/runtime/#GOMAXPROCS" target="_blank" rel="noopener noreferrer"><code>runtime.GOMAXPROCS</code> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>函数来获取和设置逻辑处理器的数量。 对于官方标准编译器，在Go 1.5之前，默认初始逻辑处理器的数量为1；自从Go 1.5之后，默认初始逻辑处理器的数量和逻辑CPU的数量一致。 此新的默认设置在大多数情况下是最佳选择。但是对于某些文件操作十分频繁的程序，设置一个大于 <code>runtime.NumCPU()</code> 的 <code>GOMAXPROCS</code> 值可能是有好处的。</p> <p>我们也可以通过设置 <code>GOMAXPROCS</code> 环境变量来设置一个Go程序的初始逻辑处理器数量。</p> <h2 id="延迟函数调用-deferred-function-call"><a href="#延迟函数调用-deferred-function-call" class="header-anchor">#</a> 延迟函数调用（deferred function call）</h2> <p>在Go中，一个函数调用可以跟在一个 <code>defer</code> 关键字后面，形成一个延迟函数调用。 和协程调用类似，被延迟的函数调用的所有返回值必须全部被舍弃。</p> <p>当一个函数调用被延迟后，它不会立即被执行。它将被推入由当前协程维护的一个延迟调用堆栈。 当一个函数调用（可能是也可能不是一个延迟调用）返回并进入它的<a href="https://gfw.go101.org/article/function-declarations-and-calls.html#exiting-phase" target="_blank" rel="noopener noreferrer">退出阶段<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>后，所有在此函数调用中已经被推入的延迟调用将被按照它们被推入堆栈的顺序逆序执行。 当所有这些延迟调用执行完毕后，此函数调用也就真正退出了。</p> <p>下面这个例子展示了如何使用延迟调用函数。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;The third line.&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;The second line.&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;The first line.&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>输出结果：</p> <div class="language- extra-class"><pre class="language-text"><code>
The first line.
The second line.
The third line.
</code></pre></div><p>事实上，每个协程维护着两个调用堆栈。</p> <ul><li>一个是正常的函数调用堆栈。在此堆栈中，相邻的两个调用存在着调用关系。晚进入堆栈的调用被早进入堆栈的调用所调用。 此堆栈中最早被推入的调用是对应协程的启动调用。</li> <li>另一个堆栈是上面提到的延迟调用堆栈。处于延迟调用堆栈中的任意两个调用之间不存在调用关系。</li></ul> <p>下面是另一个略微复杂一点的使用了延迟调用的例子程序。此程序将按照自然数的顺序打印出0到9十个数字。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;9&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;8&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token boolean">false</span> <span class="token punctuation">{</span>
		<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;not reachable&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;7&quot;</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;6&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span>
	<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;not reachable&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="一个延迟调用可以修改包含此延迟调用的最内层函数的返回值"><a href="#一个延迟调用可以修改包含此延迟调用的最内层函数的返回值" class="header-anchor">#</a> 一个延迟调用可以修改包含此延迟调用的最内层函数的返回值</h2> <p>一个例子：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">Triple</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>r <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		r <span class="token operator">+=</span> n <span class="token comment">// 修改返回值</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> n <span class="token operator">+</span> n <span class="token comment">// &lt;=&gt; r = n + n; return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">Triple</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 15</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="延迟函数调用的必要性和好处"><a href="#延迟函数调用的必要性和好处" class="header-anchor">#</a> 延迟函数调用的必要性和好处</h2> <p>事实上，上面的几个使用了延迟函数调用的例子中的延迟函数调用并非绝对必要。 但是延迟调用对于下面将要介绍的恐慌/恢复特性是必要的。</p> <p>另外延迟函数调用可以帮助我们写出更整洁和更鲁棒的代码。我们可以在后面的<a href="https://gfw.go101.org/article/defer-more.html" target="_blank" rel="noopener noreferrer">更多关于延迟调用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>一文中读到这样的例子。</p> <h2 id="协程和延迟调用的实参的估值时刻"><a href="#协程和延迟调用的实参的估值时刻" class="header-anchor">#</a> 协程和延迟调用的实参的估值时刻</h2> <p>一个协程调用或者延迟调用的实参是在此调用发生时被估值的。更具体地说，</p> <ul><li>对于一个延迟函数调用，它的实参是在此调用被推入延迟调用堆栈的时候被估值的。</li> <li>对于一个协程调用，它的实参是在此协程被创建的时候估值的。</li></ul> <p>一个匿名函数体内的表达式是在此函数被执行的时候才会被逐个估值的，不管此函数是被普通调用还是延迟/协程调用。</p> <p>一个例子：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;a:&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;b:&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>运行之，将得到如下结果：</p> <div class="language- extra-class"><pre class="language-text"><code>
a: 2
a: 1
a: 0

b: 3
b: 3
b: 3
</code></pre></div><p>第一个匿名函数中的循环打印出 <code>2</code> 、 <code>1</code> 和 <code>0</code> 这个序列，但是第二个匿名函数中的循环打印出三个 <code>3</code> 。 因为第一个循环中的 <code>i</code> 是在 <code>fmt.Println</code> 函数调用被推入延迟调用堆栈的时候估的值，而第二个循环中的 <code>i</code> 是在第二个匿名函数调用的退出阶段估的值（此时循环变量 <code>i</code> 的值已经变为 <code>3</code> ）。</p> <p>我们可以对第二个循环略加修改（使用两种方法），使得它和第一个循环打印出相同的结果。</p> <div class="language-go extra-class"><pre class="language-go"><code>		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// 此i为形参i，非实参循环变量i。</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;b:&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
</code></pre></div><p>或者</p> <div class="language-go extra-class"><pre class="language-go"><code>		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			i <span class="token operator">:=</span> i <span class="token comment">// 在下面的调用中，左i遮挡了右i。</span>
			       <span class="token comment">// &lt;=&gt; var i = i</span>
			<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// 此i为上面的左i，非循环变量i。</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;b:&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
</code></pre></div><p>同样的估值时刻规则也适用于协程调用。下面这个例子程序将打印出 <code>123 789</code> 。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>
<span class="token keyword">import</span> <span class="token string">&quot;time&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">123</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>x <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token comment">// 123 789</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>

	a <span class="token operator">=</span> <span class="token number">789</span>

	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>顺便说一句，使用 <code>time.Sleep</code> 调用来做并发同步不是一个好的方法。 如果上面这个程序运行在一个满负荷运行的电脑上，此程序可能在新启动的协程可能还未得到执行机会的时候就已经退出了。 在正式的项目中，我们应该使用<a href="https://gfw.go101.org/article/concurrent-synchronization-overview.html" target="_blank" rel="noopener noreferrer">并发同步技术<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>一文中列出的方法来实现并发同步。</p> <h2 id="恐慌-panic-和恢复-recover"><a href="#恐慌-panic-和恢复-recover" class="header-anchor">#</a> 恐慌（panic）和恢复（recover）</h2> <p>Go不支持异常抛出和捕获，而是推荐使用返回值显式返回错误。 不过，Go支持一套和异常抛出/捕获类似的机制。此机制称为恐慌/恢复（panic/recover）机制。</p> <p>我们可以调用内置函数 <code>panic</code> 来产生一个恐慌以使当前协程进入恐慌状况。</p> <p>进入恐慌状况是另一种使当前函数调用开始返回的途径。 一旦一个函数调用产生一个恐慌，此函数调用将立即进入它的退出阶段，在此函数调用中被推入堆栈的延迟调用将按照它们被推入的顺序逆序执行。</p> <p>通过在一个延迟函数调用之中调用内置函数 <code>recover</code> ，当前协程中的一个恐慌可以被消除，从而使得当前协程重新进入正常状况。</p> <p>在一个处于恐慌状况的协程退出之前，其中的恐慌不会蔓延到其它协程。 如果一个协程在恐慌状况下退出，它将使整个程序崩溃。</p> <p>内置函数 <code>panic</code> 和 <code>recover</code> 的声明原型如下：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">panic</span><span class="token punctuation">(</span>v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>接口（interface）类型和接口值将在以后的文章<a href="https://gfw.go101.org/article/interface.html" target="_blank" rel="noopener noreferrer">接口<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中详解。 目前，我们可以暂时将空接口类型 <code>interface{}</code> 视为很多其它语言中的 <code>any</code> 或者 <code>Object</code> 类型。 换句话说，在一个 <code>panic</code> 函数调用中，我们可以传任何实参值。</p> <p>一个 <code>recover</code> 函数的返回值为其所恢复的恐慌在产生时被一个 <code>panic</code> 函数调用所消费的参数。</p> <p>下面这个例子展示了如何产生一个恐慌和如何消除一个恐慌。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;正常退出&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;嗨！&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		v <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;恐慌被恢复了：&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;拜拜！&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 产生一个恐慌</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;执行不到这里&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>它的输出结果：</p> <div class="language- extra-class"><pre class="language-text"><code>
嗨！
恐慌被恢复了： 拜拜！
正常退出
</code></pre></div><p>下面的例子在一个新协程里面产生了一个恐慌，并且此协程在恐慌状况下退出，所以整个程序崩溃了。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;hi!&quot;</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>运行之，输出如下：</p> <div class="language- extra-class"><pre class="language-text"><code>
hi!
panic: 123

goroutine 5 [running]:
...
</code></pre></div><p>Go运行时（runtime）会在若干情形下产生恐慌，比如一个整数被0除的时候。下面这个程序将崩溃退出。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> a<span class="token operator">/</span>b
<span class="token punctuation">}</span>
</code></pre></div><p>它的输出：</p> <div class="language- extra-class"><pre class="language-text"><code>
panic: runtime error: integer divide by zero

goroutine 1 [running]:
...
</code></pre></div><p>一般说来，恐慌用来表示正常情况下不应该发生的逻辑错误。 如果这样的一个错误在运行时刻发生了，则它肯定是由于某个bug引起的。 另一方面，非逻辑错误是现实中难以避免的错误，它们不应该导致恐慌。 我们必须正确地对待和处理非逻辑错误。</p> <p>更多可能由Go运行时产生的恐慌将在以后其它文章中提及。</p> <p>以后，我们可以了解<a href="https://gfw.go101.org/article/panic-and-recover-use-cases.html" target="_blank" rel="noopener noreferrer">一些恐慌/恢复用例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>和<a href="https://gfw.go101.org/article/panic-and-recover-more.html" target="_blank" rel="noopener noreferrer">更多关于恐慌/恢复机制的细节<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h2 id="一些致命性错误不属于恐慌"><a href="#一些致命性错误不属于恐慌" class="header-anchor">#</a> 一些致命性错误不属于恐慌</h2> <p>对于官方标准编译器来说，很多致命性错误（比如堆栈溢出和内存不足）不能被恢复。它们一旦产生，程序将崩溃。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/21/2021, 1:25:38 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/开发基础/GO/Go编程入门/9基本流程控制语法.html" class="prev">
        基本流程控制语法
      </a></span> <span class="next"><a href="/blog/开发基础/GO/Go编程入门/GO官方链接工具.html">
        GO官方链接工具
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.3a2a0635.js" defer></script><script src="/blog/assets/js/3.21e2e031.js" defer></script><script src="/blog/assets/js/51.29fb5c68.js" defer></script>
  </body>
</html>
