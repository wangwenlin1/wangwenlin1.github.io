<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>sync/atomic 标准库包中提供的原子操作 | 一名GO+PHP工程师</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/blog/assets/css/0.styles.e16ad0a6.css" as="style"><link rel="preload" href="/blog/assets/js/app.b472f60d.js" as="script"><link rel="preload" href="/blog/assets/js/3.21e2e031.js" as="script"><link rel="preload" href="/blog/assets/js/116.f4969b27.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.414eb148.js"><link rel="prefetch" href="/blog/assets/js/100.35b5db36.js"><link rel="prefetch" href="/blog/assets/js/101.a70b97e2.js"><link rel="prefetch" href="/blog/assets/js/102.30af4d63.js"><link rel="prefetch" href="/blog/assets/js/103.a362f49e.js"><link rel="prefetch" href="/blog/assets/js/104.a207d395.js"><link rel="prefetch" href="/blog/assets/js/105.eaae1ece.js"><link rel="prefetch" href="/blog/assets/js/106.9b961ba0.js"><link rel="prefetch" href="/blog/assets/js/107.df9ba599.js"><link rel="prefetch" href="/blog/assets/js/108.a5880443.js"><link rel="prefetch" href="/blog/assets/js/109.538edbe1.js"><link rel="prefetch" href="/blog/assets/js/11.ef37454d.js"><link rel="prefetch" href="/blog/assets/js/110.91c6d5de.js"><link rel="prefetch" href="/blog/assets/js/111.2211f82c.js"><link rel="prefetch" href="/blog/assets/js/112.6b9220f5.js"><link rel="prefetch" href="/blog/assets/js/113.9b314292.js"><link rel="prefetch" href="/blog/assets/js/114.b05dc902.js"><link rel="prefetch" href="/blog/assets/js/115.6a21a21a.js"><link rel="prefetch" href="/blog/assets/js/117.c6601199.js"><link rel="prefetch" href="/blog/assets/js/118.a54057c2.js"><link rel="prefetch" href="/blog/assets/js/119.f0742def.js"><link rel="prefetch" href="/blog/assets/js/12.2003a6c5.js"><link rel="prefetch" href="/blog/assets/js/120.a3d456af.js"><link rel="prefetch" href="/blog/assets/js/121.afee83c8.js"><link rel="prefetch" href="/blog/assets/js/122.ffc358e4.js"><link rel="prefetch" href="/blog/assets/js/123.b7cb0f42.js"><link rel="prefetch" href="/blog/assets/js/124.ca59f8f6.js"><link rel="prefetch" href="/blog/assets/js/125.7be39e4f.js"><link rel="prefetch" href="/blog/assets/js/126.8b8a9b2d.js"><link rel="prefetch" href="/blog/assets/js/127.3d53f72f.js"><link rel="prefetch" href="/blog/assets/js/128.ebd5e805.js"><link rel="prefetch" href="/blog/assets/js/129.c960281b.js"><link rel="prefetch" href="/blog/assets/js/13.4a08f423.js"><link rel="prefetch" href="/blog/assets/js/130.9ee2fb72.js"><link rel="prefetch" href="/blog/assets/js/131.1155be64.js"><link rel="prefetch" href="/blog/assets/js/132.866a7ce5.js"><link rel="prefetch" href="/blog/assets/js/133.ea694d5c.js"><link rel="prefetch" href="/blog/assets/js/134.d585508a.js"><link rel="prefetch" href="/blog/assets/js/135.1132a9d3.js"><link rel="prefetch" href="/blog/assets/js/136.fe9832ed.js"><link rel="prefetch" href="/blog/assets/js/137.574e5c35.js"><link rel="prefetch" href="/blog/assets/js/138.87124965.js"><link rel="prefetch" href="/blog/assets/js/139.e394567e.js"><link rel="prefetch" href="/blog/assets/js/14.0ee281ea.js"><link rel="prefetch" href="/blog/assets/js/140.c2741475.js"><link rel="prefetch" href="/blog/assets/js/141.cd76190b.js"><link rel="prefetch" href="/blog/assets/js/142.bc1d599e.js"><link rel="prefetch" href="/blog/assets/js/143.e16816e7.js"><link rel="prefetch" href="/blog/assets/js/144.c91db5db.js"><link rel="prefetch" href="/blog/assets/js/145.95b58ec4.js"><link rel="prefetch" href="/blog/assets/js/146.c5ff12f5.js"><link rel="prefetch" href="/blog/assets/js/147.ef38cae8.js"><link rel="prefetch" href="/blog/assets/js/148.b0a6ba25.js"><link rel="prefetch" href="/blog/assets/js/149.f0a6fc97.js"><link rel="prefetch" href="/blog/assets/js/15.de9db6ca.js"><link rel="prefetch" href="/blog/assets/js/150.6514db42.js"><link rel="prefetch" href="/blog/assets/js/151.dcf981a0.js"><link rel="prefetch" href="/blog/assets/js/152.6a733b47.js"><link rel="prefetch" href="/blog/assets/js/153.1a5b425b.js"><link rel="prefetch" href="/blog/assets/js/154.59a5cdd0.js"><link rel="prefetch" href="/blog/assets/js/155.1ecb4821.js"><link rel="prefetch" href="/blog/assets/js/156.e514afd4.js"><link rel="prefetch" href="/blog/assets/js/157.c01cdccb.js"><link rel="prefetch" href="/blog/assets/js/158.71dda3a8.js"><link rel="prefetch" href="/blog/assets/js/159.33fa138a.js"><link rel="prefetch" href="/blog/assets/js/16.03e830ed.js"><link rel="prefetch" href="/blog/assets/js/160.41012461.js"><link rel="prefetch" href="/blog/assets/js/161.93be8033.js"><link rel="prefetch" href="/blog/assets/js/162.d1adee89.js"><link rel="prefetch" href="/blog/assets/js/163.35e7409e.js"><link rel="prefetch" href="/blog/assets/js/164.b5140f57.js"><link rel="prefetch" href="/blog/assets/js/165.f7cbff8f.js"><link rel="prefetch" href="/blog/assets/js/166.e5008cd5.js"><link rel="prefetch" href="/blog/assets/js/167.56eb9dbd.js"><link rel="prefetch" href="/blog/assets/js/168.27dc81ce.js"><link rel="prefetch" href="/blog/assets/js/169.2b833606.js"><link rel="prefetch" href="/blog/assets/js/17.997071ba.js"><link rel="prefetch" href="/blog/assets/js/170.4469c187.js"><link rel="prefetch" href="/blog/assets/js/171.ff778380.js"><link rel="prefetch" href="/blog/assets/js/172.ed65c8c1.js"><link rel="prefetch" href="/blog/assets/js/173.41d6e737.js"><link rel="prefetch" href="/blog/assets/js/174.bccb9fa6.js"><link rel="prefetch" href="/blog/assets/js/175.deb32fb8.js"><link rel="prefetch" href="/blog/assets/js/176.2380b0cf.js"><link rel="prefetch" href="/blog/assets/js/177.67fa30a9.js"><link rel="prefetch" href="/blog/assets/js/178.7f4bf5e6.js"><link rel="prefetch" href="/blog/assets/js/18.c000b794.js"><link rel="prefetch" href="/blog/assets/js/19.d0523809.js"><link rel="prefetch" href="/blog/assets/js/2.43a980f2.js"><link rel="prefetch" href="/blog/assets/js/20.e9165d7c.js"><link rel="prefetch" href="/blog/assets/js/21.e0c3e1c3.js"><link rel="prefetch" href="/blog/assets/js/22.87f8326f.js"><link rel="prefetch" href="/blog/assets/js/23.6f53a063.js"><link rel="prefetch" href="/blog/assets/js/24.1249f968.js"><link rel="prefetch" href="/blog/assets/js/25.a976dac8.js"><link rel="prefetch" href="/blog/assets/js/26.54c900ef.js"><link rel="prefetch" href="/blog/assets/js/27.7621a087.js"><link rel="prefetch" href="/blog/assets/js/28.ec739e1d.js"><link rel="prefetch" href="/blog/assets/js/29.76ea8050.js"><link rel="prefetch" href="/blog/assets/js/30.6417632a.js"><link rel="prefetch" href="/blog/assets/js/31.3f4523df.js"><link rel="prefetch" href="/blog/assets/js/32.666cd74a.js"><link rel="prefetch" href="/blog/assets/js/33.a689a6fc.js"><link rel="prefetch" href="/blog/assets/js/34.6cc2c586.js"><link rel="prefetch" href="/blog/assets/js/35.86d13f87.js"><link rel="prefetch" href="/blog/assets/js/36.20e014f1.js"><link rel="prefetch" href="/blog/assets/js/37.8b69cd99.js"><link rel="prefetch" href="/blog/assets/js/38.f1cc6c40.js"><link rel="prefetch" href="/blog/assets/js/39.5664b0d3.js"><link rel="prefetch" href="/blog/assets/js/4.60804666.js"><link rel="prefetch" href="/blog/assets/js/40.2943fb88.js"><link rel="prefetch" href="/blog/assets/js/41.6201f829.js"><link rel="prefetch" href="/blog/assets/js/42.2e1b7a5b.js"><link rel="prefetch" href="/blog/assets/js/43.9c1b7439.js"><link rel="prefetch" href="/blog/assets/js/44.68f63f99.js"><link rel="prefetch" href="/blog/assets/js/45.328fda2a.js"><link rel="prefetch" href="/blog/assets/js/46.0bd04509.js"><link rel="prefetch" href="/blog/assets/js/47.b8cfe094.js"><link rel="prefetch" href="/blog/assets/js/48.59825d73.js"><link rel="prefetch" href="/blog/assets/js/49.cffe09bd.js"><link rel="prefetch" href="/blog/assets/js/5.548a74f6.js"><link rel="prefetch" href="/blog/assets/js/50.97f9d2b0.js"><link rel="prefetch" href="/blog/assets/js/51.564cf3e9.js"><link rel="prefetch" href="/blog/assets/js/52.d2042f8d.js"><link rel="prefetch" href="/blog/assets/js/53.a70a48c8.js"><link rel="prefetch" href="/blog/assets/js/54.9a93718c.js"><link rel="prefetch" href="/blog/assets/js/55.bd9a7852.js"><link rel="prefetch" href="/blog/assets/js/56.c2bf89f1.js"><link rel="prefetch" href="/blog/assets/js/57.a8ad91e4.js"><link rel="prefetch" href="/blog/assets/js/58.51d02d31.js"><link rel="prefetch" href="/blog/assets/js/59.bd516f75.js"><link rel="prefetch" href="/blog/assets/js/6.2a5a1504.js"><link rel="prefetch" href="/blog/assets/js/60.b70f4aa5.js"><link rel="prefetch" href="/blog/assets/js/61.0ce9673a.js"><link rel="prefetch" href="/blog/assets/js/62.24bf6999.js"><link rel="prefetch" href="/blog/assets/js/63.6b1d0cdc.js"><link rel="prefetch" href="/blog/assets/js/64.0a87210f.js"><link rel="prefetch" href="/blog/assets/js/65.255d0e52.js"><link rel="prefetch" href="/blog/assets/js/66.34889547.js"><link rel="prefetch" href="/blog/assets/js/67.d5b053a1.js"><link rel="prefetch" href="/blog/assets/js/68.24775a0c.js"><link rel="prefetch" href="/blog/assets/js/69.6b6ae34e.js"><link rel="prefetch" href="/blog/assets/js/7.e088d63d.js"><link rel="prefetch" href="/blog/assets/js/70.49ff7561.js"><link rel="prefetch" href="/blog/assets/js/71.97a4d551.js"><link rel="prefetch" href="/blog/assets/js/72.49706859.js"><link rel="prefetch" href="/blog/assets/js/73.d2f96422.js"><link rel="prefetch" href="/blog/assets/js/74.3c8755ec.js"><link rel="prefetch" href="/blog/assets/js/75.5800081d.js"><link rel="prefetch" href="/blog/assets/js/76.a63525d6.js"><link rel="prefetch" href="/blog/assets/js/77.da3a7d1d.js"><link rel="prefetch" href="/blog/assets/js/78.d8480922.js"><link rel="prefetch" href="/blog/assets/js/79.64a09aa3.js"><link rel="prefetch" href="/blog/assets/js/8.f3bc1f32.js"><link rel="prefetch" href="/blog/assets/js/80.932971cd.js"><link rel="prefetch" href="/blog/assets/js/81.04f50a1e.js"><link rel="prefetch" href="/blog/assets/js/82.db879ca5.js"><link rel="prefetch" href="/blog/assets/js/83.e89b8863.js"><link rel="prefetch" href="/blog/assets/js/84.07410b58.js"><link rel="prefetch" href="/blog/assets/js/85.d46c8682.js"><link rel="prefetch" href="/blog/assets/js/86.3869d59e.js"><link rel="prefetch" href="/blog/assets/js/87.e7860b15.js"><link rel="prefetch" href="/blog/assets/js/88.09fc332a.js"><link rel="prefetch" href="/blog/assets/js/89.8b302469.js"><link rel="prefetch" href="/blog/assets/js/9.da864c6e.js"><link rel="prefetch" href="/blog/assets/js/90.fab1b0e1.js"><link rel="prefetch" href="/blog/assets/js/91.d1662d38.js"><link rel="prefetch" href="/blog/assets/js/92.4093acc4.js"><link rel="prefetch" href="/blog/assets/js/93.d4c601c1.js"><link rel="prefetch" href="/blog/assets/js/94.1e2891fe.js"><link rel="prefetch" href="/blog/assets/js/95.758d874c.js"><link rel="prefetch" href="/blog/assets/js/96.85084d66.js"><link rel="prefetch" href="/blog/assets/js/97.16a7a60a.js"><link rel="prefetch" href="/blog/assets/js/98.a84fee2e.js"><link rel="prefetch" href="/blog/assets/js/99.f9452cba.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.e16ad0a6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">一名GO+PHP工程师</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://gitee.com/ColinWWL/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://gitee.com/ColinWWL/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/Go类型系统/1Go类型系统概述" class="sidebar-heading clickable"><span>Go类型系统</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/Go类型系统/1Go类型系统概述.html" class="sidebar-link">Go类型系统概述</a></li><li><a href="/blog/开发基础/GO/Go类型系统/2指针.html" class="sidebar-link">指针</a></li><li><a href="/blog/开发基础/GO/Go类型系统/3结构体.html" class="sidebar-link">结构体</a></li><li><a href="/blog/开发基础/GO/Go类型系统/4值部.html" class="sidebar-link">值部</a></li><li><a href="/blog/开发基础/GO/Go类型系统/5数组、切片和映射.html" class="sidebar-link">数组、切片和映射</a></li><li><a href="/blog/开发基础/GO/Go类型系统/6通道.html" class="sidebar-link">通道</a></li><li><a href="/blog/开发基础/GO/Go类型系统/7方法.html" class="sidebar-link">方法</a></li><li><a href="/blog/开发基础/GO/Go类型系统/8接口.html" class="sidebar-link">接口</a></li><li><a href="/blog/开发基础/GO/Go类型系统/9类型内嵌.html" class="sidebar-link">类型内嵌</a></li><li><a href="/blog/开发基础/GO/Go类型系统/10非类型安全指针.html" class="sidebar-link">非类型安全指针</a></li><li><a href="/blog/开发基础/GO/Go类型系统/11泛型.html" class="sidebar-link">泛型</a></li><li><a href="/blog/开发基础/GO/Go类型系统/12反射.html" class="sidebar-link">反射</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/Go编程入门/1程序源代码基本元素介绍" class="sidebar-heading clickable"><span>Go编程入门</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/Go编程入门/1程序源代码基本元素介绍.html" class="sidebar-link">程序源代码基本元素介绍</a></li><li><a href="/blog/开发基础/GO/Go编程入门/2关键字和标识符.html" class="sidebar-link">关键字和标识符</a></li><li><a href="/blog/开发基础/GO/Go编程入门/3基本类型和它们的字面量表示.html" class="sidebar-link">基本类型和它们的字面量表示</a></li><li><a href="/blog/开发基础/GO/Go编程入门/4常量和变量.html" class="sidebar-link">常量和变量</a></li><li><a href="/blog/开发基础/GO/Go编程入门/5运算操作符.html" class="sidebar-link">运算操作符</a></li><li><a href="/blog/开发基础/GO/Go编程入门/6函数声明和调用.html" class="sidebar-link">函数声明和调用</a></li><li><a href="/blog/开发基础/GO/Go编程入门/7代码包和包引入.html" class="sidebar-link">代码包和包引入</a></li><li><a href="/blog/开发基础/GO/Go编程入门/8表达式、语句和简单语句.html" class="sidebar-link">表达式、语句和简单语句</a></li><li><a href="/blog/开发基础/GO/Go编程入门/9基本流程控制语法.html" class="sidebar-link">基本流程控制语法</a></li><li><a href="/blog/开发基础/GO/Go编程入门/10协程、延迟函数调用、以及恐慌和恢复.html" class="sidebar-link">协程、延迟函数调用、以及恐慌和恢复</a></li><li><a href="/blog/开发基础/GO/Go编程入门/GO官方链接工具.html" class="sidebar-link">GO官方链接工具</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/其他文章/Go技巧" class="sidebar-heading clickable"><span>其他文章</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/其他文章/Go技巧.html" class="sidebar-link">Go技巧</a></li><li><a href="/blog/开发基础/GO/其他文章/Go细节.html" class="sidebar-link">Go细节</a></li><li><a href="/blog/开发基础/GO/其他文章/Go问答.html" class="sidebar-link">Go问答</a></li><li><a href="/blog/开发基础/GO/其他文章/命令-mod.html" class="sidebar-link">命令-mod</a></li><li><a href="/blog/开发基础/GO/其他文章/基础-Golang的time.NewTimer单次定时器使用案例.html" class="sidebar-link">基础-Golang的time. NewTimer单次定时器使用案例</a></li><li><a href="/blog/开发基础/GO/其他文章/基础-Go中的nil.html" class="sidebar-link">Go中的 nil</a></li><li><a href="/blog/开发基础/GO/其他文章/基础-Go代码断行规则.html" class="sidebar-link">Go代码断行规则</a></li><li><a href="/blog/开发基础/GO/其他文章/基础-表达式估值顺序规则.html" class="sidebar-link">表达式估值顺序规则</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/学习资料" class="sidebar-heading clickable"><span>GO</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/学习资料.html" class="sidebar-link">教学书籍</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/并发编程/1并发同步概述" class="sidebar-heading clickable open"><span>并发编程</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/并发编程/1并发同步概述.html" class="sidebar-link">并发同步概述</a></li><li><a href="/blog/开发基础/GO/并发编程/2通道用例大全.html" class="sidebar-link">通道用例大全</a></li><li><a href="/blog/开发基础/GO/并发编程/3如何优雅地关闭通道.html" class="sidebar-link">如何优雅地关闭通道</a></li><li><a href="/blog/开发基础/GO/并发编程/4其它并发同步技术.html" class="sidebar-link">sync 标准库包中提供的并发同步技术</a></li><li><a href="/blog/开发基础/GO/并发编程/5原子操作 .html" class="active sidebar-link">sync/atomic 标准库包中提供的原子操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/并发编程/5原子操作 .html#go支持的原子操作概述" class="sidebar-link">Go支持的原子操作概述</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/并发编程/5原子操作 .html#整数原子操作" class="sidebar-link">整数原子操作</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/并发编程/5原子操作 .html#指针值的原子操作" class="sidebar-link">指针值的原子操作</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/并发编程/5原子操作 .html#任何类型值的原子操作" class="sidebar-link">任何类型值的原子操作</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/并发编程/5原子操作 .html#原子操作相关的内存顺序保证" class="sidebar-link">原子操作相关的内存顺序保证</a></li></ul></li><li><a href="/blog/开发基础/GO/并发编程/6Go中的内存顺序保证.html" class="sidebar-link">Go中的内存顺序保证</a></li><li><a href="/blog/开发基础/GO/并发编程/7一些常见并发编程错误.html" class="sidebar-link">一些常见并发编程错误</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/开发环境搭建/Docker和VS Code的Go开发环境" class="sidebar-heading clickable"><span>开发环境搭建</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/开发环境搭建/Docker和VS Code的Go开发环境.html" class="sidebar-link">Docker和VS Code的Go开发环境</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="sync-atomic-标准库包中提供的原子操作"><a href="#sync-atomic-标准库包中提供的原子操作" class="header-anchor">#</a> <code>sync/atomic</code> 标准库包中提供的原子操作</h1> <p>原子操作是比其它同步技术更基础的操作。原子操作是无锁的，常常直接通过CPU指令直接实现。 事实上，其它同步技术的实现常常依赖于原子操作。</p> <p>注意，本文中的很多例子并非并发程序。它们只是用来演示如何使用 <code>sync/atomic</code> 标准库包中提供的原子操作。</p> <h2 id="go支持的原子操作概述"><a href="#go支持的原子操作概述" class="header-anchor">#</a> Go支持的原子操作概述</h2> <p>对于一个整数类型 <code>T</code> ， <code>sync/atomic</code> 标准库包提供了下列原子操作函数。 其中 <code>T</code> 可以是内置 <code>int32</code> 、 <code>int64</code> 、 <code>uint32</code> 、 <code>uint64</code> 和 <code>uintptr</code> 类型。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">AddT</span><span class="token punctuation">(</span>addr <span class="token operator">*</span>T<span class="token punctuation">,</span> delta T<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token builtin">new</span> T<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">LoadT</span><span class="token punctuation">(</span>addr <span class="token operator">*</span>T<span class="token punctuation">)</span> <span class="token punctuation">(</span>val T<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">StoreT</span><span class="token punctuation">(</span>addr <span class="token operator">*</span>T<span class="token punctuation">,</span> val T<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">SwapT</span><span class="token punctuation">(</span>addr <span class="token operator">*</span>T<span class="token punctuation">,</span> <span class="token builtin">new</span> T<span class="token punctuation">)</span> <span class="token punctuation">(</span>old T<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">CompareAndSwapT</span><span class="token punctuation">(</span>addr <span class="token operator">*</span>T<span class="token punctuation">,</span> old<span class="token punctuation">,</span> <span class="token builtin">new</span> T<span class="token punctuation">)</span> <span class="token punctuation">(</span>swapped <span class="token builtin">bool</span><span class="token punctuation">)</span>
</code></pre></div><p>比如，下列五个原子操作函数提供给了内置 <code>int32</code> 类型。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">AddInt32</span><span class="token punctuation">(</span>addr <span class="token operator">*</span><span class="token builtin">int32</span><span class="token punctuation">,</span> delta <span class="token builtin">int32</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token builtin">new</span> <span class="token builtin">int32</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">LoadInt32</span><span class="token punctuation">(</span>addr <span class="token operator">*</span><span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>val <span class="token builtin">int32</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">StoreInt32</span><span class="token punctuation">(</span>addr <span class="token operator">*</span><span class="token builtin">int32</span><span class="token punctuation">,</span> val <span class="token builtin">int32</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">SwapInt32</span><span class="token punctuation">(</span>addr <span class="token operator">*</span><span class="token builtin">int32</span><span class="token punctuation">,</span> <span class="token builtin">new</span> <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>old <span class="token builtin">int32</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">CompareAndSwapInt32</span><span class="token punctuation">(</span>addr <span class="token operator">*</span><span class="token builtin">int32</span><span class="token punctuation">,</span> old<span class="token punctuation">,</span> <span class="token builtin">new</span> <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>swapped <span class="token builtin">bool</span><span class="token punctuation">)</span>
</code></pre></div><p>下列四个原子操作函数提供给了（安全）指针类型。因为Go目前（1.16）并不支持自定义泛型，所以这些函数是通过<a href="https://gfw.go101.org/article/unsafe.html" target="_blank" rel="noopener noreferrer">非类型安全指针<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <code>unsafe. Pointer</code> 来实现的。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">LoadPointer</span><span class="token punctuation">(</span>addr <span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">(</span>val unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">StorePointer</span><span class="token punctuation">(</span>addr <span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> val unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">SwapPointer</span><span class="token punctuation">(</span>addr <span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> <span class="token builtin">new</span> unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">(</span>old unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">CompareAndSwapPointer</span><span class="token punctuation">(</span>addr <span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span>
				old<span class="token punctuation">,</span> <span class="token builtin">new</span> unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">(</span>swapped <span class="token builtin">bool</span><span class="token punctuation">)</span>
</code></pre></div><p>因为Go指针不支持算术运算，所以相对于整数类型，指针类型的原子操作少了一个 <code>AddPointer</code> 函数。</p> <p><code>sync/atomic</code> 标准库包也提供了一个 <code>Value</code> 类型。以它为基的指针类型 <code>*Value</code> 拥有两个方法： <code>Load</code> 和 <code>Store</code> 。 <code>Value</code> 值用来原子读取和修改任何类型的Go值。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>Value<span class="token punctuation">)</span> <span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>x <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>Value<span class="token punctuation">)</span> <span class="token function">Store</span><span class="token punctuation">(</span>x <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>本文的余下部分将通过一些示例来展示如何使用这些原子操作函数。</p> <h2 id="整数原子操作"><a href="#整数原子操作" class="header-anchor">#</a> 整数原子操作</h2> <p>下面这个例子展示了如何使用 <code>add</code> 原子操作来并发地递增一个 <code>int32</code> 值。 在此例子中，主协程中创建了1000个新协程。每个新协程将整数 <code>n</code> 的值增加 <code>1</code> 。 原子操作保证这1000个新协程之间不会发生数据竞争。此程序肯定打印出 <code>1000</code> 。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
	<span class="token string">&quot;sync/atomic&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> n <span class="token builtin">int32</span>
	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>n<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
			wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">LoadInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1000</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果我们将新协程中的语句 <code>atomic. AddInt32(&amp;n, 1)</code> 替换为 <code>n++</code> ，则最后的输出结果很可能不是 <code>1000</code> 。</p> <p><code>StoreT</code> 和 <code>LoadT</code> 原子操作函数经常被用来需要并发运行的实现setter和getter方法。下面是一个这样的例子：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Page <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	views <span class="token builtin">uint32</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>page <span class="token operator">*</span>Page<span class="token punctuation">)</span> <span class="token function">SetViews</span><span class="token punctuation">(</span>n <span class="token builtin">uint32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	atomic<span class="token punctuation">.</span><span class="token function">StoreUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>page<span class="token punctuation">.</span>views<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>page <span class="token operator">*</span>Page<span class="token punctuation">)</span> <span class="token function">Views</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">uint32</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>page<span class="token punctuation">.</span>views<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果 <code>T</code> 是一个有符号整数类型，比如 <code>int32</code> 或 <code>int64</code> ，则 <code>AddT</code> 函数调用的第二个实参可以是一个负数，用来实现原子减法操作。 但是如果 <code>T</code> 是一个无符号整数类型，比如 <code>uint32</code> 、 <code>uint64</code> 或者 <code>uintptr</code> ，则 <code>AddT</code> 函数调用的第二个实参需要为一个非负数，那么如何实现无符号整数类型 <code>T</code> 值的原子减法操作呢？ 毕竟 <code>sync/atomic</code> 标准库包没有提供 <code>SubstractT</code> 函数。 根据欲传递的第二个实参的特点，我们可以把 <code>T</code> 为一个无符号整数类型的情况细分为两类：</p> <ol><li>第二个实参为类型为<code>T</code>的一个变量值<code>v</code>。 因为<code>-v</code>在Go中是合法的，所以<code>-v</code>可以直接被用做<code>AddT</code>调用的第二个实参。</li> <li>第二个实参为一个正整数常量<code>c</code>，这时<code>-c</code>在Go中是编译不通过的，所以它不能被用做<code>AddT</code>调用的第二个实参。 这时我们可以使用<code>^T(c-1)</code>（仍为一个正数）做为<code>AddT</code>调用的第二个实参。</li></ol> <p>此 <code>^T(v-1)</code> 小技巧对于无符号类型的变量 <code>v</code> 也是适用的，但是 <code>^T(v-1)</code> 比 <code>T(-v)</code> 的效率要低。</p> <p>对于这个 <code>^T(c-1)</code> 小技巧，如果 <code>c</code> 是一个类型确定值并且它的类型确实就是 <code>T</code> ，则它的表示形式可以简化为 <code>^(c-1)</code> 。</p> <p>一个例子：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;sync/atomic&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		n <span class="token builtin">uint64</span> <span class="token operator">=</span> <span class="token number">97</span>
		m <span class="token builtin">uint64</span> <span class="token operator">=</span> <span class="token number">1</span>
		k <span class="token builtin">int</span>    <span class="token operator">=</span> <span class="token number">2</span>
	<span class="token punctuation">)</span>
	<span class="token keyword">const</span> <span class="token punctuation">(</span>
		a        <span class="token operator">=</span> <span class="token number">3</span>
		b <span class="token builtin">uint64</span> <span class="token operator">=</span> <span class="token number">4</span>
		c <span class="token builtin">uint32</span> <span class="token operator">=</span> <span class="token number">5</span>
		d <span class="token builtin">int</span>    <span class="token operator">=</span> <span class="token number">6</span>
	<span class="token punctuation">)</span>

	show <span class="token operator">:=</span> fmt<span class="token punctuation">.</span>Println
	atomic<span class="token punctuation">.</span><span class="token function">AddUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>n<span class="token punctuation">,</span> <span class="token operator">-</span>m<span class="token punctuation">)</span>
	<span class="token function">show</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token comment">// 96 (97 - 1)</span>
	atomic<span class="token punctuation">.</span><span class="token function">AddUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>n<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">uint64</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">show</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token comment">// 94 (95 - 2)</span>
	atomic<span class="token punctuation">.</span><span class="token function">AddUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>n<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token function">uint64</span><span class="token punctuation">(</span>a <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">show</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token comment">// 91 (94 - 3)</span>
	atomic<span class="token punctuation">.</span><span class="token function">AddUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>n<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">(</span>b <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">show</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token comment">// 87 (91 - 4)</span>
	atomic<span class="token punctuation">.</span><span class="token function">AddUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>n<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token function">uint64</span><span class="token punctuation">(</span>c <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">show</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token comment">// 82 (87 - 5)</span>
	atomic<span class="token punctuation">.</span><span class="token function">AddUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>n<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token function">uint64</span><span class="token punctuation">(</span>d <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">show</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token comment">// 76 (82 - 6)</span>
	x <span class="token operator">:=</span> b<span class="token punctuation">;</span> atomic<span class="token punctuation">.</span><span class="token function">AddUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>n<span class="token punctuation">,</span> <span class="token operator">-</span>x<span class="token punctuation">)</span>
	<span class="token function">show</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token comment">// 72 (76 - 4)</span>
	atomic<span class="token punctuation">.</span><span class="token function">AddUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>n<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">(</span>m <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">show</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token comment">// 71 (72 - 1)</span>
	atomic<span class="token punctuation">.</span><span class="token function">AddUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>n<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token function">uint64</span><span class="token punctuation">(</span>k <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">show</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token comment">// 69 (71 - 2)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>SwapT</code> 函数调用和 <code>StoreT</code> 函数调用类似，但是返回修改之前的旧值（因此称为置换操作）。</p> <p>一个 <code>CompareAndSwapT</code> 函数调用仅在新值和旧值不相等的情况下才会执行修改操作，并返回 <code>true</code> ；否则立即返回 <code>false</code> 。</p> <p>一个例子：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;sync/atomic&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> n <span class="token builtin">int64</span> <span class="token operator">=</span> <span class="token number">123</span>
	<span class="token keyword">var</span> old <span class="token operator">=</span> atomic<span class="token punctuation">.</span><span class="token function">SwapInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>n<span class="token punctuation">,</span> <span class="token number">789</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> old<span class="token punctuation">)</span> <span class="token comment">// 789 123</span>
	swapped <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">CompareAndSwapInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>n<span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token number">456</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>swapped<span class="token punctuation">)</span> <span class="token comment">// false</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>       <span class="token comment">// 789</span>
	swapped <span class="token operator">=</span> atomic<span class="token punctuation">.</span><span class="token function">CompareAndSwapInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>n<span class="token punctuation">,</span> <span class="token number">789</span><span class="token punctuation">,</span> <span class="token number">456</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>swapped<span class="token punctuation">)</span> <span class="token comment">// true</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>       <span class="token comment">// 456</span>
<span class="token punctuation">}</span>
</code></pre></div><p>请注意，到目前为止（Go 1.16），一个64位字（int64或uint64值）的原子操作要求此64位字的内存地址必须是8字节对齐的。 请阅读<a href="https://gfw.go101.org/article/memory-layout.html" target="_blank" rel="noopener noreferrer">关于Go值的内存布局<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>一文获取详情。</p> <h2 id="指针值的原子操作"><a href="#指针值的原子操作" class="header-anchor">#</a> 指针值的原子操作</h2> <p>上面已经提到了 <code>sync/atomic</code> 标准库包为指针值的原子操作提供了四个函数，并且指针值的原子操作是通过非类型安全指针来实现的。</p> <p>从<a href="https://gfw.go101.org/article/unsafe.html" target="_blank" rel="noopener noreferrer">非类型安全指针<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>一文，我们得知，在Go中， 任何指针类型的值可以被显式转换为非类型安全指针类型 <code>unsafe. Pointer</code> ，反之亦然。 所以指针类型 <code>*unsafe. Pointer</code> 的值也可以被显式转换为类型 <code>unsafe. Pointer</code> ，反之亦然。</p> <p>下面这个程序不是一个并发程序。它仅仅展示了如何使用指针原子操作。在这个例子中，类型 <code>T</code> 可以为任何类型。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;sync/atomic&quot;</span>
	<span class="token string">&quot;unsafe&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> T <span class="token keyword">struct</span> <span class="token punctuation">{</span>x <span class="token builtin">int</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> pT <span class="token operator">*</span>T

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> unsafePPT <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pT<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> ta<span class="token punctuation">,</span> tb <span class="token operator">=</span> T<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> T<span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">}</span>
	<span class="token comment">// 修改</span>
	atomic<span class="token punctuation">.</span><span class="token function">StorePointer</span><span class="token punctuation">(</span>
		unsafePPT<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ta<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>pT<span class="token punctuation">)</span> <span class="token comment">// &amp;{1}</span>
	<span class="token comment">// 读取</span>
	pa1 <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>T<span class="token punctuation">)</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">LoadPointer</span><span class="token punctuation">(</span>unsafePPT<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>pa1 <span class="token operator">==</span> <span class="token operator">&amp;</span>ta<span class="token punctuation">)</span> <span class="token comment">// true</span>
	<span class="token comment">// 置换</span>
	pa2 <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">SwapPointer</span><span class="token punctuation">(</span>
		unsafePPT<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>T<span class="token punctuation">)</span><span class="token punctuation">(</span>pa2<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">&amp;</span>ta<span class="token punctuation">)</span> <span class="token comment">// true</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>pT<span class="token punctuation">)</span> <span class="token comment">// &amp;{2}</span>
	<span class="token comment">// 比较置换</span>
	b <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">CompareAndSwapPointer</span><span class="token punctuation">(</span>
		unsafePPT<span class="token punctuation">,</span> pa2<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token comment">// false</span>
	b <span class="token operator">=</span> atomic<span class="token punctuation">.</span><span class="token function">CompareAndSwapPointer</span><span class="token punctuation">(</span>
		unsafePPT<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tb<span class="token punctuation">)</span><span class="token punctuation">,</span> pa2<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token comment">// true</span>
<span class="token punctuation">}</span>
</code></pre></div><p>是的，目前指针的原子操作使用起来是相当的啰嗦。 事实上，啰嗦还是次要的，更主要的是，因为指针的原子操作需要引入 <code>unsafe</code> 标准库包，所以这些操作函数不在<a href="https://golang.google.cn/doc/go1compat" target="_blank" rel="noopener noreferrer">Go 1兼容性保证<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>之列。</p> <p>我个人认为目前支持的这些指针原子操作在今后变为不合法的可能性很小。 即使它们变得不再合法，Go官方工具链中的 <code>go fix</code> 命令应该会将它们转换为今后的新的合法形式。 但是，这只是我的个人观点，它没有任何权威性。</p> <p>如果你确实担忧这些指针原子操作在未来的合法性，你可以使用下一节将要介绍的原子操作。 但是下一节将要介绍的原子操作对于指针值来说比本节介绍的指针原子操作效率要低得多。</p> <h2 id="任何类型值的原子操作"><a href="#任何类型值的原子操作" class="header-anchor">#</a> 任何类型值的原子操作</h2> <p><code>sync/atomic</code> 标准库包中提供的 <code>Value</code> 类型可以用来读取和修改任何类型的值。</p> <p>类型 <code>*Value</code> 有两个方法： <code>Load</code> 和 <code>Store</code> 。 它没有 <code>Add</code> 和 <code>Swap</code> 方法。</p> <p><code>Load</code> 方法的结果类型和 <code>Store</code> 方法的参数类型均为 <code>interface{}</code> 。 所以 <code>Store</code> 方法调用的实参可以是任何类型的值。 但是对于一个可寻址的 <code>Value</code> 类型的值 <code>v</code> ，一旦 <code>v. Store</code> 方法（ <code>(&amp;v). Store</code> 的简写形式）被曾经调用一次，则传递给此方法的后续调用的实参的具体类型必须和传递给它的第一次调用的实参的具体类型一致； 否则，将产生一个恐慌。 <code>nil</code> 接口类型实参也将导致 <code>v. Store()</code> 方法调用产生恐慌。</p> <p>一个例子：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;sync/atomic&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">type</span> T <span class="token keyword">struct</span> <span class="token punctuation">{</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token builtin">int</span><span class="token punctuation">}</span>
	<span class="token keyword">var</span> ta <span class="token operator">=</span> T<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span>
	<span class="token keyword">var</span> v atomic<span class="token punctuation">.</span>Value
	v<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>ta<span class="token punctuation">)</span>
	<span class="token keyword">var</span> tb <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>tb<span class="token punctuation">)</span>       <span class="token comment">// {1 2 3}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ta <span class="token operator">==</span> tb<span class="token punctuation">)</span> <span class="token comment">// true</span>

	v<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 将导致一个恐慌</span>
<span class="token punctuation">}</span>
</code></pre></div><p>事实上，我们也可以使用上一节介绍的指针原子操作来对任何类型的值进行原子读取和修改，不过需要多一级指针的间接引用。 两种方法有各自的好处和缺点。在实践中需要根据具体需要选择合适的方法。</p> <h2 id="原子操作相关的内存顺序保证"><a href="#原子操作相关的内存顺序保证" class="header-anchor">#</a> 原子操作相关的内存顺序保证</h2> <p>为了便于理解和使用简单，Go值的原子操作被设计的和内存顺序保证无关。 没有任何官方文档规定了原子操作应该保证的内存顺序。 详见<a href="https://gfw.go101.org/article/memory-model.html#atomic" target="_blank" rel="noopener noreferrer">Go中的内存顺序保证<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>一文对此情况的说明。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/21/2021, 1:25:38 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/开发基础/GO/并发编程/4其它并发同步技术.html" class="prev">
        sync 标准库包中提供的并发同步技术
      </a></span> <span class="next"><a href="/blog/开发基础/GO/并发编程/6Go中的内存顺序保证.html">
        Go中的内存顺序保证
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.b472f60d.js" defer></script><script src="/blog/assets/js/3.21e2e031.js" defer></script><script src="/blog/assets/js/116.f4969b27.js" defer></script>
  </body>
</html>
