<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>非类型安全指针 | 一名GO+PHP工程师</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/blog/assets/css/0.styles.e16ad0a6.css" as="style"><link rel="preload" href="/blog/assets/js/app.b472f60d.js" as="script"><link rel="preload" href="/blog/assets/js/3.21e2e031.js" as="script"><link rel="preload" href="/blog/assets/js/86.3869d59e.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.414eb148.js"><link rel="prefetch" href="/blog/assets/js/100.35b5db36.js"><link rel="prefetch" href="/blog/assets/js/101.a70b97e2.js"><link rel="prefetch" href="/blog/assets/js/102.30af4d63.js"><link rel="prefetch" href="/blog/assets/js/103.a362f49e.js"><link rel="prefetch" href="/blog/assets/js/104.a207d395.js"><link rel="prefetch" href="/blog/assets/js/105.eaae1ece.js"><link rel="prefetch" href="/blog/assets/js/106.9b961ba0.js"><link rel="prefetch" href="/blog/assets/js/107.df9ba599.js"><link rel="prefetch" href="/blog/assets/js/108.a5880443.js"><link rel="prefetch" href="/blog/assets/js/109.538edbe1.js"><link rel="prefetch" href="/blog/assets/js/11.ef37454d.js"><link rel="prefetch" href="/blog/assets/js/110.91c6d5de.js"><link rel="prefetch" href="/blog/assets/js/111.2211f82c.js"><link rel="prefetch" href="/blog/assets/js/112.6b9220f5.js"><link rel="prefetch" href="/blog/assets/js/113.9b314292.js"><link rel="prefetch" href="/blog/assets/js/114.b05dc902.js"><link rel="prefetch" href="/blog/assets/js/115.6a21a21a.js"><link rel="prefetch" href="/blog/assets/js/116.f4969b27.js"><link rel="prefetch" href="/blog/assets/js/117.c6601199.js"><link rel="prefetch" href="/blog/assets/js/118.a54057c2.js"><link rel="prefetch" href="/blog/assets/js/119.f0742def.js"><link rel="prefetch" href="/blog/assets/js/12.2003a6c5.js"><link rel="prefetch" href="/blog/assets/js/120.a3d456af.js"><link rel="prefetch" href="/blog/assets/js/121.afee83c8.js"><link rel="prefetch" href="/blog/assets/js/122.ffc358e4.js"><link rel="prefetch" href="/blog/assets/js/123.b7cb0f42.js"><link rel="prefetch" href="/blog/assets/js/124.ca59f8f6.js"><link rel="prefetch" href="/blog/assets/js/125.7be39e4f.js"><link rel="prefetch" href="/blog/assets/js/126.8b8a9b2d.js"><link rel="prefetch" href="/blog/assets/js/127.3d53f72f.js"><link rel="prefetch" href="/blog/assets/js/128.ebd5e805.js"><link rel="prefetch" href="/blog/assets/js/129.c960281b.js"><link rel="prefetch" href="/blog/assets/js/13.4a08f423.js"><link rel="prefetch" href="/blog/assets/js/130.9ee2fb72.js"><link rel="prefetch" href="/blog/assets/js/131.1155be64.js"><link rel="prefetch" href="/blog/assets/js/132.866a7ce5.js"><link rel="prefetch" href="/blog/assets/js/133.ea694d5c.js"><link rel="prefetch" href="/blog/assets/js/134.d585508a.js"><link rel="prefetch" href="/blog/assets/js/135.1132a9d3.js"><link rel="prefetch" href="/blog/assets/js/136.fe9832ed.js"><link rel="prefetch" href="/blog/assets/js/137.574e5c35.js"><link rel="prefetch" href="/blog/assets/js/138.87124965.js"><link rel="prefetch" href="/blog/assets/js/139.e394567e.js"><link rel="prefetch" href="/blog/assets/js/14.0ee281ea.js"><link rel="prefetch" href="/blog/assets/js/140.c2741475.js"><link rel="prefetch" href="/blog/assets/js/141.cd76190b.js"><link rel="prefetch" href="/blog/assets/js/142.bc1d599e.js"><link rel="prefetch" href="/blog/assets/js/143.e16816e7.js"><link rel="prefetch" href="/blog/assets/js/144.c91db5db.js"><link rel="prefetch" href="/blog/assets/js/145.95b58ec4.js"><link rel="prefetch" href="/blog/assets/js/146.c5ff12f5.js"><link rel="prefetch" href="/blog/assets/js/147.ef38cae8.js"><link rel="prefetch" href="/blog/assets/js/148.b0a6ba25.js"><link rel="prefetch" href="/blog/assets/js/149.f0a6fc97.js"><link rel="prefetch" href="/blog/assets/js/15.de9db6ca.js"><link rel="prefetch" href="/blog/assets/js/150.6514db42.js"><link rel="prefetch" href="/blog/assets/js/151.dcf981a0.js"><link rel="prefetch" href="/blog/assets/js/152.6a733b47.js"><link rel="prefetch" href="/blog/assets/js/153.1a5b425b.js"><link rel="prefetch" href="/blog/assets/js/154.59a5cdd0.js"><link rel="prefetch" href="/blog/assets/js/155.1ecb4821.js"><link rel="prefetch" href="/blog/assets/js/156.e514afd4.js"><link rel="prefetch" href="/blog/assets/js/157.c01cdccb.js"><link rel="prefetch" href="/blog/assets/js/158.71dda3a8.js"><link rel="prefetch" href="/blog/assets/js/159.33fa138a.js"><link rel="prefetch" href="/blog/assets/js/16.03e830ed.js"><link rel="prefetch" href="/blog/assets/js/160.41012461.js"><link rel="prefetch" href="/blog/assets/js/161.93be8033.js"><link rel="prefetch" href="/blog/assets/js/162.d1adee89.js"><link rel="prefetch" href="/blog/assets/js/163.35e7409e.js"><link rel="prefetch" href="/blog/assets/js/164.b5140f57.js"><link rel="prefetch" href="/blog/assets/js/165.f7cbff8f.js"><link rel="prefetch" href="/blog/assets/js/166.e5008cd5.js"><link rel="prefetch" href="/blog/assets/js/167.56eb9dbd.js"><link rel="prefetch" href="/blog/assets/js/168.27dc81ce.js"><link rel="prefetch" href="/blog/assets/js/169.2b833606.js"><link rel="prefetch" href="/blog/assets/js/17.997071ba.js"><link rel="prefetch" href="/blog/assets/js/170.4469c187.js"><link rel="prefetch" href="/blog/assets/js/171.ff778380.js"><link rel="prefetch" href="/blog/assets/js/172.ed65c8c1.js"><link rel="prefetch" href="/blog/assets/js/173.41d6e737.js"><link rel="prefetch" href="/blog/assets/js/174.bccb9fa6.js"><link rel="prefetch" href="/blog/assets/js/175.deb32fb8.js"><link rel="prefetch" href="/blog/assets/js/176.2380b0cf.js"><link rel="prefetch" href="/blog/assets/js/177.67fa30a9.js"><link rel="prefetch" href="/blog/assets/js/178.7f4bf5e6.js"><link rel="prefetch" href="/blog/assets/js/18.c000b794.js"><link rel="prefetch" href="/blog/assets/js/19.d0523809.js"><link rel="prefetch" href="/blog/assets/js/2.43a980f2.js"><link rel="prefetch" href="/blog/assets/js/20.e9165d7c.js"><link rel="prefetch" href="/blog/assets/js/21.e0c3e1c3.js"><link rel="prefetch" href="/blog/assets/js/22.87f8326f.js"><link rel="prefetch" href="/blog/assets/js/23.6f53a063.js"><link rel="prefetch" href="/blog/assets/js/24.1249f968.js"><link rel="prefetch" href="/blog/assets/js/25.a976dac8.js"><link rel="prefetch" href="/blog/assets/js/26.54c900ef.js"><link rel="prefetch" href="/blog/assets/js/27.7621a087.js"><link rel="prefetch" href="/blog/assets/js/28.ec739e1d.js"><link rel="prefetch" href="/blog/assets/js/29.76ea8050.js"><link rel="prefetch" href="/blog/assets/js/30.6417632a.js"><link rel="prefetch" href="/blog/assets/js/31.3f4523df.js"><link rel="prefetch" href="/blog/assets/js/32.666cd74a.js"><link rel="prefetch" href="/blog/assets/js/33.a689a6fc.js"><link rel="prefetch" href="/blog/assets/js/34.6cc2c586.js"><link rel="prefetch" href="/blog/assets/js/35.86d13f87.js"><link rel="prefetch" href="/blog/assets/js/36.20e014f1.js"><link rel="prefetch" href="/blog/assets/js/37.8b69cd99.js"><link rel="prefetch" href="/blog/assets/js/38.f1cc6c40.js"><link rel="prefetch" href="/blog/assets/js/39.5664b0d3.js"><link rel="prefetch" href="/blog/assets/js/4.60804666.js"><link rel="prefetch" href="/blog/assets/js/40.2943fb88.js"><link rel="prefetch" href="/blog/assets/js/41.6201f829.js"><link rel="prefetch" href="/blog/assets/js/42.2e1b7a5b.js"><link rel="prefetch" href="/blog/assets/js/43.9c1b7439.js"><link rel="prefetch" href="/blog/assets/js/44.68f63f99.js"><link rel="prefetch" href="/blog/assets/js/45.328fda2a.js"><link rel="prefetch" href="/blog/assets/js/46.0bd04509.js"><link rel="prefetch" href="/blog/assets/js/47.b8cfe094.js"><link rel="prefetch" href="/blog/assets/js/48.59825d73.js"><link rel="prefetch" href="/blog/assets/js/49.cffe09bd.js"><link rel="prefetch" href="/blog/assets/js/5.548a74f6.js"><link rel="prefetch" href="/blog/assets/js/50.97f9d2b0.js"><link rel="prefetch" href="/blog/assets/js/51.564cf3e9.js"><link rel="prefetch" href="/blog/assets/js/52.d2042f8d.js"><link rel="prefetch" href="/blog/assets/js/53.a70a48c8.js"><link rel="prefetch" href="/blog/assets/js/54.9a93718c.js"><link rel="prefetch" href="/blog/assets/js/55.bd9a7852.js"><link rel="prefetch" href="/blog/assets/js/56.c2bf89f1.js"><link rel="prefetch" href="/blog/assets/js/57.a8ad91e4.js"><link rel="prefetch" href="/blog/assets/js/58.51d02d31.js"><link rel="prefetch" href="/blog/assets/js/59.bd516f75.js"><link rel="prefetch" href="/blog/assets/js/6.2a5a1504.js"><link rel="prefetch" href="/blog/assets/js/60.b70f4aa5.js"><link rel="prefetch" href="/blog/assets/js/61.0ce9673a.js"><link rel="prefetch" href="/blog/assets/js/62.24bf6999.js"><link rel="prefetch" href="/blog/assets/js/63.6b1d0cdc.js"><link rel="prefetch" href="/blog/assets/js/64.0a87210f.js"><link rel="prefetch" href="/blog/assets/js/65.255d0e52.js"><link rel="prefetch" href="/blog/assets/js/66.34889547.js"><link rel="prefetch" href="/blog/assets/js/67.d5b053a1.js"><link rel="prefetch" href="/blog/assets/js/68.24775a0c.js"><link rel="prefetch" href="/blog/assets/js/69.6b6ae34e.js"><link rel="prefetch" href="/blog/assets/js/7.e088d63d.js"><link rel="prefetch" href="/blog/assets/js/70.49ff7561.js"><link rel="prefetch" href="/blog/assets/js/71.97a4d551.js"><link rel="prefetch" href="/blog/assets/js/72.49706859.js"><link rel="prefetch" href="/blog/assets/js/73.d2f96422.js"><link rel="prefetch" href="/blog/assets/js/74.3c8755ec.js"><link rel="prefetch" href="/blog/assets/js/75.5800081d.js"><link rel="prefetch" href="/blog/assets/js/76.a63525d6.js"><link rel="prefetch" href="/blog/assets/js/77.da3a7d1d.js"><link rel="prefetch" href="/blog/assets/js/78.d8480922.js"><link rel="prefetch" href="/blog/assets/js/79.64a09aa3.js"><link rel="prefetch" href="/blog/assets/js/8.f3bc1f32.js"><link rel="prefetch" href="/blog/assets/js/80.932971cd.js"><link rel="prefetch" href="/blog/assets/js/81.04f50a1e.js"><link rel="prefetch" href="/blog/assets/js/82.db879ca5.js"><link rel="prefetch" href="/blog/assets/js/83.e89b8863.js"><link rel="prefetch" href="/blog/assets/js/84.07410b58.js"><link rel="prefetch" href="/blog/assets/js/85.d46c8682.js"><link rel="prefetch" href="/blog/assets/js/87.e7860b15.js"><link rel="prefetch" href="/blog/assets/js/88.09fc332a.js"><link rel="prefetch" href="/blog/assets/js/89.8b302469.js"><link rel="prefetch" href="/blog/assets/js/9.da864c6e.js"><link rel="prefetch" href="/blog/assets/js/90.fab1b0e1.js"><link rel="prefetch" href="/blog/assets/js/91.d1662d38.js"><link rel="prefetch" href="/blog/assets/js/92.4093acc4.js"><link rel="prefetch" href="/blog/assets/js/93.d4c601c1.js"><link rel="prefetch" href="/blog/assets/js/94.1e2891fe.js"><link rel="prefetch" href="/blog/assets/js/95.758d874c.js"><link rel="prefetch" href="/blog/assets/js/96.85084d66.js"><link rel="prefetch" href="/blog/assets/js/97.16a7a60a.js"><link rel="prefetch" href="/blog/assets/js/98.a84fee2e.js"><link rel="prefetch" href="/blog/assets/js/99.f9452cba.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.e16ad0a6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">一名GO+PHP工程师</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://gitee.com/ColinWWL/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://gitee.com/ColinWWL/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/Go类型系统/1Go类型系统概述" class="sidebar-heading clickable open"><span>Go类型系统</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/Go类型系统/1Go类型系统概述.html" class="sidebar-link">Go类型系统概述</a></li><li><a href="/blog/开发基础/GO/Go类型系统/2指针.html" class="sidebar-link">指针</a></li><li><a href="/blog/开发基础/GO/Go类型系统/3结构体.html" class="sidebar-link">结构体</a></li><li><a href="/blog/开发基础/GO/Go类型系统/4值部.html" class="sidebar-link">值部</a></li><li><a href="/blog/开发基础/GO/Go类型系统/5数组、切片和映射.html" class="sidebar-link">数组、切片和映射</a></li><li><a href="/blog/开发基础/GO/Go类型系统/6通道.html" class="sidebar-link">通道</a></li><li><a href="/blog/开发基础/GO/Go类型系统/7方法.html" class="sidebar-link">方法</a></li><li><a href="/blog/开发基础/GO/Go类型系统/8接口.html" class="sidebar-link">接口</a></li><li><a href="/blog/开发基础/GO/Go类型系统/9类型内嵌.html" class="sidebar-link">类型内嵌</a></li><li><a href="/blog/开发基础/GO/Go类型系统/10非类型安全指针.html" class="active sidebar-link">非类型安全指针</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go类型系统/10非类型安全指针.html#关于-unsafe-标准库包" class="sidebar-link">关于 unsafe 标准库包</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go类型系统/10非类型安全指针.html#非类型安全指针相关的类型转换" class="sidebar-link">非类型安全指针相关的类型转换</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go类型系统/10非类型安全指针.html#我们需要知道的一些事实" class="sidebar-link">我们需要知道的一些事实</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go类型系统/10非类型安全指针.html#事实一-非类型安全指针值是指针但uintptr值是整数" class="sidebar-link">事实一：非类型安全指针值是指针但uintptr值是整数</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go类型系统/10非类型安全指针.html#事实二-不再被使用的内存块的回收时间点是不确定的" class="sidebar-link">事实二：不再被使用的内存块的回收时间点是不确定的</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go类型系统/10非类型安全指针.html#事实三-一个值的地址在程序运行中可能改变" class="sidebar-link">事实三：一个值的地址在程序运行中可能改变</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go类型系统/10非类型安全指针.html#事实四-一个值的生命范围可能并没有代码中看上去的大" class="sidebar-link">事实四：一个值的生命范围可能并没有代码中看上去的大</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go类型系统/10非类型安全指针.html#事实五-unsafe-pointer-是一个类型安全指针类型" class="sidebar-link">事实五： *unsafe.Pointer 是一个类型安全指针类型</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go类型系统/10非类型安全指针.html#如何正确地使用非类型安全指针" class="sidebar-link">如何正确地使用非类型安全指针？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go类型系统/10非类型安全指针.html#使用模式一-将类型-t1-的一个值转换为非类型安全指针值-然后将此非类型安全指针值转换为类型-t2-。" class="sidebar-link">使用模式一：将类型 *T1 的一个值转换为非类型安全指针值，然后将此非类型安全指针值转换为类型 *T2 。</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go类型系统/10非类型安全指针.html#使用模式二-将一个非类型安全指针值转换为一个uintptr值-然后使用此uintptr值。" class="sidebar-link">使用模式二：将一个非类型安全指针值转换为一个uintptr值，然后使用此uintptr值。</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go类型系统/10非类型安全指针.html#使用模式三-将一个非类型安全指针转换为一个uintptr值-然后此uintptr值参与各种算术运算-再将算术运算的结果uintptr值转回非类型安全指针。" class="sidebar-link">使用模式三：将一个非类型安全指针转换为一个uintptr值，然后此uintptr值参与各种算术运算，再将算术运算的结果uintptr值转回非类型安全指针。</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go类型系统/10非类型安全指针.html#使用模式四-将非类型安全指针值转换为-uintptr-值并传递给-syscall-syscall-函数调用。" class="sidebar-link">使用模式四：将非类型安全指针值转换为 uintptr 值并传递给 syscall.Syscall 函数调用。</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go类型系统/10非类型安全指针.html#使用模式五-将-reflect-value-pointer-或者-reflect-value-unsafeaddr-方法的-uintptr-返回值立即转换为非类型安全指针。" class="sidebar-link">使用模式五：将 reflect.Value.Pointer 或者 reflect.Value.UnsafeAddr 方法的 uintptr 返回值立即转换为非类型安全指针。</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go类型系统/10非类型安全指针.html#使用模式六-将一个-reflect-sliceheader-或者-reflect-stringheader-值的-data-字段转换为非类型安全指针-以及其逆转换。" class="sidebar-link">使用模式六：将一个 reflect.SliceHeader 或者 reflect.StringHeader 值的 Data 字段转换为非类型安全指针，以及其逆转换。</a></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go类型系统/10非类型安全指针.html#更多模式" class="sidebar-link">更多模式？</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/开发基础/GO/Go类型系统/10非类型安全指针.html#总结一下" class="sidebar-link">总结一下</a></li></ul></li><li><a href="/blog/开发基础/GO/Go类型系统/11泛型.html" class="sidebar-link">泛型</a></li><li><a href="/blog/开发基础/GO/Go类型系统/12反射.html" class="sidebar-link">反射</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/Go编程入门/1程序源代码基本元素介绍" class="sidebar-heading clickable"><span>Go编程入门</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/Go编程入门/1程序源代码基本元素介绍.html" class="sidebar-link">程序源代码基本元素介绍</a></li><li><a href="/blog/开发基础/GO/Go编程入门/2关键字和标识符.html" class="sidebar-link">关键字和标识符</a></li><li><a href="/blog/开发基础/GO/Go编程入门/3基本类型和它们的字面量表示.html" class="sidebar-link">基本类型和它们的字面量表示</a></li><li><a href="/blog/开发基础/GO/Go编程入门/4常量和变量.html" class="sidebar-link">常量和变量</a></li><li><a href="/blog/开发基础/GO/Go编程入门/5运算操作符.html" class="sidebar-link">运算操作符</a></li><li><a href="/blog/开发基础/GO/Go编程入门/6函数声明和调用.html" class="sidebar-link">函数声明和调用</a></li><li><a href="/blog/开发基础/GO/Go编程入门/7代码包和包引入.html" class="sidebar-link">代码包和包引入</a></li><li><a href="/blog/开发基础/GO/Go编程入门/8表达式、语句和简单语句.html" class="sidebar-link">表达式、语句和简单语句</a></li><li><a href="/blog/开发基础/GO/Go编程入门/9基本流程控制语法.html" class="sidebar-link">基本流程控制语法</a></li><li><a href="/blog/开发基础/GO/Go编程入门/10协程、延迟函数调用、以及恐慌和恢复.html" class="sidebar-link">协程、延迟函数调用、以及恐慌和恢复</a></li><li><a href="/blog/开发基础/GO/Go编程入门/GO官方链接工具.html" class="sidebar-link">GO官方链接工具</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/其他文章/Go技巧" class="sidebar-heading clickable"><span>其他文章</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/其他文章/Go技巧.html" class="sidebar-link">Go技巧</a></li><li><a href="/blog/开发基础/GO/其他文章/Go细节.html" class="sidebar-link">Go细节</a></li><li><a href="/blog/开发基础/GO/其他文章/Go问答.html" class="sidebar-link">Go问答</a></li><li><a href="/blog/开发基础/GO/其他文章/命令-mod.html" class="sidebar-link">命令-mod</a></li><li><a href="/blog/开发基础/GO/其他文章/基础-Golang的time.NewTimer单次定时器使用案例.html" class="sidebar-link">基础-Golang的time. NewTimer单次定时器使用案例</a></li><li><a href="/blog/开发基础/GO/其他文章/基础-Go中的nil.html" class="sidebar-link">Go中的 nil</a></li><li><a href="/blog/开发基础/GO/其他文章/基础-Go代码断行规则.html" class="sidebar-link">Go代码断行规则</a></li><li><a href="/blog/开发基础/GO/其他文章/基础-表达式估值顺序规则.html" class="sidebar-link">表达式估值顺序规则</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/学习资料" class="sidebar-heading clickable"><span>GO</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/学习资料.html" class="sidebar-link">教学书籍</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/并发编程/1并发同步概述" class="sidebar-heading clickable"><span>并发编程</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/并发编程/1并发同步概述.html" class="sidebar-link">并发同步概述</a></li><li><a href="/blog/开发基础/GO/并发编程/2通道用例大全.html" class="sidebar-link">通道用例大全</a></li><li><a href="/blog/开发基础/GO/并发编程/3如何优雅地关闭通道.html" class="sidebar-link">如何优雅地关闭通道</a></li><li><a href="/blog/开发基础/GO/并发编程/4其它并发同步技术.html" class="sidebar-link">sync 标准库包中提供的并发同步技术</a></li><li><a href="/blog/开发基础/GO/并发编程/5原子操作 .html" class="sidebar-link">sync/atomic 标准库包中提供的原子操作</a></li><li><a href="/blog/开发基础/GO/并发编程/6Go中的内存顺序保证.html" class="sidebar-link">Go中的内存顺序保证</a></li><li><a href="/blog/开发基础/GO/并发编程/7一些常见并发编程错误.html" class="sidebar-link">一些常见并发编程错误</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/开发基础/GO/开发环境搭建/Docker和VS Code的Go开发环境" class="sidebar-heading clickable"><span>开发环境搭建</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/开发基础/GO/开发环境搭建/Docker和VS Code的Go开发环境.html" class="sidebar-link">Docker和VS Code的Go开发环境</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="非类型安全指针"><a href="#非类型安全指针" class="header-anchor">#</a> 非类型安全指针</h1> <p>我们已经从<a href="https://gfw.go101.org/article/pointer.html" target="_blank" rel="noopener noreferrer">Go中的指针<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>一文中学习到关于指针的各种概念和规则。 从那篇文章中，我们得知，相对于C指针，Go指针有很多限制。 比如，Go指针不支持算术运算，并且对于任意两个指针值，很可能它们不能转换到对方的类型。</p> <p>事实上，在那篇文章中解释的指针的完整称呼应该为类型安全指针。 虽然类型安全指针有助于我们轻松写出安全的代码，但是有时候施加在类型安全指针上的限制也确实导致我们不能写出最高效的代码。</p> <p>实际上，Go也支持限制较少的非类型安全指针。 非类型安全指针和C指针类似，它们都很强大，但同时也都很危险。 在某些情形下，通过非类型安全指针的帮助，我们可以写出效率更高的代码； 但另一方面，使用非类型安全指针也导致我们可能轻易地写出潜在的不安全的代码，这些潜在的不安全点很难在它们产生危害之前被及时发现。</p> <p>使用非类型安全指针的另外一个较大的风险是Go中目前提供的非类型安全指针机制并不受到<a href="https://golang.google.cn/doc/go1compat" target="_blank" rel="noopener noreferrer">Go 1 兼容性保证<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的保护。 使用了非类型安全指针的代码可能从今后的某个Go版本开始将不再能编译通过，或者运行行为发生了变化。</p> <p>如果出于种种原因，你确实希望在你的代码中使用非类型安全指针，你不仅需要提防上述风险，你还需遵守Go官方文档中列出的非类型安全指针使用模式，并清楚地知晓使用非类型安全指针带来的效果。否则，你很难使用非类型安全指针写出安全的代码。</p> <h2 id="关于-unsafe-标准库包"><a href="#关于-unsafe-标准库包" class="header-anchor">#</a> 关于 <code>unsafe</code> 标准库包</h2> <p>非类型安全指针在Go中为<a href="https://gfw.go101.org/article/type-system-overview.html#type-kinds" target="_blank" rel="noopener noreferrer">一种<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>特别的类型。 我们必须引入<a href="https://golang.google.cn/pkg/unsafe/" target="_blank" rel="noopener noreferrer"><code>unsafe</code> 标准库包<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>来使用非类型安全指针。 非类型安全指针 <code>unsafe.Pointer</code> 被声明定义为：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Pointer <span class="token operator">*</span>ArbitraryType
</code></pre></div><p>当然，这不是一个普通的类型定义。这里的 <code>ArbitraryType</code> 仅仅是暗示 <code>unsafe.Pointer</code> 类型值可以被转换为任意类型安全指针（反之亦然）。 换句话说， <code>unsafe.Pointer</code> 类似于C语言中的 <code>void*</code> 。</p> <p>非类型安全指针是指底层类型为 <code>unsafe.Pointer</code> 的类型。</p> <p>非类型安全指针的零值也使用预声明的 <code>nil</code> 标识符来表示。</p> <p><code>unsafe</code> 标准库包提供了三个函数：</p> <ul><li><code>func Alignof(variable ArbitraryType) uintptr</code>。 此函数用来取得一个值在内存中的地址对齐保证（address alignment guarantee）。 注意，同一个类型的值做为结构体字段和非结构体字段时地址对齐保证可能是不同的。 当然，这和具体编译器的实现有关。对于目前的标准编译器，同一个类型的值做为结构体字段和非结构体字段时的地址对齐保证总是相同的。 gccgo编译器对这两种情形是区别对待的。</li> <li><code>func Offsetof(selector ArbitraryType) uintptr</code>。 此函数用来取得一个结构体值的某个字段的地址相对于此结构体值的地址的偏移。 在一个程序中，对于同一个结构体类型的不同值的对应相同字段，此函数的返回值总是相同的。</li> <li><code>func Sizeof(variable ArbitraryType) uintptr</code>。 此函数用来取得一个值的尺寸（亦即此值的类型的尺寸）。 在一个程序中，对于同一个类型的不同值，此函数的返回值总是相同的。</li></ul> <p>注意：</p> <ul><li>这三个函数的返回值的类型均为内置类型<code>uintptr</code>。下面我们将了解到<code>uintptr</code>类型的值可以转换为非类型安全指针（反之亦然）。</li> <li>尽管这三个函数之一的任何调用的返回结果在同一个编译好的程序中总是一致的，但是这样的一个调用在不同架构的操作系统中（或者使用不同的编译器编译时）的返回值可能是不一样的。</li> <li>这三个函数的调用总是在编译时刻被估值，估值结果为类型为<code>uintptr</code>的常量。</li> <li>传递给<code>Offsetof</code>函数的实参必须为一个字段选择器形式<code>value.field</code>。 此选择器可以表示一个内嵌字段，但此选择器的路径中不能包含指针类型的<a href="https://gfw.go101.org/article/type-embedding.html#shorten-form" target="_blank" rel="noopener noreferrer">隐式字段<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li></ul> <p>一个使用了这三个函数的例子：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>
<span class="token keyword">import</span> <span class="token string">&quot;unsafe&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> x <span class="token keyword">struct</span> <span class="token punctuation">{</span>
		a <span class="token builtin">int64</span>
		b <span class="token builtin">bool</span>
		c <span class="token builtin">string</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">const</span> M<span class="token punctuation">,</span> N <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> N<span class="token punctuation">)</span> <span class="token comment">// 16 32</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Alignof</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 8</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Alignof</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Alignof</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 8</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Offsetof</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 0</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Offsetof</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 8</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Offsetof</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 16</span>
<span class="token punctuation">}</span>
</code></pre></div><p>下面是一个展示了上面提到的最后一个注意点的例子：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>
<span class="token keyword">import</span> <span class="token string">&quot;unsafe&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">type</span> T <span class="token keyword">struct</span> <span class="token punctuation">{</span>
		c <span class="token builtin">string</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">type</span> S <span class="token keyword">struct</span> <span class="token punctuation">{</span>
		b <span class="token builtin">bool</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> x <span class="token keyword">struct</span> <span class="token punctuation">{</span>
		a <span class="token builtin">int64</span>
		<span class="token operator">*</span>S
		T
	<span class="token punctuation">}</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Offsetof</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 0</span>
	
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Offsetof</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>S<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 8</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Offsetof</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 16</span>
	
	<span class="token comment">// 此行可以编译过，因为选择器x.c中的隐含字段T为非指针。</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Offsetof</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 16</span>
	
	<span class="token comment">// 此行编译不过，因为选择器x.b中的隐含字段S为指针。</span>
	<span class="token comment">//fmt.Println(unsafe.Offsetof(x.b)) // error</span>
	
	<span class="token comment">// 此行可以编译过，但是它将打印出字段b在x.S中的偏移量.</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Offsetof</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>S<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 0</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意，上面程序中的注释所暗示的输出结果是此程序在AMD64架构上使用标准编译器1.16版本编译时的结果。</p> <p><code>unsafe</code> 包提供的这三个函数看上去并不怎么危险。 它们的原型在以后的Go 1版本中<a href="https://groups.google.com/forum/?_escaped_fragment_=topic/golang-nuts/Pi7VveWDUPc" target="_blank" rel="noopener noreferrer">几乎不可能会发生改变<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。 Rob Pike甚至曾经<a href="https://github.com/golang/go/issues/5602" target="_blank" rel="noopener noreferrer">将这几个函数挪到其它包中<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。 <code>unsafe</code> 包的危险性基本上来自于非类型安全指针。它们和C指针一样危险，这是Go安全指针千方百计设法去避免的。</p> <h2 id="非类型安全指针相关的类型转换"><a href="#非类型安全指针相关的类型转换" class="header-anchor">#</a> 非类型安全指针相关的类型转换</h2> <p>目前（Go 1.16），Go支持下列和非类型安全指针相关的类型转换：</p> <ul><li>一个类型安全指针值可以被显式转换为一个非类型安全指针类型，反之亦然。</li> <li>一个uintptr值可以被显式转换为一个非类型安全指针类型，反之亦然。 但是，注意，一个nil非类型安全指针类型不应该被转换为uintptr并进行算术运算后再转换回来。</li></ul> <p>通过使用这些转换规则，我们可以将任意两个类型安全指针转换为对方的类型，我们也可以将一个安全指针值和一个uintptr值转换为对方的类型。</p> <p>然而，尽管这些转换在编译时刻是合法的，但是它们中一些在运行时刻并非是合法和安全的。 这些转换摧毁了Go的类型系统（不包括非类型安全指针部分）精心设立的内存安全屏障。 我们必须遵循本文后面要介绍的一些用法指示来使用非类型安全指针才能写出合法并安全的代码。</p> <h2 id="我们需要知道的一些事实"><a href="#我们需要知道的一些事实" class="header-anchor">#</a> 我们需要知道的一些事实</h2> <p>在开始介绍合法的非类型安全指针使用模式之前，我们需要知道一些事实。</p> <h3 id="事实一-非类型安全指针值是指针但uintptr值是整数"><a href="#事实一-非类型安全指针值是指针但uintptr值是整数" class="header-anchor">#</a> 事实一：非类型安全指针值是指针但uintptr值是整数</h3> <p>每一个非零安全或者不安全指针值均引用着另一个值。但是一个uintptr值并不引用任何值，它被看作是一个整数，尽管常常它存储的是一个地址的数字表示。</p> <p>Go是一门支持垃圾回收的语言。 当一个Go程序在运行中，Go运行时（runtime）将不时地<a href="https://gfw.go101.org/article/memory-block.html#when-to-collect" target="_blank" rel="noopener noreferrer">检查哪些内存块将不再被程序中的任何仍在使用中的值所引用并且回收这些内存块<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。 指针在这一过程中扮演着重要的角色。值与值之间和内存块与值之间的引用关系是通过指针来表征的。</p> <p>既然一个uintptr值是一个整数，那么它可以参与算术运算。</p> <p>下一节中的例子将展示指针和uintptr值的不同。</p> <h3 id="事实二-不再被使用的内存块的回收时间点是不确定的"><a href="#事实二-不再被使用的内存块的回收时间点是不确定的" class="header-anchor">#</a> 事实二：不再被使用的内存块的回收时间点是不确定的</h3> <p>在运行时刻，一次新的垃圾回收过程可能在一个不确定的时间启动，并且此过程可能需要一段不确定的时长才能完成。 所以一个不再被使用的内存块的<a href="https://gfw.go101.org/article/memory-block.html#when-can-collect" target="_blank" rel="noopener noreferrer">回收时间点<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是不确定的。</p> <p>一个例子：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token string">&quot;unsafe&quot;</span>

<span class="token comment">// 假设此函数不会被内联（inline）。</span>
<span class="token keyword">func</span> <span class="token function">createInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span><span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	p0<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token operator">:=</span> <span class="token function">createInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">createInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">createInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> p1 <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token comment">// 和y一样引用着同一个值</span>
	<span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// 此时，即使z指针值所引用的int值的地址仍旧存储</span>
	<span class="token comment">// 在p2值中，但是此int值已经不再被使用了，所以垃圾</span>
	<span class="token comment">// 回收器认为可以回收它所占据的内存块了。另一方面，</span>
	<span class="token comment">// p0和p1各自所引用的int值仍旧将在下面被使用。</span>

	<span class="token comment">// uintptr值可以参与算术运算。</span>
	p2 <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span> p2<span class="token operator">--</span><span class="token punctuation">;</span> p2<span class="token operator">--</span>

	<span class="token operator">*</span>p0 <span class="token operator">=</span> <span class="token number">1</span>                         <span class="token comment">// okay</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span>                 <span class="token comment">// okay</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span> <span class="token comment">// 危险操作！</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在上面这个例子中，值 <code>p2</code> 仍旧在使用这个事实并不能保证曾经被 <code>z</code> 指针值所引用的 <code>int</code> 值所占的内存块一定还没有被回收。 换句话说，当 <code>*(*int)(unsafe.Pointer(p2)) = 3</code> 被执行的时候，此内存块有可能已经被回收了。 所以，继续通过解引用值 <code>p2</code> 中存储的地址是非常危险的，因为此内存块可能已经被重新分配给其它值使用了。</p> <h3 id="事实三-一个值的地址在程序运行中可能改变"><a href="#事实三-一个值的地址在程序运行中可能改变" class="header-anchor">#</a> 事实三：一个值的地址在程序运行中可能改变</h3> <p>详情请阅读<a href="https://gfw.go101.org/article/memory-block.html#where-to-allocate" target="_blank" rel="noopener noreferrer">内存块<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>一文（见链接所指一节的尾部）。 这里我们只需要知道当一个协程的栈的大小改变时，开辟在此栈上的内存块需要移动，从而相应的值的地址将改变。</p> <h3 id="事实四-一个值的生命范围可能并没有代码中看上去的大"><a href="#事实四-一个值的生命范围可能并没有代码中看上去的大" class="header-anchor">#</a> 事实四：一个值的生命范围可能并没有代码中看上去的大</h3> <p>比如中下面这个例子，值 <code>t</code> 仍旧在使用中并不能保证被值 <code>t.y</code> 所引用的值仍在被使用。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> T <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	x <span class="token builtin">int</span>
	y <span class="token operator">*</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	t <span class="token operator">:=</span> T<span class="token punctuation">{</span>y<span class="token punctuation">:</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
	p <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token operator">...</span> <span class="token comment">// 使用t.x和t.y</span>

	<span class="token comment">// 一个聪明的编译器能够觉察到值t.y将不会再被用到，</span>
	<span class="token comment">// 所以认为t.y值所占的内存块可以被回收了。</span>

	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// 危险操作！</span>

	<span class="token function">println</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token comment">// ok。继续使用值t，但只使用t.x字段。</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="事实五-unsafe-pointer-是一个类型安全指针类型"><a href="#事实五-unsafe-pointer-是一个类型安全指针类型" class="header-anchor">#</a> 事实五： <code>*unsafe.Pointer</code> 是一个类型安全指针类型</h3> <p>是的，类型 <code>*unsafe.Pointer</code> 是一个类型安全指针类型。 它的基类型为 <code>unsafe.Pointer</code> 。 既然它是一个类型安全指针类型，根据上面列出的类型转换规则，它的值可以转换为类型 <code>unsafe.Pointer</code> ，反之亦然。</p> <p>一个例子：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;unsafe&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	x <span class="token operator">:=</span> <span class="token number">123</span>                <span class="token comment">// 类型为int</span>
	p <span class="token operator">:=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>x<span class="token punctuation">)</span> <span class="token comment">// 类型为unsafe.Pointer</span>
	pp <span class="token operator">:=</span> <span class="token operator">&amp;</span>p                <span class="token comment">// 类型为*unsafe.Pointer</span>
	p <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span>
	pp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="如何正确地使用非类型安全指针"><a href="#如何正确地使用非类型安全指针" class="header-anchor">#</a> 如何正确地使用非类型安全指针？</h2> <p><code>unsafe</code> 标准库包的文档中列出了<a href="https://golang.google.cn/pkg/unsafe/#Pointer" target="_blank" rel="noopener noreferrer">六种非类型安全指针的使用模式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。 下面将对它们逐一进行讲解。</p> <h3 id="使用模式一-将类型-t1-的一个值转换为非类型安全指针值-然后将此非类型安全指针值转换为类型-t2-。"><a href="#使用模式一-将类型-t1-的一个值转换为非类型安全指针值-然后将此非类型安全指针值转换为类型-t2-。" class="header-anchor">#</a> 使用模式一：将类型 <code>*T1</code> 的一个值转换为非类型安全指针值，然后将此非类型安全指针值转换为类型 <code>*T2</code> 。</h3> <p>利用前面列出的非类型安全指针相关的转换规则，我们可以将一个 <code>*T1</code> 值转换为类型 <code>*T2</code> ，其中 <code>T1</code> 和 <code>T2</code> 为两个任意类型。 然而，我们只有在 <code>T1</code> 的尺寸不小于 <code>T2</code> 并且此转换具有实际意义的时候才应该实施这样的转换。</p> <p>通过将一个 <code>*T1</code> 值转换为类型 <code>*T2</code> ，我们也可以将一个 <code>T1</code> 值转换为类型 <code>T2</code> 。</p> <p>一个这样的例子是 <code>math</code> 标准库包中的 <code>Float64bits</code> 函数。 此函数将一个 <code>float64</code> 值转换为一个 <code>uint64</code> 值。 在此转换过程中，此 <code>float64</code> 值在内存中的每个位（bit）都保持不变。 函数 <code>math.Float64frombits</code> 为此转换的逆转换。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Float64bits</span><span class="token punctuation">(</span>f <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token builtin">uint64</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uint64</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Float64frombits</span><span class="token punctuation">(</span>b <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">float64</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>请注意，函数调用 <code>math.Float64bits(aFloat64)</code> 的结果和显式转换 <code>uint64(aFloat64)</code> 的结果不同。</p> <p>在下面这个例子中，我们使用此模式将一个 <code>[]MyString</code> 值和一个 <code>[]string</code> 值转换为对方的类型。 结果切片和被转换的切片将共享底层元素。（这样的转换是不可能通过安全的方式来实现的。）</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;unsafe&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">type</span> MyString <span class="token builtin">string</span>
	ms <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>MyString<span class="token punctuation">{</span><span class="token string">&quot;C&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;C++&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Go&quot;</span><span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span>  <span class="token comment">// [C C++ Go]</span>
	<span class="token comment">// ss := ([]string)(ms) // 编译错误</span>
	ss <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ms<span class="token punctuation">)</span><span class="token punctuation">)</span>
	ss<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;Rust&quot;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span> <span class="token comment">// [C Rust Go]</span>
	<span class="token comment">// ms = []MyString(ss) // 编译错误</span>
	ms <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span>MyString<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ss<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此模式在实践中的另一个应用是将一个不再使用的字节切片转换为一个字符串（从而避免对底层字节序列的一次开辟和复制）。如下例所示：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ByteSlice2String</span><span class="token punctuation">(</span>bs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bs<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此实现借鉴于 <code>strings</code> 标准库包中的 <code>Builder</code> 类型的 <code>String</code> 方法的实现。 字节切片的尺寸比字符串的尺寸要大，并且<a href="https://gfw.go101.org/article/value-part.html#internal-definitions" target="_blank" rel="noopener noreferrer">它们的底层结构<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>类似，所以此转换（对于当前的主流Go编译器来说）是安全的。 即使这样，此实现也只推荐在标准库中使用，而不推荐在用户代码中使用。 在用户代码中，最好尽量使用文末提供的另一种实现。</p> <p>反过来，下面这个例子中的转换是非法的，因为字符串的尺寸比字节切片的尺寸小。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">String2ByteSlice</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 危险</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在后面的模式六中展示了一种合法的（无需复制底层字节序列即可）将一个字符串转换为字节切片的实现。</p> <p>注意：当运用上面展示的使用非类型安全指针将一个字节切片转换为字符串的技巧时，请确保结果字符串在使用过程中绝对不修改此字节切片中的字节值。</p> <h3 id="使用模式二-将一个非类型安全指针值转换为一个uintptr值-然后使用此uintptr值。"><a href="#使用模式二-将一个非类型安全指针值转换为一个uintptr值-然后使用此uintptr值。" class="header-anchor">#</a> 使用模式二：将一个非类型安全指针值转换为一个uintptr值，然后使用此uintptr值。</h3> <p>此模式不是很有用。一般我们将最终的转换结果uintptr值输出到日志中用来调试，但是有很多其它安全并且简洁的途径也可以实现此目的。</p> <p>一个例子：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>
<span class="token keyword">import</span> <span class="token string">&quot;unsafe&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">type</span> T <span class="token keyword">struct</span><span class="token punctuation">{</span>a <span class="token builtin">int</span><span class="token punctuation">}</span>
	<span class="token keyword">var</span> t T
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%p\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>t<span class="token punctuation">)</span>                          <span class="token comment">// 0xc6233120a8</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">)</span>                                     <span class="token comment">// 0xc6233120a8</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%x\n&quot;</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// c6233120a8</span>
<span class="token punctuation">}</span>
</code></pre></div><p>输出地址在每次运行中可能都会不同。</p> <h3 id="使用模式三-将一个非类型安全指针转换为一个uintptr值-然后此uintptr值参与各种算术运算-再将算术运算的结果uintptr值转回非类型安全指针。"><a href="#使用模式三-将一个非类型安全指针转换为一个uintptr值-然后此uintptr值参与各种算术运算-再将算术运算的结果uintptr值转回非类型安全指针。" class="header-anchor">#</a> 使用模式三：将一个非类型安全指针转换为一个uintptr值，然后此uintptr值参与各种算术运算，再将算术运算的结果uintptr值转回非类型安全指针。</h3> <p>转换前后的非类型安全指针必须指向同一个内存块。一个例子：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>
<span class="token keyword">import</span> <span class="token string">&quot;unsafe&quot;</span>

<span class="token keyword">type</span> T <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	x <span class="token builtin">bool</span>
	y <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int16</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> N <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Offsetof</span><span class="token punctuation">(</span>T<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span>
<span class="token keyword">const</span> M <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>T<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span>y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	t <span class="token operator">:=</span> T<span class="token punctuation">{</span>y<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int16</span><span class="token punctuation">{</span><span class="token number">123</span><span class="token punctuation">,</span> <span class="token number">456</span><span class="token punctuation">,</span> <span class="token number">789</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
	p <span class="token operator">:=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">)</span>
	<span class="token comment">// &quot;uintptr(p) + N + M + M&quot;为t.y[2]的内存地址。</span>
	ty2 <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">int16</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">+</span>N<span class="token operator">+</span>M<span class="token operator">+</span>M<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>ty2<span class="token punctuation">)</span> <span class="token comment">// 789</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意：在上面这个例子中，转换 <code>unsafe.Pointer(uintptr(p) + N + M + M)</code> 不应该像下面这样被拆成两行。 请阅读下面的代码中的注释以获取原因。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	t <span class="token operator">:=</span> T<span class="token punctuation">{</span>y<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int16</span><span class="token punctuation">{</span><span class="token number">123</span><span class="token punctuation">,</span> <span class="token number">456</span><span class="token punctuation">,</span> <span class="token number">789</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
	p <span class="token operator">:=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">)</span>
	<span class="token comment">// ty2 := (*int16)(unsafe.Pointer(uintptr(p)+N+M+M))</span>
	addr <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">+</span> N <span class="token operator">+</span> M <span class="token operator">+</span> M
	<span class="token comment">// 从这里到下一行代码执行之前，t值将不再被任何值</span>
	<span class="token comment">// 引用，所以垃圾回收器认为它可以被回收了。一旦</span>
	<span class="token comment">// 它真地被回收了，下面继续使用t.y[2]值的曾经</span>
	<span class="token comment">// 的地址是非法和危险的！另一个危险的原因是</span>
	<span class="token comment">// t的地址在执行下一行之前可能改变（见事实三）。</span>
	<span class="token comment">// 另一个潜在的危险是：如果在此期间发生了一些</span>
	<span class="token comment">// 导致协程堆栈大小改变的情况，则记录在addr中</span>
	<span class="token comment">// 的地址将失效。当然，此危险对于这个特定的例子</span>
	<span class="token comment">// 并不存在。</span>
	ty2 <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">int16</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>ty2<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样的bug是非常微妙和很难被觉察到的，并且爆发出来的几率是相当得低。 一旦这样的bug爆发出来，将很让人摸不到头脑。这也是使用非类型安全指针被认为是危险操作的原因之一。</p> <p>中间uintptr值可以参与 <code>&amp;^</code> 清位运算来进行内存对齐计算，只要保证转换前后的非类型安全指针同时指向同一个内存块，整个转换就是合法安全的。</p> <p>另一个需要注意的细节是最好不要将一个内存块的结尾边界地址存储在一个（安全或非安全）指针中。 这样做将导致紧随着此内存块的另一个内存块肯定不会被垃圾回收掉。 请阅读<a href="https://gfw.go101.org/article/unofficial-faq.html#final-zero-size-field" target="_blank" rel="noopener noreferrer">这个问答<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>以获取更多解释。</p> <h3 id="使用模式四-将非类型安全指针值转换为-uintptr-值并传递给-syscall-syscall-函数调用。"><a href="#使用模式四-将非类型安全指针值转换为-uintptr-值并传递给-syscall-syscall-函数调用。" class="header-anchor">#</a> 使用模式四：将非类型安全指针值转换为 <code>uintptr</code> 值并传递给 <code>syscall.Syscall</code> 函数调用。</h3> <p>通过对上一个使用模式的解释，我们知道像下面这样含有uintptr类型的参数的函数定义是危险的。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 假设此函数不会被内联。</span>
<span class="token keyword">func</span> <span class="token function">DoSomething</span><span class="token punctuation">(</span>addr <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 对处于传递进来的地址处的值进行读写...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面这个函数是危险的原因在于此函数本身不能保证传递进来的地址处的内存块一定没有被回收。 如果此内存块已经被回收了或者被重新分配给了其它值，那么此函数内部的操作将是非法和危险的。</p> <p>然而， <code>syscall</code> 标准库包中的 <code>Syscall</code> 函数的原型为：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Syscall</span><span class="token punctuation">(</span>trap<span class="token punctuation">,</span> a1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a3 <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>r1<span class="token punctuation">,</span> r2 <span class="token builtin">uintptr</span><span class="token punctuation">,</span> err Errno<span class="token punctuation">)</span>
</code></pre></div><p>那么此函数是如何保证处于传递给它的地址参数值 <code>a1</code> 、 <code>a2</code> 和 <code>a3</code> 处的内存块在此函数执行过程中一定没有被回收和被移动呢？ 此函数无法做出这样的保证。事实上，是编译器做出了这样的保证。 这是 <code>syscall.Syscall</code> 这样的函数的特权。其它自定义函数无法享受到这样的待遇。</p> <p>我们可以认为编译器针对每个 <code>syscall.Syscall</code> 函数调用中的每个被转换为 <code>uintptr</code> 类型的非类型安全指针实参添加了一些指令，从而保证此非类型安全指针所引用着的内存块在此调用返回之前不会被垃圾回收和移动。</p> <p>注意：在Go 1.15之前，类型转换表达式 <code>uintptr(anUnsafePointer)</code> 可以呈现为相关实参的子表达式。 但是，从Go 1.15开始，使用此模式的要求变得略加严格：相关实参必须呈现为 <code>uintptr(anUnsafePointer)</code> 这种形式。</p> <p>下面这个调用是安全的：</p> <div class="language-go extra-class"><pre class="language-go"><code>syscall<span class="token punctuation">.</span><span class="token function">Syscall</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>SYS_READ<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>但下面这个调用则是危险的：</p> <div class="language-go extra-class"><pre class="language-go"><code>u <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 被p所引用着的值在此时有可能会被回收掉，</span>
<span class="token comment">// 或者它的地址已经发生了改变。</span>
syscall<span class="token punctuation">.</span><span class="token function">Syscall</span><span class="token punctuation">(</span>SYS_READ<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> u<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 相关实参必须呈现为&quot;uintptr(anUnsafePointer)&quot;</span>
<span class="token comment">// 这种形式。事实上，Go 1.15之前，此调用是合法的；</span>
<span class="token comment">// 但是Go 1.15略改了一点规则。</span>
syscall<span class="token punctuation">.</span><span class="token function">Syscall</span><span class="token punctuation">(</span>SYS_XXX<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token function">uint</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>再提醒一次，此使用模式不适用于其它自定义函数。</p> <h3 id="使用模式五-将-reflect-value-pointer-或者-reflect-value-unsafeaddr-方法的-uintptr-返回值立即转换为非类型安全指针。"><a href="#使用模式五-将-reflect-value-pointer-或者-reflect-value-unsafeaddr-方法的-uintptr-返回值立即转换为非类型安全指针。" class="header-anchor">#</a> 使用模式五：将 <code>reflect.Value.Pointer</code> 或者 <code>reflect.Value.UnsafeAddr</code> 方法的 <code>uintptr</code> 返回值立即转换为非类型安全指针。</h3> <p><code>reflect</code> 标准库包中的 <code>Value</code> 类型的 <code>Pointer</code> 和 <code>UnsafeAddr</code> 方法都返回一个 <code>uintptr</code> 值，而不是一个 <code>unsafe.Pointer</code> 值。 这样设计的目的是避免用户不引用 <code>unsafe</code> 标准库包就可以将这两个方法的返回值（如果是 <code>unsafe.Pointer</code> 类型）转换为任何类型安全指针类型。</p> <p>这样的设计需要我们将这两个方法的调用的 <code>uintptr</code> 结果立即转换为非类型安全指针。 否则，将出现一个短暂的可能导致处于返回的地址处的内存块被回收掉的时间窗。 此时间窗是如此短暂以至于此内存块被回收掉的几率非常之低，因而这样的编程错误造成的bug的重现几率亦十分得低。</p> <p>比如，下面这个调用是安全的：</p> <div class="language-go extra-class"><pre class="language-go"><code>p <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>而下面这个调用是危险的：</p> <div class="language-go extra-class"><pre class="language-go"><code>u <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 在这个时刻，处于存储在u中的地址处的内存块</span>
<span class="token comment">// 可能会被回收掉。</span>
p <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>注意：此使用模式也适用于Windows系统中的<a href="https://golang.org/pkg/syscall/?GOOS=windows#Proc.Call" target="_blank" rel="noopener noreferrer">syscall. Proc. Call<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>和<a href="https://golang.org/pkg/syscall/?GOOS=windows#LazyProc.Call" target="_blank" rel="noopener noreferrer">syscall. LazyProc. Call<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>系统调用。</p> <h3 id="使用模式六-将一个-reflect-sliceheader-或者-reflect-stringheader-值的-data-字段转换为非类型安全指针-以及其逆转换。"><a href="#使用模式六-将一个-reflect-sliceheader-或者-reflect-stringheader-值的-data-字段转换为非类型安全指针-以及其逆转换。" class="header-anchor">#</a> 使用模式六：将一个 <code>reflect.SliceHeader</code> 或者 <code>reflect.StringHeader</code> 值的 <code>Data</code> 字段转换为非类型安全指针，以及其逆转换。</h3> <p>和上一小节中提到的同样的原因， <code>reflect</code> 标准库包中的 <code>SliceHeader</code> 和 <code>StringHeader</code> 类型的 <code>Data</code> 字段的类型被指定为 <code>uintptr</code> ，而不是 <code>unsafe.Pointer</code> 。</p> <p>我们可以将一个字符串的指针值转换为一个 <code>*reflect.StringHeader</code> 指针值，从而可以对此字符串的内部进行修改。 类似地，我们可以将一个切片的指针值转换为一个 <code>*reflect.SliceHeader</code> 指针值，从而可以对此切片的内部进行修改。</p> <p>一个使用 <code>reflect.StringHeader</code> 的例子：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>
<span class="token keyword">import</span> <span class="token string">&quot;unsafe&quot;</span>
<span class="token keyword">import</span> <span class="token string">&quot;reflect&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token string">'G'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'n'</span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">}</span>
	s <span class="token operator">:=</span> <span class="token string">&quot;Java&quot;</span>
	hdr <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>reflect<span class="token punctuation">.</span>StringHeader<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>
	hdr<span class="token punctuation">.</span>Data <span class="token operator">=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
	hdr<span class="token punctuation">.</span>Len <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token comment">// Golang</span>
	<span class="token comment">// 现在，字符串s和切片a共享着底层的byte字节序列，</span>
	<span class="token comment">// 从而使得此字符串中的字节变得可以修改。</span>
	a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">,</span> <span class="token string">'e'</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token comment">// Google</span>
<span class="token punctuation">}</span>
</code></pre></div><p>一个使用了 <code>reflect.SliceHeader</code> 的例子：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;unsafe&quot;</span>
	<span class="token string">&quot;reflect&quot;</span>
	<span class="token string">&quot;runtime&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token string">'G'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">}</span>
	bs <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;Golang&quot;</span><span class="token punctuation">)</span>
	hdr <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>reflect<span class="token punctuation">.</span>SliceHeader<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bs<span class="token punctuation">)</span><span class="token punctuation">)</span>
	hdr<span class="token punctuation">.</span>Data <span class="token operator">=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>

	hdr<span class="token punctuation">.</span>Len <span class="token operator">=</span> <span class="token number">2</span>
	hdr<span class="token punctuation">.</span>Cap <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span> bs<span class="token punctuation">)</span> <span class="token comment">// Go</span>
	bs <span class="token operator">=</span> bs<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">cap</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span><span class="token punctuation">]</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span> bs<span class="token punctuation">)</span> <span class="token comment">// Go101</span>
<span class="token punctuation">}</span>
</code></pre></div><p>一般说来，我们只应该从一个已经存在的字符串值得到一个 <code>*reflect.StringHeader</code> 指针， 或者从一个已经存在的切片值得到一个 <code>*reflect.SliceHeader</code> 指针， 而不应该从一个 <code>StringHeader</code> 值生成一个字符串，或者从一个 <code>SliceHeader</code> 值生成一个切片。 比如，下面的代码是不安全的：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> hdr reflect<span class="token punctuation">.</span>StringHeader
hdr<span class="token punctuation">.</span>Data <span class="token operator">=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 在此时刻，上一行代码中刚开辟的数组内存块已经不再被任何值</span>
<span class="token comment">// 所引用，所以它可以被回收了。</span>
hdr<span class="token punctuation">.</span>Len <span class="token operator">=</span> <span class="token number">5</span>
s <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hdr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 危险！</span>
</code></pre></div><p>下面是一个展示了如何通过使用非类型安全途径将一个字符串转换为字节切片的例子。 和使用类型安全途径进行转换不同，使用非类型安全途径避免了复制一份底层字节序列。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;reflect&quot;</span>
	<span class="token string">&quot;runtime&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
	<span class="token string">&quot;unsafe&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">String2ByteSlice</span><span class="token punctuation">(</span>str <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>bs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	strHdr <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>reflect<span class="token punctuation">.</span>StringHeader<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span>
	sliceHdr <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>reflect<span class="token punctuation">.</span>SliceHeader<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bs<span class="token punctuation">)</span><span class="token punctuation">)</span>
	sliceHdr<span class="token punctuation">.</span>Data <span class="token operator">=</span> strHdr<span class="token punctuation">.</span>Data
	sliceHdr<span class="token punctuation">.</span>Cap <span class="token operator">=</span> strHdr<span class="token punctuation">.</span>Len
	sliceHdr<span class="token punctuation">.</span>Len <span class="token operator">=</span> strHdr<span class="token punctuation">.</span>Len
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// str := &quot;Golang&quot;</span>
	<span class="token comment">// 对于官方标准编译器来说，上面这行将使str中的字节</span>
	<span class="token comment">// 开辟在不可修改内存区。所以这里我们使用下面这行。</span>
	str <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;Go&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;land&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
	s <span class="token operator">:=</span> <span class="token function">String2ByteSlice</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token comment">// Goland</span>
	s<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'g'</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token comment">// Golang</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>reflect</code> 标准库包中 <code>SliceHeader</code> 和 <code>StringHeader</code> 类型的<a href="https://golang.google.cn/pkg/reflect/#SliceHeader" target="_blank" rel="noopener noreferrer">文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>提到这两个结构体类型的定义不保证在以后的版本中不发生改变。好在目前的两个主流Go编译器（标准编译器和gccgo编译器）都认可当前版本中的定义。这也可以看作是使用非类型安全指针的另一个（较低的）潜在风险。</p> <p>我们可以使用类似的实现来将一个字节切片转换为字符串。 不过在模式一中展示的方法更为推荐。</p> <p>注意：当使用上面展示的使用非类型安全指针将一个字符串转换为字节切片时，请确保结果此字符串在后续使用过程中务必不要修改结果字节切片中的字节值。 事实上，更为推荐的是最好永远不要修改结果字节切片中的字节值。此非类型安全方式的目的主要是为了在局部感知范围内避免一次内存开辟，而不是一种通用的方式。</p> <h3 id="更多模式"><a href="#更多模式" class="header-anchor">#</a> 更多模式？</h3> <p>暂时没有更多合法的使用模式了。但是需要指出的是：合法使用非类型安全指针的模式设计仍在不断演化和改进中。 下面是一些已经被批准从而将采纳在后续的Go版本中的提案：</p> <ul><li><a href="https://github.com/golang/go/issues/19367" target="_blank" rel="noopener noreferrer">在code&gt;unsafe包中添加一个<code>Slice(ptr *T, len anyIntegerType) [\]T</code>函数。<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/golang/go/issues/40481" target="_blank" rel="noopener noreferrer">在code&gt;unsafe包中添加一个<code>Add(p Pointer, x uintptr) Pointer</code>函数。<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="总结一下"><a href="#总结一下" class="header-anchor">#</a> 总结一下</h2> <p>从上面解释中，我们得知，对于某些情形，非类型安全机制可以帮助我们写出运行效率更高的代码。 但是，使用非类型安全指针也使得我们可能轻易地写出一些重现几率非常低的微妙的bug。 一个含有这样的bug的程序很可能在很长一段时间内都运行正常，但是突然变得不正常甚至崩溃。 这样的bug很难发现和调试。</p> <p>我们只应该在不得不使用非类型安全机制的时候才使用它们。 特别地，当我们使用非类型安全机制时，请务必遵循上面列出的使用模式。</p> <p>重申一次，我们应该知晓当前的非类型安全机制规则和使用模式可能在以后的Go版本中完全失效。 当然，目前没有任何迹象表明这种变化将很快会来到。 但是，一旦发生这种变化，本文中列出的当前是正确的代码将变得不再安全甚至编译不通过。 所以，在实践中，请尽量保证能够将使用了非类型安全机制的代码轻松改为使用安全途径实现。</p> <p>最后值得提一下的是，Go官方工具链1.14中加入了一个 <code>-gcflags=all=-d=checkptr</code> 编译器动态分析选项。 当此选项被使用的时候，编译出的程序在运行时会监测到很多（但并非所有）非类型安全指针的错误使用。一旦错误的使用被监测到，恐慌将产生（当前，暂不推荐在Windows平台上使用此选项）。 感谢<a href="https://github.com/golang/go/issues/22218" target="_blank" rel="noopener noreferrer">Matthew Dempsky实现了此特性<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/21/2021, 1:25:38 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/开发基础/GO/Go类型系统/9类型内嵌.html" class="prev">
        类型内嵌
      </a></span> <span class="next"><a href="/blog/开发基础/GO/Go类型系统/11泛型.html">
        泛型
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.b472f60d.js" defer></script><script src="/blog/assets/js/3.21e2e031.js" defer></script><script src="/blog/assets/js/86.3869d59e.js" defer></script>
  </body>
</html>
