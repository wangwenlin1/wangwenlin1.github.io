(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{1255:function(t,s,a){"use strict";a.r(s);var r=a(19),e=Object(r.a)({},(function(){var t=this,s=t.$createElement,r=t._self._c||s;return r("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[r("h1",{attrs:{id:"事务-秒杀案例"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#事务-秒杀案例"}},[t._v("#")]),t._v(" 事务_秒杀案例")]),t._v(" "),r("h2",{attrs:{id:"解决计数器和人员记录的事务操作"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#解决计数器和人员记录的事务操作"}},[t._v("#")]),t._v(" 解决计数器和人员记录的事务操作")]),t._v(" "),r("p",[r("img",{attrs:{src:a(848),alt:""}})]),t._v(" "),r("h2",{attrs:{id:"事务-秒杀并发模拟"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#事务-秒杀并发模拟"}},[t._v("#")]),t._v(" 事务--秒杀并发模拟")]),t._v(" "),r("p",[t._v("使用工具ab模拟测试")]),t._v(" "),r("p",[t._v("CentOS6 默认安装")]),t._v(" "),r("p",[t._v("CentOS7需要手动安装")]),t._v(" "),r("h3",{attrs:{id:"联网-yum-install-httpd-tools"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#联网-yum-install-httpd-tools"}},[t._v("#")]),t._v(" 联网：yum install httpd-tools")]),t._v(" "),r("h3",{attrs:{id:"无网络"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#无网络"}},[t._v("#")]),t._v(" 无网络")]),t._v(" "),r("p",[t._v("（1） 进入cd  /run/media/root/CentOS 7 x86_64/Packages（路径跟centos6不同）")]),t._v(" "),r("p",[t._v("（2） 顺序安装")]),t._v(" "),r("div",{staticClass:"language-sh extra-class"},[r("pre",{pre:!0,attrs:{class:"language-sh"}},[r("code",[t._v("apr-1.4.8-3.el7.x86_64.rpm\n\napr-util-1.5.2-6.el7.x86_64.rpm\n\nhttpd-tools-2.4.6-67.el7.centos.x86_64.rpm\n")])])]),r("h3",{attrs:{id:"测试及结果"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#测试及结果"}},[t._v("#")]),t._v(" 测试及结果")]),t._v(" "),r("h4",{attrs:{id:"通过ab测试"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#通过ab测试"}},[t._v("#")]),t._v(" 通过ab测试")]),t._v(" "),r("p",[t._v("vim postfile 模拟表单提交参数,以&符号结尾;存放当前目录。")]),t._v(" "),r("p",[t._v("内容：prodid=0101&")]),t._v(" "),r("p",[t._v("ab -n 2000 -c 200 -k -p ~/postfile -T application/x-www-form-urlencoded http://192.168.2.115:8081/Seckill/doseckill")]),t._v(" "),r("p",[r("em",[r("strong",[t._v("*超卖*")])])]),t._v(" "),r("table",[r("thead",[r("tr",[r("th",[r("img",{attrs:{src:a(849),alt:""}})]),t._v(" "),r("th",[r("img",{attrs:{src:a(850),alt:""}})])])]),t._v(" "),r("tbody",[r("tr",[r("td"),t._v(" "),r("td")])])]),t._v(" "),r("h2",{attrs:{id:"超卖问题"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#超卖问题"}},[t._v("#")]),t._v(" 超卖问题")]),t._v(" "),r("p",[r("img",{attrs:{src:a(851),alt:""}})]),t._v(" "),r("h2",{attrs:{id:"利用乐观锁淘汰用户-解决超卖问题。"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#利用乐观锁淘汰用户-解决超卖问题。"}},[t._v("#")]),t._v(" 利用乐观锁淘汰用户，解决超卖问题。")]),t._v(" "),r("p",[r("img",{attrs:{src:a(852),alt:""}})]),t._v(" "),r("table",[r("thead",[r("tr",[r("th",[r("img",{attrs:{src:a(853),alt:""}}),t._v(" "),r("img",{attrs:{src:a(854),alt:""}})]),t._v(" "),r("th",[r("img",{attrs:{src:a(855),alt:""}}),t._v(" "),r("img",{attrs:{src:a(856),alt:""}})])])]),t._v(" "),r("tbody",[r("tr",[r("td"),t._v(" "),r("td")])])]),t._v(" "),r("h2",{attrs:{id:"继续增加并发测试"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#继续增加并发测试"}},[t._v("#")]),t._v(" 继续增加并发测试")]),t._v(" "),r("h3",{attrs:{id:"连接有限制"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#连接有限制"}},[t._v("#")]),t._v(" 连接有限制")]),t._v(" "),r("p",[t._v("ab -n 2000 -c 200 -k -p postfile -T 'application/x-www-form-urlencoded' http://192.168.140.1:8080/seckill/doseckill")]),t._v(" "),r("p",[t._v("![img](file:////tmp/wps-colin/ksohtml/wps7T07kL.png)")]),t._v(" "),r("p",[t._v("增加-r参数，-r  Don't exit on socket receive errors.")]),t._v(" "),r("p",[r("strong",[t._v("ab -n 2000 -c 100 -r -p postfile -T 'application/x-www-form-urlencoded'")]),t._v(" "),r("a",{attrs:{href:"http://192.168.140.1:8080/seckill/doseckill",target:"_blank",rel:"noopener noreferrer"}},[r("strong",[t._v("<u>http://192.168.</u>"),r("strong",[r("strong",[t._v("<u>140</u>")])]),t._v("<u>.1:8080/seckill/doseckill</u>")]),r("OutboundLink")],1)]),t._v(" "),r("h3",{attrs:{id:"已经秒光-可是还有库存"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#已经秒光-可是还有库存"}},[t._v("#")]),t._v(" 已经秒光，可是还有库存")]),t._v(" "),r("p",[t._v("ab -n 2000 -c 100 -p postfile -T 'application/x-www-form-urlencoded' http://192.168.137.1:8080/seckill/doseckill")]),t._v(" "),r("p",[t._v("已经秒光，可是还有库存。原因，就是乐观锁导致很多请求都失败。先点的没秒到，后点的可能秒到了。")]),t._v(" "),r("p",[r("img",{attrs:{src:a(857),alt:""}})]),t._v(" "),r("h3",{attrs:{id:"连接超时-通过连接池解决"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#连接超时-通过连接池解决"}},[t._v("#")]),t._v(" 连接超时，通过连接池解决")]),t._v(" "),r("p",[r("img",{attrs:{src:a(858),alt:""}})]),t._v(" "),r("h3",{attrs:{id:"连接池"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#连接池"}},[t._v("#")]),t._v(" 连接池")]),t._v(" "),r("p",[t._v("节省每次连接redis服务带来的消耗，把连接好的实例反复利用。")]),t._v(" "),r("p",[t._v("通过参数管理连接的行为")]),t._v(" "),r("p",[t._v("代码见项目中")]),t._v(" "),r("ul",[r("li",[r("p",[t._v("链接池参数")]),t._v(" "),r("ul",[r("li",[r("p",[t._v("n MaxTotal：控制一个pool可分配多少个jedis实例，通过pool.getResource()来获取；如果赋值为-1，则表示不限制；如果pool已经分配了MaxTotal个jedis实例，则此时pool的状态为exhausted。")])]),t._v(" "),r("li",[r("p",[t._v("n maxIdle：控制一个pool最多有多少个状态为idle(空闲)的jedis实例；")])]),t._v(" "),r("li",[r("p",[t._v("n MaxWaitMillis：表示当borrow一个jedis实例时，最大的等待毫秒数，如果超过等待时间，则直接抛JedisConnectionException；")])]),t._v(" "),r("li",[r("p",[t._v("n testOnBorrow：获得一个jedis实例的时候是否检查连接可用性（ping()）；如果为true，则得到的jedis实例均是可用的；")])])])])]),t._v(" "),r("h2",{attrs:{id:"解决库存遗留问题"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#解决库存遗留问题"}},[t._v("#")]),t._v(" 解决库存遗留问题")]),t._v(" "),r("h3",{attrs:{id:"lua脚本"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#lua脚本"}},[t._v("#")]),t._v(" LUA脚本")]),t._v(" "),r("p",[r("img",{attrs:{src:a(859),alt:""}})]),t._v(" "),r("p",[t._v("Lua 是一个小巧的"),r("a",{attrs:{href:"http://baike.baidu.com/item/%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80",target:"_blank",rel:"noopener noreferrer"}},[t._v("脚本语言"),r("OutboundLink")],1),t._v("，Lua脚本可以很容易的被C/C++ 代码调用，也可以反过来调用C/C++的函数，Lua并没有提供强大的库，一个完整的Lua解释器不过200k，所以Lua不适合作为开发独立应用程序的语言，而是作为嵌入式脚本语言。")]),t._v(" "),r("p",[t._v("很多应用程序、游戏使用LUA作为自己的嵌入式脚本语言，以此来实现可配置性、可扩展性。")]),t._v(" "),r("p",[t._v("这其中包括魔兽争霸地图、魔兽世界、博德之门、愤怒的小鸟等众多游戏插件或外挂。")]),t._v(" "),r("p",[t._v("https://www.w3cschool.cn/lua/")]),t._v(" "),r("h3",{attrs:{id:"lua脚本在redis中的优势"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#lua脚本在redis中的优势"}},[t._v("#")]),t._v(" LUA脚本在Redis中的优势")]),t._v(" "),r("p",[t._v("将复杂的或者多步的redis操作，写为一个脚本，一次提交给redis执行，减少反复连接redis的次数。提升性能。")]),t._v(" "),r("p",[t._v("LUA脚本是类似redis事务，有一定的原子性，不会被其他命令插队，可以完成一些redis事务性的操作。")]),t._v(" "),r("p",[t._v("但是注意redis的lua脚本功能，只有在Redis 2.6以上的版本才可以使用。")]),t._v(" "),r("p",[t._v("利用lua脚本淘汰用户，解决超卖问题。")]),t._v(" "),r("p",[t._v("redis 2.6版本以后，通过lua脚本解决"),r("strong",[t._v("争抢问题")]),t._v("*，实际上是"),r("strong",[t._v("redis 利用其单线程的特性，用任务队列的方式解决多任务并发问题")]),t._v("。")]),t._v(" "),r("p",[r("img",{attrs:{src:a(860),alt:""}})]),t._v(" "),r("h2",{attrs:{id:"事务-秒杀案例-代码"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#事务-秒杀案例-代码"}},[t._v("#")]),t._v(" 事务_秒杀案例_代码")]),t._v(" "),r("h3",{attrs:{id:"项目结构"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#项目结构"}},[t._v("#")]),t._v(" 项目结构")]),t._v(" "),r("p",[r("img",{attrs:{src:a(861),alt:""}})]),t._v(" "),r("h3",{attrs:{id:"第一版-简单版"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#第一版-简单版"}},[t._v("#")]),t._v(" 第一版：简单版")]),t._v(" "),r("p",[t._v("老师点10次，正常秒杀")]),t._v(" "),r("p",[t._v("同学一起点试一试，秒杀也是正常的。这是因为还达不到并发的效果。")]),t._v(" "),r("p",[t._v("使用工具ab模拟并发测试，会出现超卖情况。查看库存会出现负数。")]),t._v(" "),r("h3",{attrs:{id:"第二版-加事务-乐观锁-解决超卖-但出现遗留库存和连接超时"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#第二版-加事务-乐观锁-解决超卖-但出现遗留库存和连接超时"}},[t._v("#")]),t._v(" 第二版：加事务-乐观锁(解决超卖),但出现遗留库存和连接超时")]),t._v(" "),r("h3",{attrs:{id:"第三版-连接池解决超时问题"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#第三版-连接池解决超时问题"}},[t._v("#")]),t._v(" 第三版：连接池解决超时问题")]),t._v(" "),r("h3",{attrs:{id:"第四版-解决库存依赖问题lua脚本"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#第四版-解决库存依赖问题lua脚本"}},[t._v("#")]),t._v(" 第四版：解决库存依赖问题LUA脚本")]),t._v(" "),r("div",{staticClass:"language-lua extra-class"},[r("pre",{pre:!0,attrs:{class:"language-lua"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" userid"),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("KEYS"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),r("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n"),r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" prodid"),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("KEYS"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),r("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" qtkey"),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),r("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sk:"')]),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("..")]),t._v("prodid"),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("..")]),r("span",{pre:!0,attrs:{class:"token string"}},[t._v('":qt"')]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" usersKey"),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),r("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sk:"')]),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("..")]),t._v("prodid"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v('"'),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("usr'"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n"),r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" userExists"),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("redis"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),r("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),r("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sismember"')]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("usersKey"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("userid"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token function"}},[t._v("tonumber")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("userExists"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),r("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v(" \n  "),r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n"),r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" num"),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" redis"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),r("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),r("span",{pre:!0,attrs:{class:"token string"}},[t._v('"get"')]),t._v(" "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("qtkey"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token function"}},[t._v("tonumber")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("num"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\\"),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),r("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v(" \n  "),r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n"),r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" \n  redis"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),r("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),r("span",{pre:!0,attrs:{class:"token string"}},[t._v('"decr"')]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("qtkey"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  redis"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),r("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),r("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sadd"')]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("usersKey"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("userid"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n"),r("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])])}),[],!1,null,null,null);s.default=e.exports},848:function(t,s,a){t.exports=a.p+"assets/img/2021-05-15-08-29-55.b29317d5.png"},849:function(t,s,a){t.exports=a.p+"assets/img/2021-05-15-08-34-22.3802c865.png"},850:function(t,s,a){t.exports=a.p+"assets/img/2021-05-15-08-34-29.667787cc.png"},851:function(t,s,a){t.exports=a.p+"assets/img/2021-05-15-08-34-54.eec8472f.png"},852:function(t,s,a){t.exports=a.p+"assets/img/2021-05-15-08-35-15.5528dd60.png"},853:function(t,s,a){t.exports=a.p+"assets/img/2021-05-15-08-38-10.aa7c16ae.png"},854:function(t,s,a){t.exports=a.p+"assets/img/2021-05-15-08-38-22.61c9ae45.png"},855:function(t,s,a){t.exports=a.p+"assets/img/2021-05-15-08-35-30.d449118e.png"},856:function(t,s,a){t.exports=a.p+"assets/img/2021-05-15-08-35-41.d7362fa4.png"},857:function(t,s,a){t.exports=a.p+"assets/img/2021-05-15-08-39-59.8d6c1343.png"},858:function(t,s,a){t.exports=a.p+"assets/img/2021-05-15-10-48-52.b26e65c4.png"},859:function(t,s,a){t.exports=a.p+"assets/img/2021-05-15-08-46-55.8dcb1d9d.png"},860:function(t,s,a){t.exports=a.p+"assets/img/2021-05-15-08-47-40.058eae3f.png"},861:function(t,s,a){t.exports=a.p+"assets/img/2021-05-15-08-48-14.b2b3c9df.png"}}]);