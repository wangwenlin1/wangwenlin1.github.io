(window.webpackJsonp=window.webpackJsonp||[]).push([[66],{1247:function(t,s,a){"use strict";a.r(s);var n=a(19),r=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"物化视图-事务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#物化视图-事务"}},[t._v("#")]),t._v(" 物化视图-事务")]),t._v(" "),n("h2",{attrs:{id:"物化视图"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#物化视图"}},[t._v("#")]),t._v(" 物化视图")]),t._v(" "),n("p",[t._v("物化视图是相对于视图而言的，但是两者实际上并没有什么关系就如java/javaScript一样")]),t._v(" "),n("p",[t._v("首先mysql的视图不是一种物化视图，他相当于一个虚拟表，本身并不存储数据，当sql在操作视图时所有数据都是从其他表中查询出来的。者带来的问题是使用视图并不能将常用数据分离出来，优化查询速度，切操作视图的很多命令和普通标一样，这回导致在业务中无法通过sql区分表和视图，是代码变得复杂。")]),t._v(" "),n("p",[t._v("视图是简化设计，清晰编码的东西，他并不是提高性能的，他的存在只会降低性能（如一个视图7个表关联，另一个视图8个表，程序员不知道，觉得很方便，把两个视图关联再做一个视图，那就惨了），他的存在未了在设计上的方便性")]),t._v(" "),n("p",[t._v("物化视图可以帮助加快严重依赖某些聚合结果的查询。"),n("br"),t._v("\n如果插入速度不是问题，则此功能可以帮助减少系统上的读取负载。")]),t._v(" "),n("div",{staticClass:"language-sql extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("count")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sum")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pro_price"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sum")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pro_num"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("avg")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pro_price"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("avg")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pro_num"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" purchase_order\n\n物化视图 可以理解成 就是单独再创建一张统计表吗\n\n把数据记录 "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("count")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sum")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pro_price"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sum")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pro_num"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("avg")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pro_price"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("avg")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pro_num"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" purchase_order "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v("  purchase_mv\n\n根据项目的需求 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("数据实时性"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n要定时更新数据"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" 存储过程 "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("call")]),t._v("\n开销小"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("误差大一点\n\n中间表 使用视图是避免因为 purchase_mv 表的结果修改"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("而影响到存储过程与触发器的查询"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sql")]),t._v("语句的修改\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("create")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("view")]),t._v(" por_view "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v("\n\t\t\tsupply_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("count")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" pro_count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sum")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pro_price"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" pro_price_sum"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("avg")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pro_price"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" pro_price_avg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sum")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pro_num"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" pro_num_sum"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("avg")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pro_num"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" pro_num_avg\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v("\n\t\t\tpurchase_order\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("group")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("by")]),t._v("\n\t\t\tsupply_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n定时执行这样的"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sql")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("insert")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("into")]),t._v(" purchase_mv "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" por_view"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n第一步获取 需要获取原有统计数据 "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" por_view\n第二步写入 purchase_mv\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DROP")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PROCEDURE")]),t._v(" refresh_mv_now"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DELIMITER")]),t._v(" $$\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PROCEDURE")]),t._v(" refresh_mv_now "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BEGIN")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TRUNCATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" purchase_mv"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INSERT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INTO")]),t._v(" purchase_mv "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" por_view"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("END")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n$$\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DELIMITER")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" purchase_mv"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n定时执行下面的"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sql")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("你可以使用你所会的方法\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("call")]),t._v(" refresh_mv_now "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n实时更新数据"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" 触发器 使用触发器"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("是很会影响数据库的写操作的性能\n开销大\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("drop")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("trigger")]),t._v(" purchase_mv_trigger_ins"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DELIMITER")]),t._v(" $$\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TRIGGER")]),t._v(" purchase_mv_trigger_ins "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AFTER")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INSERT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ON")]),t._v(" purchase_order "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FOR EACH ROW")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BEGIN")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SET")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@old_pro_price_sum")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SET")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@old_pro_price_avg")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SET")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@old_pro_num_sum")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SET")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@old_pro_num_avg")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SET")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@old_pro_count")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查询出之前的信息然后记录到不同的变量中")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v("\n\t\tIFNULL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pro_price_sum"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("IFNULL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pro_price_avg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tIFNULL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pro_num_sum"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("IFNULL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pro_num_avg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tIFNULL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pro_count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v("\n\t\tpurchase_mv\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v("\n\t\tsupply_name "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NEW"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("supply_name\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INTO")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@old_pro_price_sum")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@old_pro_price_avg")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@old_pro_num_sum")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@old_pro_num_avg")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@old_pro_count")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 然后再去计算更新操作之后的内容")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SET")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@new_pro_count")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@old_pro_count")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SET")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@new_pro_price_sum")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@old_pro_price_sum")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" NEW"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pro_price"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SET")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@new_pro_price_avg")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@new_pro_price_sum")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@new_pro_count")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SET")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@new_pro_num_sum")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@old_pro_num_sum")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" NEW"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pro_num"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SET")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@new_pro_num_avg")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@new_pro_num_sum")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@new_pro_count")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("REPLACE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INTO")]),t._v("\n\t\tpurchase_mv\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VALUES")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t\tNEW"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("supply_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@new_pro_count")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@new_pro_price_sum")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" IFNULL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@new_pro_price_avg")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@new_pro_num_sum")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" IFNULL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@new_pro_num_avg")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("END")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n$$\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DELIMITER")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" 表可能会改变\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" purchase_mv"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\tsupply_name "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VARCHAR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tpro_count "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tpro_price_sum "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INT")]),t._v("  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tpro_price_avg "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FLOAT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tpro_num_sum "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INT")]),t._v("  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tpro_num_avg "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FLOAT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UNIQUE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INDEX")]),t._v(" supply_name "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("supply_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n物化视图 "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" 存储过程 和 触发器的 综合应用\n表的数据大 : 有些内容很频繁查询\n")])])]),n("h4",{attrs:{id:"_1-2-存储过程与触发器区别是"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-存储过程与触发器区别是"}},[t._v("#")]),t._v(" 1.2 存储过程与触发器区别是？")]),t._v(" "),n("p",[t._v("存储过程 => 主动 技能 ( 函数 )"),n("br"),t._v("\n触发器   => 被动 技能 ( 函数 )")]),t._v(" "),n("h2",{attrs:{id:"事务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#事务"}},[t._v("#")]),t._v(" 事务")]),t._v(" "),n("h3",{attrs:{id:"myisam实现事务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#myisam实现事务"}},[t._v("#")]),t._v(" MyISAM实现事务")]),t._v(" "),n("p",[t._v("通过表锁实现伪事务")]),t._v(" "),n("h3",{attrs:{id:"事务的概念"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#事务的概念"}},[t._v("#")]),t._v(" 事务的概念")]),t._v(" "),n("p",[t._v("事务处理可以确保除非事务性单元内的所有操作都成功完成，否则不会永远更新面向数据的资源。通过将一组相关操作组合为一个要么全部成功要么全部失败的单元，可以简化错误恢复病史应用程序更加可靠。一个逻辑共奏单元要成为事务，必须满足所谓的ACID（原子性、一致性、隔离性和持久性）属性：")]),t._v(" "),n("ol",[n("li",[t._v("原子性（A）\n"),n("ul",[n("li",[t._v("对于数据修改，要么全部都执行，要么全都不执行。")])])]),t._v(" "),n("li",[t._v("隔离性（C）\n"),n("ul",[n("li",[t._v("在所有的操作没有执行完毕之前，其他会话不能够看到中间改变的过程。")])])]),t._v(" "),n("li",[t._v("一致性（I）\n"),n("ul",[n("li",[t._v("事务发生前和发生后，根据数据的规则，总额应该匹配。")])])]),t._v(" "),n("li",[t._v("持久性（D）\n"),n("ul",[n("li",[t._v("事务一旦被提交，其结果就是永久性的，系统崩溃也不会影响")])])])]),t._v(" "),n("p",[t._v("应用场景: 使用场景一般涉及到个人财务信息的时候都会使用到，比如上图的积分计算, 还有订单购物车等")]),t._v(" "),n("div",{staticClass:"language-sql extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("start")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("transaction")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" 开启事务\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("insert")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("into")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("count")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("prefix"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("historyCount"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("values")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'dyi'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" count\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("commit")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[n("img",{attrs:{src:a(808),alt:""}})]),t._v(" "),n("h3",{attrs:{id:"事务的实现"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#事务的实现"}},[t._v("#")]),t._v(" 事务的实现")]),t._v(" "),n("p",[t._v("存储引擎简单瞧瞧后面细讲")]),t._v(" "),n("p",[n("img",{attrs:{src:a(809),alt:""}})]),t._v(" "),n("p",[t._v("因为MySQL5之后通常的默认存储引擎是InnoDB所以，以InnoDB为例讲解实现过程")]),t._v(" "),n("p",[t._v("MySQL在进行事务处理的时候使用的是日志现行的方式来保证事务可快速和持久运行的，也就是在写数据库前，需要先写日志。当开始一个事务时，会记录该事物的一个LSN日志序列号；当执行事务时，会往InnoDB_Log_Buffer 日志缓冲区里插入事务日志（redo log）; 当事务提交时，会将日志缓存区里的事务日志刷入磁盘。这个动作主要是由innodb_flush_log_at_trx_commit这个参数控制的。")]),t._v(" "),n("ol",[n("li",[t._v("发出commit动作时。已经说明过，commit发出后是否刷日志由变量 innodb_flush_log_at_trx_commit 控制。")]),t._v(" "),n("li",[t._v("每秒刷一次。这个刷日志的频率由变量 innodb_flush_log_at_timeout 值决定，默认是1秒。要注意，这个刷日志频率和commit动作无关。")]),t._v(" "),n("li",[t._v("当log buffer中已经使用的内存超过一半时。")]),t._v(" "),n("li",[t._v("当有checkpoint时，checkpoint在一定程度上代表了刷到磁盘时日志所处的LSN位置。")])]),t._v(" "),n("p",[t._v("可以通过命令")]),t._v(" "),n("div",{staticClass:"language-sql extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("show")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("engine")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("innodb")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("status")]),t._v("\\G"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("blockquote",[n("p",[t._v("Log sequence number 8619676075 (表示当前的LSN日志序列号)"),n("br"),n("br"),t._v("\nLog flushed up to   8619676075 (表示刷新到事物日志的LSN日志序列号)"),n("br"),n("br"),t._v("\nLast checkpoint at  8619676075 (表示刷新到磁盘的LSN日志序列号)")])]),t._v(" "),n("p",[t._v("除了记录事务日志意外，数据库还会记录一定量的撤销日志(undo log)， undo与redo正好相反，在对数据进行修改时，由于某种原因失败了，或者人为执行了rollback回滚语句，就可以利用这些撤销日志将数据回滚到修改之前的样子。redo日志保存在ib_logfile0/1/2里，而undo日志保存在ibdata1里，在MySQL5.6里还可以把undo日志单拆分出去。")]),t._v(" "),n("h3",{attrs:{id:"分布式事务-了解"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#分布式事务-了解"}},[t._v("#")]),t._v(" 分布式事务（了解）")]),t._v(" "),n("p",[t._v("资源管理器：管理事务的提交和回滚，向事务提供资源。"),n("br"),t._v("\n事务管理器：和资源管理器通信，协调完成事务的处理。")]),t._v(" "),n("p",[t._v("用于执行分布式事务的过程使用两个阶段；"),n("br"),t._v("\n（1）第一阶段：所有的分支被预备。他们被事务管理器告知要准备提交，每个分支资源管理器记录分支的行动并指示认为的可行性。"),n("br"),t._v("\n（2）第二阶段：事务管理器告知资源管理器是否要提交或者回滚。如果预备分子时，所有的分支指示他们将能够提交，那么所有的分支被告知提交。如果有一个分支出错，那么就全部都要回滚。特殊情况下，只有一个分支的时候，第二阶段则被省略。")]),t._v(" "),n("p",[t._v("分布式事务主要作用在于确保事务的一致性和完整性。他利用分布式的计算环境，将多个事务性的活动合并成一个事务单元，这些事务组合在一起构成原子操作，这些事务的活动要么一起执行并提交事务，要么回滚所有的操作，从而保证了多个活动之间的一致性和完整性。")])])}),[],!1,null,null,null);s.default=r.exports},808:function(t,s,a){t.exports=a.p+"assets/img/markdown-img-paste-20190327223126157.70a2fa18.png"},809:function(t,s,a){t.exports=a.p+"assets/img/2021-05-14-16-54-50.0737d0f8.png"}}]);