(window.webpackJsonp=window.webpackJsonp||[]).push([[53],{1217:function(s,t,a){"use strict";a.r(t);var e=a(19),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"集群环境"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#集群环境"}},[s._v("#")]),s._v(" 集群环境")]),s._v(" "),e("h2",{attrs:{id:"相关概念"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#相关概念"}},[s._v("#")]),s._v(" 相关概念")]),s._v(" "),e("h3",{attrs:{id:"单机-集群"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#单机-集群"}},[s._v("#")]),s._v(" 单机 & 集群")]),s._v(" "),e("p",[s._v("单台 Elasticsearch 服务器提供服务，往往都有最大的负载能力，超过这个阈值，服务器性能就会大大降低甚至不可用，所以生产环境中，一般都是运行在指定服务器集群中。除了负载能力，单点服务器也存在其他问题：")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("单台机器存储容量有限")])]),s._v(" "),e("li",[e("p",[s._v("单服务器容易出现单点故障，无法实现高可用")])]),s._v(" "),e("li",[e("p",[s._v("单服务的并发处理能力有限")])])]),s._v(" "),e("p",[s._v("配置服务器集群时，集群中节点数量没有限制，大于等于 2 个节点就可以看做是集群了。一般出于高性能及高可用方面来考虑集群中节点数量都是 3 个以上。")]),s._v(" "),e("h3",{attrs:{id:"集群-clusterv"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#集群-clusterv"}},[s._v("#")]),s._v(" 集群 Clusterv")]),s._v(" "),e("p",[s._v("一个集群就是由一个或多个服务器节点组织在一起，共同持有整个的数据，并一起提供索引和搜索功能。一个Elasticsearch 集群有一个唯一的名字标识，这个名字默认就是”elasticsearch”。这个名字是重要的，因为一个节点只能通过指定某个集群的名字，来加入这个集群。")]),s._v(" "),e("h3",{attrs:{id:"节点-node"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#节点-node"}},[s._v("#")]),s._v(" 节点 Node")]),s._v(" "),e("p",[s._v("集群中包含很多服务器，一个节点就是其中的一个服务器。作为集群的一部分，它存储数据，参与集群的索引和搜索功能。"),e("br"),s._v("\n一个节点也是由一个名字来标识的，默认情况下，这个名字是一个随机的漫威漫画角色的名字，这个名字会在启动的时候赋予节点。这个名字对于管理工作来说挺重要的，因为在这个管理过程中，你会去确定网络中的哪些服务器对应于 Elasticsearch 集群中的哪些节点。"),e("br"),s._v("\n一个节点可以通过配置集群名称的方式来加入一个指定的集群。默认情况下，每个节点都会被安排加入到一个叫做“elasticsearch”的集群中，这意味着，如果你在你的网络中启动了若干个节点，并假定它们能够相互发现彼此，它们将会自动地形成并加入到一个叫做“elasticsearch”的集群中。")]),s._v(" "),e("p",[s._v("在一个集群里，只要你想，可以拥有任意多个节点。而且，如果当前你的网络中没有运行任何 Elasticsearch 节点，这时启动一个节点，会默认创建并加入一个叫做“elasticsearch”的集群。")]),s._v(" "),e("h3",{attrs:{id:"测试集群"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#测试集群"}},[s._v("#")]),s._v(" 测试集群")]),s._v(" "),e("p",[s._v("查看集群状态")]),s._v(" "),e("ul",[e("li",[s._v("node-1001 节点")]),s._v(" "),e("li",[s._v("node-1002 节点")]),s._v(" "),e("li",[s._v("node-1003 节点")])]),s._v(" "),e("p",[s._v("向集群中的 node-1001 节点增加索引"),e("br"),s._v("\n向集群中的 node-1002 节点查询索引")]),s._v(" "),e("h2",{attrs:{id:"linux-单机"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#linux-单机"}},[s._v("#")]),s._v(" Linux 单机")]),s._v(" "),e("h3",{attrs:{id:"软件下载"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#软件下载"}},[s._v("#")]),s._v(" 软件下载")]),s._v(" "),e("p",[s._v("软件下载地址：https://www.elastic.co/cn/downloads/past-releases/elasticsearch-7-8-0")]),s._v(" "),e("h3",{attrs:{id:"软件安装"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#软件安装"}},[s._v("#")]),s._v(" 软件安装")]),s._v(" "),e("ol",[e("li",[s._v("解压软件"),e("br"),s._v("\n将下载的软件解压缩")])]),s._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[s._v("# 解压缩\ntar -zxvf elasticsearch"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("-7.8")]),s._v("."),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("-linux-x86_64.tar.gz -C /opt/module\n\n# 改名\nmv elasticsearch"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("-7.8")]),s._v("."),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" es\n")])])]),e("ol",{attrs:{start:"2"}},[e("li",[s._v("创建用户"),e("br"),s._v("\n因为安全问题，Elasticsearch 不允许 root 用户直接运行，所以要创建新用户，在 root 用"),e("br"),s._v("\n户中创建新用户")])]),s._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[s._v("useradd es #新增 es 用户\npasswd es #为 es 用户设置密码\nuserdel -r es #如果错了，可以删除再加\nchown -R es"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("es /opt/module/es #文件夹所有者\n")])])]),e("ol",{attrs:{start:"3"}},[e("li",[s._v("修改配置文件")])]),s._v(" "),e("p",[s._v("修改/opt/module/es/config/elasticsearch.yml 文件")]),s._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加入如下配置")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster.name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" elasticsearch\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("node.name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" node"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("network.host")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 0.0.0.0\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("http.port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("9200")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster.initial_master_nodes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node-1"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),e("p",[s._v("修改/etc/security/limits.conf")]),s._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在文件末尾中增加下面内容")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每个进程可以打开的文件数的限制")]),s._v("\nes soft nofile 65536\nes hard nofile 65536\n")])])]),e("p",[s._v("修改/etc/security/limits.d/20-nproc.conf")]),s._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在文件末尾中增加下面内容")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每个进程可以打开的文件数的限制")]),s._v("\nes soft nofile 65536\nes hard nofile 65536\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 操作系统级别对每个用户创建的进程数的限制")]),s._v("\n\n* hard nproc 4096\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注：* 带表 Linux 所有用户名称")]),s._v("\n")])])]),e("p",[s._v("修改/etc/sysctl.conf")]),s._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在文件中增加下面内容")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一个进程可以拥有的 VMA(虚拟内存区域)的数量, 默认值为 65536")]),s._v("\nvm.max_map_count=655360\n")])])]),e("p",[s._v("重新加载")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("sysctl -p \n")])])]),e("h3",{attrs:{id:"启动软件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#启动软件"}},[s._v("#")]),s._v(" 启动软件")]),s._v(" "),e("p",[s._v("使用 ES 用户启动")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt/module/es/\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#启动")]),s._v("\nbin/elasticsearch\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#后台启动")]),s._v("\nbin/elasticsearch -d\n")])])]),e("p",[s._v("启动时，会动态生成文件，如果文件所属用户不匹配，会发生错误，需要重新进行修改用户"),e("br"),s._v("\n和用户组"),e("br"),s._v(" "),e("img",{attrs:{src:a(643),alt:""}})]),s._v(" "),e("p",[s._v("关闭防火墙")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#暂时关闭防火墙")]),s._v("\nsystemctl stop firewalld\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#永久关闭防火墙")]),s._v("\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" firewalld.service "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#打开放货抢永久性生效，重启后不会复原")]),s._v("\nsystemctl disable firewalld.service "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#关闭防火墙，永久性生效，重启后不会复原")]),s._v("\n")])])]),e("h3",{attrs:{id:"测试软件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#测试软件"}},[s._v("#")]),s._v(" 测试软件")]),s._v(" "),e("p",[s._v("浏览器中输入地址：http://linux1:9200/"),e("br"),s._v(" "),e("img",{attrs:{src:a(644),alt:""}})]),s._v(" "),e("h2",{attrs:{id:"linux-集群"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#linux-集群"}},[s._v("#")]),s._v(" Linux 集群")]),s._v(" "),e("h3",{attrs:{id:"软件下载-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#软件下载-2"}},[s._v("#")]),s._v(" 软件下载")]),s._v(" "),e("p",[s._v("软件下载地址：https://www.elastic.co/cn/downloads/past-releases/elasticsearch-7-8-0")]),s._v(" "),e("h3",{attrs:{id:"软件安装-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#软件安装-2"}},[s._v("#")]),s._v(" 软件安装")]),s._v(" "),e("ol",[e("li",[s._v("解压软件"),e("br"),s._v("\n将下载的软件解压缩")])]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 解压缩")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" -zxvf elasticsearch-7.8.0-linux-x86_64.tar.gz -C /opt/module\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 改名")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" elasticsearch-7.8.0 es-cluster\n")])])]),e("p",[s._v("将软件分发到其他节点：linux2, linux3")]),s._v(" "),e("ol",{attrs:{start:"2"}},[e("li",[s._v("创建用户"),e("br"),s._v("\n因为安全问题，Elasticsearch 不允许 root 用户直接运行，所以要在每个节点中创建新用"),e("br"),s._v("\n户，在 root 用户中创建新用户")])]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("useradd")]),s._v(" es "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#新增 es 用户")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("passwd")]),s._v(" es "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#为 es 用户设置密码")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("userdel")]),s._v(" -r es "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#如果错了，可以删除再加")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" -R es:es /opt/module/es-cluster "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#文件夹所有者")]),s._v("\n")])])]),e("ol",{attrs:{start:"3"}},[e("li",[s._v("修改配置文件"),e("br"),s._v("\n修改/opt/module/es/config/elasticsearch.yml 文件，分发文件")])]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加入如下配置")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#集群名称")]),s._v("\ncluster.name: cluster-es\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#节点名称，每个节点的名称不能重复")]),s._v("\nnode.name: node-1\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ip 地址，每个节点的地址不能重复")]),s._v("\n\nnetwork.host: linux1\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#是不是有资格主节点")]),s._v("\nnode.master: "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nnode.data: "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nhttp.port: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("9200")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# head 插件需要这打开这两个配置")]),s._v("\n\nhttp.cors.allow-origin: "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"*"')]),s._v("\nhttp.cors.enabled: "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nhttp.max_content_length: 200mb\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#es7.x 之后新增的配置，初始化一个新的集群时需要此配置来选举 master")]),s._v("\ncluster.initial_master_nodes: "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node-1"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#es7.x 之后新增的配置，节点发现")]),s._v("\ndiscovery.seed_hosts: "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"linux1:9300"')]),s._v(", "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"linux2:9300"')]),s._v(", "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"linux3:9300"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\ngateway.recover_after_nodes: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\nnetwork.tcp.keep_alive: "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nnetwork.tcp.no_delay: "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\ntransport.tcp.compress: "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#集群内同时启动的数据任务个数，默认是 2 个")]),s._v("\ncluster.routing.allocation.cluster_concurrent_rebalance: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#添加或删除节点及负载均衡时并发恢复的线程个数，默认 4 个")]),s._v("\ncluster.routing.allocation.node_concurrent_recoveries: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#初始化数据恢复时，并发恢复线程的个数，默认 4 个")]),s._v("\ncluster.routing.allocation.node_initial_primaries_recoveries: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("\n修改/etc/security/limits.conf ，分发文件\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在文件末尾中增加下面内容")]),s._v("\n\nes soft nofile "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v("\nes hard nofile "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v("\n修改/etc/security/limits.d/20-nproc.conf，分发文件\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在文件末尾中增加下面内容")]),s._v("\n\nes soft nofile "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v("\nes hard nofile "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v("\n\n* hard nproc "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注：* 带表 Linux 所有用户名称")]),s._v("\n\n修改/etc/sysctl.conf\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在文件中增加下面内容")]),s._v("\n\nvm.max_map_count"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("655360")]),s._v("\n")])])]),e("p",[s._v("重新加载")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("sysctl -p \n")])])]),e("h3",{attrs:{id:"启动软件-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#启动软件-2"}},[s._v("#")]),s._v(" 启动软件")]),s._v(" "),e("p",[s._v("分别在不同节点上启动 ES 软件")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt/module/es-cluster\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#启动")]),s._v("\nbin/elasticsearch\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#后台启动")]),s._v("\nbin/elasticsearch -d\n")])])]),e("h3",{attrs:{id:"测试集群-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#测试集群-2"}},[s._v("#")]),s._v(" 测试集群")]),s._v(" "),e("p",[e("img",{attrs:{src:a(645),alt:""}})])])}),[],!1,null,null,null);t.default=n.exports},643:function(s,t,a){s.exports=a.p+"assets/img/2021-05-15-15-26-41.8cb54d2c.png"},644:function(s,t,a){s.exports=a.p+"assets/img/2021-05-15-15-27-35.0928dc6e.png"},645:function(s,t,a){s.exports=a.p+"assets/img/2021-05-15-15-31-12.ae3a5c51.png"}}]);