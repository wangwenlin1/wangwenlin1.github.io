<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>高可用集群搭建 | 一名GO+PHP工程师</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/blog/assets/css/0.styles.bef719fb.css" as="style"><link rel="preload" href="/blog/assets/js/app.77332b34.js" as="script"><link rel="preload" href="/blog/assets/js/3.21e2e031.js" as="script"><link rel="preload" href="/blog/assets/js/169.64dd7e3e.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.6084136f.js"><link rel="prefetch" href="/blog/assets/js/100.d5cb88cb.js"><link rel="prefetch" href="/blog/assets/js/101.6bbce255.js"><link rel="prefetch" href="/blog/assets/js/102.968ea43c.js"><link rel="prefetch" href="/blog/assets/js/103.c5c5130e.js"><link rel="prefetch" href="/blog/assets/js/104.161b590d.js"><link rel="prefetch" href="/blog/assets/js/105.eaae1ece.js"><link rel="prefetch" href="/blog/assets/js/106.9b961ba0.js"><link rel="prefetch" href="/blog/assets/js/107.df9ba599.js"><link rel="prefetch" href="/blog/assets/js/108.1e4967d1.js"><link rel="prefetch" href="/blog/assets/js/109.bab44539.js"><link rel="prefetch" href="/blog/assets/js/11.2e1457a2.js"><link rel="prefetch" href="/blog/assets/js/110.975b5aeb.js"><link rel="prefetch" href="/blog/assets/js/111.4db6087d.js"><link rel="prefetch" href="/blog/assets/js/112.bb76db96.js"><link rel="prefetch" href="/blog/assets/js/113.9b314292.js"><link rel="prefetch" href="/blog/assets/js/114.b05dc902.js"><link rel="prefetch" href="/blog/assets/js/115.6a21a21a.js"><link rel="prefetch" href="/blog/assets/js/116.1fd8cdf3.js"><link rel="prefetch" href="/blog/assets/js/117.193b54e8.js"><link rel="prefetch" href="/blog/assets/js/118.a54057c2.js"><link rel="prefetch" href="/blog/assets/js/119.857d484f.js"><link rel="prefetch" href="/blog/assets/js/12.48cd3c41.js"><link rel="prefetch" href="/blog/assets/js/120.c2fc1bab.js"><link rel="prefetch" href="/blog/assets/js/121.5bda4d33.js"><link rel="prefetch" href="/blog/assets/js/122.8ce24886.js"><link rel="prefetch" href="/blog/assets/js/123.90357e37.js"><link rel="prefetch" href="/blog/assets/js/124.2d89e041.js"><link rel="prefetch" href="/blog/assets/js/125.7be39e4f.js"><link rel="prefetch" href="/blog/assets/js/126.598ad722.js"><link rel="prefetch" href="/blog/assets/js/127.06c981b6.js"><link rel="prefetch" href="/blog/assets/js/128.ebd5e805.js"><link rel="prefetch" href="/blog/assets/js/129.b4fdbe4d.js"><link rel="prefetch" href="/blog/assets/js/13.b814da2c.js"><link rel="prefetch" href="/blog/assets/js/130.50ee8d35.js"><link rel="prefetch" href="/blog/assets/js/131.5f734cd7.js"><link rel="prefetch" href="/blog/assets/js/132.cb85c88a.js"><link rel="prefetch" href="/blog/assets/js/133.581b5e6c.js"><link rel="prefetch" href="/blog/assets/js/134.6a6cf86d.js"><link rel="prefetch" href="/blog/assets/js/135.313b60a3.js"><link rel="prefetch" href="/blog/assets/js/136.41c7a62b.js"><link rel="prefetch" href="/blog/assets/js/137.feeb7b80.js"><link rel="prefetch" href="/blog/assets/js/138.ddd4d1f7.js"><link rel="prefetch" href="/blog/assets/js/139.b13aa419.js"><link rel="prefetch" href="/blog/assets/js/14.d54ba5e3.js"><link rel="prefetch" href="/blog/assets/js/140.c2741475.js"><link rel="prefetch" href="/blog/assets/js/141.85f894e1.js"><link rel="prefetch" href="/blog/assets/js/142.8f3573aa.js"><link rel="prefetch" href="/blog/assets/js/143.e16816e7.js"><link rel="prefetch" href="/blog/assets/js/144.c91db5db.js"><link rel="prefetch" href="/blog/assets/js/145.95b58ec4.js"><link rel="prefetch" href="/blog/assets/js/146.92cd1d56.js"><link rel="prefetch" href="/blog/assets/js/147.1aad7186.js"><link rel="prefetch" href="/blog/assets/js/148.b0a6ba25.js"><link rel="prefetch" href="/blog/assets/js/149.cf51c7a4.js"><link rel="prefetch" href="/blog/assets/js/15.5840ca25.js"><link rel="prefetch" href="/blog/assets/js/150.8961d634.js"><link rel="prefetch" href="/blog/assets/js/151.9b1a9135.js"><link rel="prefetch" href="/blog/assets/js/152.d4fcbdac.js"><link rel="prefetch" href="/blog/assets/js/153.8f0df288.js"><link rel="prefetch" href="/blog/assets/js/154.3108e3fe.js"><link rel="prefetch" href="/blog/assets/js/155.1c76998b.js"><link rel="prefetch" href="/blog/assets/js/156.e514afd4.js"><link rel="prefetch" href="/blog/assets/js/157.d4566baf.js"><link rel="prefetch" href="/blog/assets/js/158.f649eaa4.js"><link rel="prefetch" href="/blog/assets/js/159.bde474db.js"><link rel="prefetch" href="/blog/assets/js/16.5bdde5ee.js"><link rel="prefetch" href="/blog/assets/js/160.567a6feb.js"><link rel="prefetch" href="/blog/assets/js/161.d8d1d0f9.js"><link rel="prefetch" href="/blog/assets/js/162.d7e72e4d.js"><link rel="prefetch" href="/blog/assets/js/163.33c153d8.js"><link rel="prefetch" href="/blog/assets/js/164.80cca623.js"><link rel="prefetch" href="/blog/assets/js/165.1d0cd529.js"><link rel="prefetch" href="/blog/assets/js/166.b73822d1.js"><link rel="prefetch" href="/blog/assets/js/167.1d799555.js"><link rel="prefetch" href="/blog/assets/js/168.281ad92f.js"><link rel="prefetch" href="/blog/assets/js/17.5259d9eb.js"><link rel="prefetch" href="/blog/assets/js/170.e097186e.js"><link rel="prefetch" href="/blog/assets/js/171.ff778380.js"><link rel="prefetch" href="/blog/assets/js/172.6f3b63ce.js"><link rel="prefetch" href="/blog/assets/js/173.fc6d4e6a.js"><link rel="prefetch" href="/blog/assets/js/174.ae15fd8c.js"><link rel="prefetch" href="/blog/assets/js/175.bbae3a5c.js"><link rel="prefetch" href="/blog/assets/js/176.0b0e42b6.js"><link rel="prefetch" href="/blog/assets/js/177.1ff80e7e.js"><link rel="prefetch" href="/blog/assets/js/178.7f4bf5e6.js"><link rel="prefetch" href="/blog/assets/js/18.935f6748.js"><link rel="prefetch" href="/blog/assets/js/19.bee643b6.js"><link rel="prefetch" href="/blog/assets/js/2.97a298f6.js"><link rel="prefetch" href="/blog/assets/js/20.0f6c34c0.js"><link rel="prefetch" href="/blog/assets/js/21.c4b2e86b.js"><link rel="prefetch" href="/blog/assets/js/22.670160bc.js"><link rel="prefetch" href="/blog/assets/js/23.3ea9a5a9.js"><link rel="prefetch" href="/blog/assets/js/24.fded9b7a.js"><link rel="prefetch" href="/blog/assets/js/25.7a8d93d4.js"><link rel="prefetch" href="/blog/assets/js/26.4962fc80.js"><link rel="prefetch" href="/blog/assets/js/27.9f30f2c0.js"><link rel="prefetch" href="/blog/assets/js/28.dad4d7ea.js"><link rel="prefetch" href="/blog/assets/js/29.40a388e9.js"><link rel="prefetch" href="/blog/assets/js/30.09ea8215.js"><link rel="prefetch" href="/blog/assets/js/31.6a746a11.js"><link rel="prefetch" href="/blog/assets/js/32.30794034.js"><link rel="prefetch" href="/blog/assets/js/33.8fe12a68.js"><link rel="prefetch" href="/blog/assets/js/34.6ae8ca61.js"><link rel="prefetch" href="/blog/assets/js/35.770b0123.js"><link rel="prefetch" href="/blog/assets/js/36.aecfaf6e.js"><link rel="prefetch" href="/blog/assets/js/37.9eaa4368.js"><link rel="prefetch" href="/blog/assets/js/38.9037e52f.js"><link rel="prefetch" href="/blog/assets/js/39.bfc61cab.js"><link rel="prefetch" href="/blog/assets/js/4.fc4084f6.js"><link rel="prefetch" href="/blog/assets/js/40.4037bb53.js"><link rel="prefetch" href="/blog/assets/js/41.5b45d852.js"><link rel="prefetch" href="/blog/assets/js/42.eda4343c.js"><link rel="prefetch" href="/blog/assets/js/43.f1402b09.js"><link rel="prefetch" href="/blog/assets/js/44.c8598baf.js"><link rel="prefetch" href="/blog/assets/js/45.394124a5.js"><link rel="prefetch" href="/blog/assets/js/46.d684210c.js"><link rel="prefetch" href="/blog/assets/js/47.b05a79df.js"><link rel="prefetch" href="/blog/assets/js/48.09f94403.js"><link rel="prefetch" href="/blog/assets/js/49.cffe09bd.js"><link rel="prefetch" href="/blog/assets/js/5.3f398ea8.js"><link rel="prefetch" href="/blog/assets/js/50.bbc144de.js"><link rel="prefetch" href="/blog/assets/js/51.29fb5c68.js"><link rel="prefetch" href="/blog/assets/js/52.d2042f8d.js"><link rel="prefetch" href="/blog/assets/js/53.274cd25d.js"><link rel="prefetch" href="/blog/assets/js/54.38b1f6bf.js"><link rel="prefetch" href="/blog/assets/js/55.466512f8.js"><link rel="prefetch" href="/blog/assets/js/56.3be1bfea.js"><link rel="prefetch" href="/blog/assets/js/57.c919083e.js"><link rel="prefetch" href="/blog/assets/js/58.88f9f57c.js"><link rel="prefetch" href="/blog/assets/js/59.d78a1017.js"><link rel="prefetch" href="/blog/assets/js/6.02a67347.js"><link rel="prefetch" href="/blog/assets/js/60.85f7e060.js"><link rel="prefetch" href="/blog/assets/js/61.7f5a0117.js"><link rel="prefetch" href="/blog/assets/js/62.107841bb.js"><link rel="prefetch" href="/blog/assets/js/63.e52b96f1.js"><link rel="prefetch" href="/blog/assets/js/64.68cd3b45.js"><link rel="prefetch" href="/blog/assets/js/65.4f8891d2.js"><link rel="prefetch" href="/blog/assets/js/66.d83bdb2e.js"><link rel="prefetch" href="/blog/assets/js/67.56a423d5.js"><link rel="prefetch" href="/blog/assets/js/68.b57a2648.js"><link rel="prefetch" href="/blog/assets/js/69.84ae7ab6.js"><link rel="prefetch" href="/blog/assets/js/7.e9a4f415.js"><link rel="prefetch" href="/blog/assets/js/70.8185c301.js"><link rel="prefetch" href="/blog/assets/js/71.e92a9144.js"><link rel="prefetch" href="/blog/assets/js/72.78fc6941.js"><link rel="prefetch" href="/blog/assets/js/73.ca28169a.js"><link rel="prefetch" href="/blog/assets/js/74.5ba3efb6.js"><link rel="prefetch" href="/blog/assets/js/75.65e4ac58.js"><link rel="prefetch" href="/blog/assets/js/76.19907955.js"><link rel="prefetch" href="/blog/assets/js/77.d93015d9.js"><link rel="prefetch" href="/blog/assets/js/78.011dc4e2.js"><link rel="prefetch" href="/blog/assets/js/79.8204d6d2.js"><link rel="prefetch" href="/blog/assets/js/8.de76593a.js"><link rel="prefetch" href="/blog/assets/js/80.55ae373f.js"><link rel="prefetch" href="/blog/assets/js/81.04f50a1e.js"><link rel="prefetch" href="/blog/assets/js/82.db879ca5.js"><link rel="prefetch" href="/blog/assets/js/83.e89b8863.js"><link rel="prefetch" href="/blog/assets/js/84.07410b58.js"><link rel="prefetch" href="/blog/assets/js/85.d46c8682.js"><link rel="prefetch" href="/blog/assets/js/86.52351591.js"><link rel="prefetch" href="/blog/assets/js/87.c4ebf9a8.js"><link rel="prefetch" href="/blog/assets/js/88.09fc332a.js"><link rel="prefetch" href="/blog/assets/js/89.8b302469.js"><link rel="prefetch" href="/blog/assets/js/9.41767da0.js"><link rel="prefetch" href="/blog/assets/js/90.391f76ed.js"><link rel="prefetch" href="/blog/assets/js/91.b9d1bb73.js"><link rel="prefetch" href="/blog/assets/js/92.a65aa479.js"><link rel="prefetch" href="/blog/assets/js/93.bc850b53.js"><link rel="prefetch" href="/blog/assets/js/94.7dc858d7.js"><link rel="prefetch" href="/blog/assets/js/95.83afadb6.js"><link rel="prefetch" href="/blog/assets/js/96.85084d66.js"><link rel="prefetch" href="/blog/assets/js/97.68a76e8c.js"><link rel="prefetch" href="/blog/assets/js/98.fdb7d67a.js"><link rel="prefetch" href="/blog/assets/js/99.c4b1cfd7.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.bef719fb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">一名GO+PHP工程师</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://gitee.com/ColinWWL/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://gitee.com/ColinWWL/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/blog/系统组件与架构设计/K8S/1kubernetes 概述" class="sidebar-heading clickable open"><span>K8S</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/系统组件与架构设计/K8S/1kubernetes 概述.html" class="sidebar-link">概述</a></li><li><a href="/blog/系统组件与架构设计/K8S/2kubernetes 集群搭建-kubeadm方式 .html" class="sidebar-link">集群搭建(kubeadm 方式)</a></li><li><a href="/blog/系统组件与架构设计/K8S/4kubernetes 集群 YAML 文件详解.html" class="sidebar-link">集群 YAML 文件详解</a></li><li><a href="/blog/系统组件与架构设计/K8S/5kubernetes 集群命令行工具 kubectl.html" class="sidebar-link">集群命令行工具 kubectl</a></li><li><a href="/blog/系统组件与架构设计/K8S/6kubernetes 核心技术-Pod.html" class="sidebar-link">核心技术-Pod</a></li><li><a href="/blog/系统组件与架构设计/K8S/7kubernetes 核心技术-Label.html" class="sidebar-link">核心技术-Label</a></li><li><a href="/blog/系统组件与架构设计/K8S/8kubernetes 核心技术-Controller 控制器.html" class="sidebar-link">核心技术-Controller 控制器</a></li><li><a href="/blog/系统组件与架构设计/K8S/9kubernetes 核心技术-Volume.html" class="sidebar-link">核心技术-Volume</a></li><li><a href="/blog/系统组件与架构设计/K8S/10 kubernetes 核心技术-PVC 和 PV.html" class="sidebar-link">核心技术-PVC 和 PV</a></li><li><a href="/blog/系统组件与架构设计/K8S/11kubernetes 核心技术-Secret.html" class="sidebar-link">核心技术-Secret</a></li><li><a href="/blog/系统组件与架构设计/K8S/12kubernetes 核心技术-configMap.html" class="sidebar-link">核心技术-configMap</a></li><li><a href="/blog/系统组件与架构设计/K8S/13kubernetes 核心技术-Namespace.html" class="sidebar-link">核心技术-Namespace</a></li><li><a href="/blog/系统组件与架构设计/K8S/14kubernetes 核心技术-Service.html" class="sidebar-link">核心技术-Service</a></li><li><a href="/blog/系统组件与架构设计/K8S/18kubernetes 核心技术-探针.html" class="sidebar-link">核心技术-探针</a></li><li><a href="/blog/系统组件与架构设计/K8S/19kubernetes 核心技术-调度器.html" class="sidebar-link">核心技术-调度器</a></li><li><a href="/blog/系统组件与架构设计/K8S/20kubernetes 核心技术-集群安全机制 RBAC.html" class="sidebar-link">核心技术-集群安全机制 RBAC</a></li><li><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html" class="sidebar-link">核心技术-Helm</a></li><li><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html" class="active sidebar-link">高可用集群搭建</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#安装要求" class="sidebar-link">安装要求</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#准备环境" class="sidebar-link">准备环境</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#所有master节点部署keepalived" class="sidebar-link">所有master节点部署keepalived</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#安装相关包和keepalived" class="sidebar-link">安装相关包和keepalived</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#配置master节点" class="sidebar-link">配置master节点</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#启动和检查" class="sidebar-link">启动和检查</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#部署haproxy" class="sidebar-link">部署haproxy</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#配置" class="sidebar-link">配置</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#启动和检查-2" class="sidebar-link">启动和检查</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#所有节点安装docker-kubeadm-kubelet" class="sidebar-link">所有节点安装Docker/kubeadm/kubelet</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#安装docker" class="sidebar-link">安装Docker</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#添加阿里云yum软件源" class="sidebar-link">添加阿里云YUM软件源</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#安装kubeadm-kubelet和kubectl" class="sidebar-link">安装kubeadm，kubelet和kubectl</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#部署kubernetes-master" class="sidebar-link">部署Kubernetes Master</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#创建kubeadm配置文件" class="sidebar-link">创建kubeadm配置文件</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#在master1节点执行" class="sidebar-link">在master1节点执行</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#安装集群网络" class="sidebar-link">安装集群网络</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#master2节点加入集群" class="sidebar-link">master2节点加入集群</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#复制密钥及相关文件" class="sidebar-link">复制密钥及相关文件</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#master2加入集群" class="sidebar-link">master2加入集群</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#" class="sidebar-link"></a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#加入kubernetes-node" class="sidebar-link">加入Kubernetes Node</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#-2" class="sidebar-link"></a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#测试kubernetes集群" class="sidebar-link">测试kubernetes集群</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#部署-nginx-负载均衡器" class="sidebar-link">部署 Nginx 负载均衡器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#安装软件包-主-备" class="sidebar-link">安装软件包（主/备）</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#nginx-配置文件-主-备一样" class="sidebar-link">Nginx 配置文件（主/备一样）</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#keepalived-配置文件-nginx-master" class="sidebar-link">keepalived 配置文件（Nginx Master）</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#检查-nginx-状态脚本" class="sidebar-link">检查 nginx 状态脚本：</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#keepalived-配置文件-nginx-backup" class="sidebar-link">keepalived 配置文件（Nginx Backup）</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#启动并设置开机启动" class="sidebar-link">启动并设置开机启动</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#查看-keepalived-工作状态" class="sidebar-link">查看 keepalived 工作状态</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#nginx-keepalived-高可用测试" class="sidebar-link">Nginx+Keepalived 高可用测试</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#访问负载均衡器测试" class="sidebar-link">访问负载均衡器测试</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html#修改所有-worker-node-连接-lb-vip" class="sidebar-link">修改所有 Worker Node 连接 LB VIP</a></li></ul></li></ul></li><li><a href="/blog/系统组件与架构设计/K8S/24kubernetes 部署项目.html" class="sidebar-link">部署项目</a></li><li><a href="/blog/系统组件与架构设计/K8S/25kubernetes-部署性能监控平台.html" class="sidebar-link">部署性能监控平台</a></li><li><a href="/blog/系统组件与架构设计/K8S/Web界面Dashboard.html" class="sidebar-link">Web界面Dashboard</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="高可用集群搭建"><a href="#高可用集群搭建" class="header-anchor">#</a> 高可用集群搭建</h1> <p>kubeadm是官方社区推出的一个用于快速部署kubernetes集群的工具。</p> <p>这个工具能通过两条指令完成一个kubernetes集群的部署：</p> <div class="language- extra-class"><pre class="language-text"><code>
# 创建一个 Master 节点
$ kubeadm init

# 将一个 Node 节点加入到当前集群中
$ kubeadm join &lt;Master节点的IP和端口 &gt;
</code></pre></div><h2 id="安装要求"><a href="#安装要求" class="header-anchor">#</a> 安装要求</h2> <p>在开始之前，部署Kubernetes集群机器需要满足以下几个条件：</p> <ul><li>一台或多台机器，操作系统 CentOS7.x-86_x64</li> <li>硬件配置：2GB或更多RAM，2个CPU或更多CPU，硬盘30GB或更多</li> <li>可以访问外网，需要拉取镜像，如果服务器不能上网，需要提前下载镜像并导入节点</li> <li>禁止swap分区</li></ul> <h2 id="准备环境"><a href="#准备环境" class="header-anchor">#</a> 准备环境</h2> <table><thead><tr><th>角色</th> <th>IP</th></tr></thead> <tbody><tr><td>master1</td> <td>192.168.44.155</td></tr> <tr><td>master2</td> <td>192.168.44.156</td></tr> <tr><td>node1</td> <td>192.168.44.157</td></tr> <tr><td>VIP（虚拟ip）</td> <td>192.168.44.158</td></tr></tbody></table> <div class="language- extra-class"><pre class="language-text"><code>
# 关闭防火墙
systemctl stop firewalld
systemctl disable firewalld

# 关闭selinux
sed -i 's/enforcing/disabled/' /etc/selinux/config  # 永久
setenforce 0  # 临时

# 关闭swap
swapoff -a  # 临时
sed -ri 's/.*swap.*/#&amp;/' /etc/fstab    # 永久

# 根据规划设置主机名
hostnamectl set-hostname &lt;hostname&gt;

# 在master添加hosts
cat &gt;&gt; /etc/hosts &lt;&lt; EOF
192.168.44.158    master.k8s.io   k8s-vip
192.168.44.155    master01.k8s.io master1
192.168.44.156    master02.k8s.io master2
192.168.44.157    node01.k8s.io   node1
EOF

# 将桥接的IPv4流量传递到iptables的链
cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sysctl --system  # 生效

# 时间同步
yum install ntpdate -y
ntpdate time.windows.com
</code></pre></div><h2 id="所有master节点部署keepalived"><a href="#所有master节点部署keepalived" class="header-anchor">#</a> 所有master节点部署keepalived</h2> <h3 id="安装相关包和keepalived"><a href="#安装相关包和keepalived" class="header-anchor">#</a> 安装相关包和keepalived</h3> <div class="language- extra-class"><pre class="language-text"><code>
yum install -y conntrack-tools libseccomp libtool-ltdl

yum install -y keepalived
</code></pre></div><h3 id="配置master节点"><a href="#配置master节点" class="header-anchor">#</a> 配置master节点</h3> <p>master1节点配置</p> <div class="language- extra-class"><pre class="language-text"><code>
cat &gt; /etc/keepalived/keepalived.conf &lt;&lt;EOF 
! Configuration File for keepalived

global_defs {
   router_id k8s
}

vrrp_script check_haproxy {
    script &quot;killall -0 haproxy&quot;
    interval 3
    weight -2
    fall 10
    rise 2
}

vrrp_instance VI_1 {
    state MASTER 
    interface ens33 
    virtual_router_id 51
    priority 250
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass ceb1b3ec013d66163d6ab
    }
    virtual_ipaddress {
        192.168.44.158
    }
    track_script {
        check_haproxy
    }

}
EOF
</code></pre></div><p>master2节点配置</p> <div class="language- extra-class"><pre class="language-text"><code>
cat &gt; /etc/keepalived/keepalived.conf &lt;&lt;EOF 
! Configuration File for keepalived

global_defs {
   router_id k8s
}

vrrp_script check_haproxy {
    script &quot;killall -0 haproxy&quot;
    interval 3
    weight -2
    fall 10
    rise 2
}

vrrp_instance VI_1 {
    state BACKUP 
    interface ens33 
    virtual_router_id 51
    priority 200
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass ceb1b3ec013d66163d6ab
    }
    virtual_ipaddress {
        192.168.44.158
    }
    track_script {
        check_haproxy
    }

}
EOF
</code></pre></div><h3 id="启动和检查"><a href="#启动和检查" class="header-anchor">#</a> 启动和检查</h3> <p>在两台master节点都执行</p> <div class="language- extra-class"><pre class="language-text"><code>
# 启动keepalived
$ systemctl start keepalived.service
设置开机启动
$ systemctl enable keepalived.service
# 查看启动状态
$ systemctl status keepalived.service
</code></pre></div><p>启动后查看master1的网卡信息</p> <div class="language- extra-class"><pre class="language-text"><code>
ip a s ens33
</code></pre></div><h2 id="部署haproxy"><a href="#部署haproxy" class="header-anchor">#</a> 部署haproxy</h2> <h3 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h3> <div class="language- extra-class"><pre class="language-text"><code>
yum install -y haproxy
</code></pre></div><h3 id="配置"><a href="#配置" class="header-anchor">#</a> 配置</h3> <p>两台master节点的配置均相同，配置中声明了后端代理的两个master节点服务器，指定了haproxy运行的端口为16443等，因此16443端口为集群的入口</p> <div class="language- extra-class"><pre class="language-text"><code>
cat &gt; /etc/haproxy/haproxy.cfg &lt;&lt; EOF
#---------------------------------------------------------------------
# Global settings
#---------------------------------------------------------------------
global
    # to have these messages end up in /var/log/haproxy.log you will
    # need to:
    # 1) configure syslog to accept network log events.  This is done
    #    by adding the '-r' option to the SYSLOGD_OPTIONS in
    #    /etc/sysconfig/syslog
    # 2) configure local2 events to go to the /var/log/haproxy.log
    #   file. A line like the following can be added to
    #   /etc/sysconfig/syslog
    #
    #    local2.*                       /var/log/haproxy.log
    #
    log         127.0.0.1 local2
    
    chroot      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     4000
    user        haproxy
    group       haproxy
    daemon 
       
    # turn on stats unix socket
    stats socket /var/lib/haproxy/stats
#---------------------------------------------------------------------
# common defaults that all the 'listen' and 'backend' sections will
# use if not designated in their block
#---------------------------------------------------------------------  
defaults
    mode                    http
    log                     global
    option                  httplog
    option                  dontlognull
    option http-server-close
    option forwardfor       except 127.0.0.0/8
    option                  redispatch
    retries                 3
    timeout http-request    10s
    timeout queue           1m
    timeout connect         10s
    timeout client          1m
    timeout server          1m
    timeout http-keep-alive 10s
    timeout check           10s
    maxconn                 3000
#---------------------------------------------------------------------
# kubernetes apiserver frontend which proxys to the backends
#--------------------------------------------------------------------- 
frontend kubernetes-apiserver
    mode                 tcp
    bind                 *:16443
    option               tcplog
    default_backend      kubernetes-apiserver    
#---------------------------------------------------------------------
# round robin balancing between the various backends
#---------------------------------------------------------------------
backend kubernetes-apiserver
    mode        tcp
    balance     roundrobin
    server      master01.k8s.io   192.168.44.155:6443 check
    server      master02.k8s.io   192.168.44.156:6443 check
#---------------------------------------------------------------------
# collection haproxy statistics message
#---------------------------------------------------------------------
listen stats
    bind                 *:1080
    stats auth           admin:awesomePassword
    stats refresh        5s
    stats realm          HAProxy\ Statistics
    stats uri            /admin?stats
EOF
</code></pre></div><h3 id="启动和检查-2"><a href="#启动和检查-2" class="header-anchor">#</a> 启动和检查</h3> <p>两台master都启动</p> <div class="language- extra-class"><pre class="language-text"><code>
# 设置开机启动
$ systemctl enable haproxy
# 开启haproxy
$ systemctl start haproxy
# 查看启动状态
$ systemctl status haproxy
</code></pre></div><p>检查端口</p> <div class="language- extra-class"><pre class="language-text"><code>
netstat -lntup|grep haproxy
</code></pre></div><h2 id="所有节点安装docker-kubeadm-kubelet"><a href="#所有节点安装docker-kubeadm-kubelet" class="header-anchor">#</a> 所有节点安装Docker/kubeadm/kubelet</h2> <p>Kubernetes默认CRI（容器运行时）为Docker，因此先安装Docker。</p> <h3 id="安装docker"><a href="#安装docker" class="header-anchor">#</a> 安装Docker</h3> <div class="language- extra-class"><pre class="language-text"><code>
$ wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo
$ yum -y install docker-ce-18.06.1.ce-3.el7
$ systemctl enable docker &amp;&amp; systemctl start docker
$ docker --version
Docker version 18.06.1-ce, build e68fc7a
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>
$ cat &gt; /etc/docker/daemon.json &lt;&lt; EOF
{
  &quot;registry-mirrors&quot;: [&quot;https://b9pmyelo.mirror.aliyuncs.com&quot;]
}
EOF
</code></pre></div><h3 id="添加阿里云yum软件源"><a href="#添加阿里云yum软件源" class="header-anchor">#</a> 添加阿里云YUM软件源</h3> <div class="language- extra-class"><pre class="language-text"><code>
$ cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
</code></pre></div><h3 id="安装kubeadm-kubelet和kubectl"><a href="#安装kubeadm-kubelet和kubectl" class="header-anchor">#</a> 安装kubeadm，kubelet和kubectl</h3> <p>由于版本更新频繁，这里指定版本号部署：</p> <div class="language- extra-class"><pre class="language-text"><code>
$ yum install -y kubelet-1.16.3 kubeadm-1.16.3 kubectl-1.16.3
$ systemctl enable kubelet
</code></pre></div><h2 id="部署kubernetes-master"><a href="#部署kubernetes-master" class="header-anchor">#</a> 部署Kubernetes Master</h2> <h3 id="创建kubeadm配置文件"><a href="#创建kubeadm配置文件" class="header-anchor">#</a> 创建kubeadm配置文件</h3> <p>在具有vip的master上操作，这里为master1</p> <div class="language- extra-class"><pre class="language-text"><code>
$ mkdir /usr/local/kubernetes/manifests -p

$ cd /usr/local/kubernetes/manifests/

$ vi kubeadm-config.yaml

apiServer:
  certSANs:

    - master1
    - master2
    - master.k8s.io
    - 192.168.44.158
    - 192.168.44.155
    - 192.168.44.156
    - 127.0.0.1

  extraArgs:
    authorization-mode: Node,RBAC
  timeoutForControlPlane: 4m0s
apiVersion: kubeadm.k8s.io/v1beta1
certificatesDir: /etc/kubernetes/pki
clusterName: kubernetes
controlPlaneEndpoint: &quot;master.k8s.io:16443&quot;
controllerManager: {}
dns: 
  type: CoreDNS
etcd:
  local:    
    dataDir: /var/lib/etcd
imageRepository: registry.aliyuncs.com/google_containers
kind: ClusterConfiguration
kubernetesVersion: v1.16.3
networking: 
  dnsDomain: cluster.local  
  podSubnet: 10.244.0.0/16
  serviceSubnet: 10.1.0.0/16
scheduler: {}
</code></pre></div><h3 id="在master1节点执行"><a href="#在master1节点执行" class="header-anchor">#</a> 在master1节点执行</h3> <div class="language- extra-class"><pre class="language-text"><code>
$ kubeadm init --config kubeadm-config.yaml
</code></pre></div><p>按照提示配置环境变量，使用kubectl工具：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
<span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config
$ kubectl get nodes
$ kubectl get pods -n kube-system
</code></pre></div><p><strong>按照提示保存以下内容，一会要使用：</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubeadm <span class="token function">join</span> master.k8s.io:16443 --token jv5z7n.3y1zi95p952y9p65 <span class="token punctuation">\</span>
    --discovery-token-ca-cert-hash sha256:403bca185c2f3a4791685013499e7ce58f9848e2213e27194b75a2e3293d8812 <span class="token punctuation">\</span>
    --control-plane 
</code></pre></div><p>查看集群状态</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl get cs

kubectl get pods -n kube-system
</code></pre></div><h2 id="安装集群网络"><a href="#安装集群网络" class="header-anchor">#</a> 安装集群网络</h2> <p>从官方地址获取到flannel的yaml，在master1上执行</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">mkdir</span> flannel
<span class="token builtin class-name">cd</span> flannel
<span class="token function">wget</span> -c https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</code></pre></div><p>安装flannel网络</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl apply -f kube-flannel.yml 
</code></pre></div><p>检查</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl get pods -n kube-system
</code></pre></div><h2 id="master2节点加入集群"><a href="#master2节点加入集群" class="header-anchor">#</a> master2节点加入集群</h2> <h3 id="复制密钥及相关文件"><a href="#复制密钥及相关文件" class="header-anchor">#</a> 复制密钥及相关文件</h3> <p>从master1复制密钥及相关文件到master2</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># ssh root@192.168.44.156 mkdir -p /etc/kubernetes/pki/etcd</span>

<span class="token comment"># scp /etc/kubernetes/admin.conf root@192.168.44.156:/etc/kubernetes</span>
   
<span class="token comment"># scp /etc/kubernetes/pki/{ca.*,sa.*,front-proxy-ca.*} root@192.168.44.156:/etc/kubernetes/pki</span>
   
<span class="token comment"># scp /etc/kubernetes/pki/etcd/ca.* root@192.168.44.156:/etc/kubernetes/pki/etcd</span>
</code></pre></div><h3 id="master2加入集群"><a href="#master2加入集群" class="header-anchor">#</a> master2加入集群</h3> <p>执行在master1上init后输出的join命令, 需要带上参数 <code>--control-plane</code> 表示把master控制节点加入集群</p> <div class="language- extra-class"><pre class="language-text"><code>
kubeadm join master.k8s.io:16443 --token ckf7bs.30576l0okocepg8b     --discovery-token-ca-cert-hash sha256:19afac8b11182f61073e254fb57b9f19ab4d798b70501036fc69ebef46094aba --control-plane
</code></pre></div><p>检查状态</p> <div class="language- extra-class"><pre class="language-text"><code>
kubectl get node

kubectl get pods --all-namespaces
</code></pre></div><h2 id=""><a href="#" class="header-anchor">#</a></h2> <h2 id="加入kubernetes-node"><a href="#加入kubernetes-node" class="header-anchor">#</a> 加入Kubernetes Node</h2> <p>在node1上执行</p> <p>向集群添加新节点，执行在kubeadm init输出的kubeadm join命令：</p> <div class="language- extra-class"><pre class="language-text"><code>
kubeadm join master.k8s.io:16443 --token ckf7bs.30576l0okocepg8b     --discovery-token-ca-cert-hash sha256:19afac8b11182f61073e254fb57b9f19ab4d798b70501036fc69ebef46094aba
</code></pre></div><p><strong>集群网络重新安装，因为添加了新的node节点</strong></p> <p>检查状态</p> <div class="language- extra-class"><pre class="language-text"><code>
kubectl get node

kubectl get pods --all-namespaces
</code></pre></div><h2 id="-2"><a href="#-2" class="header-anchor">#</a></h2> <h2 id="测试kubernetes集群"><a href="#测试kubernetes集群" class="header-anchor">#</a> 测试kubernetes集群</h2> <p>在Kubernetes集群中创建一个pod，验证是否正常运行：</p> <div class="language- extra-class"><pre class="language-text"><code>
$ kubectl create deployment nginx --image=nginx
$ kubectl expose deployment nginx --port=80 --type=NodePort
$ kubectl get pod,svc
</code></pre></div><p>访问地址：http://NodeIP: Port</p> <h2 id="部署-nginx-负载均衡器"><a href="#部署-nginx-负载均衡器" class="header-anchor">#</a> 部署 Nginx 负载均衡器</h2> <ul><li>kube-apiserver 高可用架构图：</li> <li>涉及软件：</li></ul> <p>Keepalived 是一个主流高可用软件，基于 VIP 绑定实现服务器双机热备，在上述拓扑中，Keepalived 主要根据 Nginx 运行状态判断是否需要故障转移（偏移 VIP），例如当 Nginx主节点挂掉，VIP 会自动绑定在 Nginx 备节点，从而保证 VIP 一直可用，实现 Nginx 高可用。<br>
Nginx 是一个主流 Web 服务和反向代理服务器，这里用四层实现对 apiserver 实现负载均<br>
衡。</p> <h3 id="安装软件包-主-备"><a href="#安装软件包-主-备" class="header-anchor">#</a> 安装软件包（主/备）</h3> <h3 id="nginx-配置文件-主-备一样"><a href="#nginx-配置文件-主-备一样" class="header-anchor">#</a> Nginx 配置文件（主/备一样）</h3> <h3 id="keepalived-配置文件-nginx-master"><a href="#keepalived-配置文件-nginx-master" class="header-anchor">#</a> keepalived 配置文件（Nginx Master）</h3> <p>vrrp_script：指定检查 nginx 工作状态脚本（根据 nginx 状态判断是否故障转移）<br>
virtual_ipaddress：虚拟 IP（VIP）</p> <h3 id="检查-nginx-状态脚本"><a href="#检查-nginx-状态脚本" class="header-anchor">#</a> 检查 nginx 状态脚本：</h3> <h3 id="keepalived-配置文件-nginx-backup"><a href="#keepalived-配置文件-nginx-backup" class="header-anchor">#</a> keepalived 配置文件（Nginx Backup）</h3> <p>上述配置文件中检查 nginx 运行状态脚本：<br>
注：keepalived 根据脚本返回状态码（0 为工作正常，非 0 不正常）判断是否故障转移。</p> <h3 id="启动并设置开机启动"><a href="#启动并设置开机启动" class="header-anchor">#</a> 启动并设置开机启动</h3> <h3 id="查看-keepalived-工作状态"><a href="#查看-keepalived-工作状态" class="header-anchor">#</a> 查看 keepalived 工作状态</h3> <p>可以看到，在 ens33 网卡绑定了 192.168.31.88 虚拟 IP，说明工作正常。</p> <h3 id="nginx-keepalived-高可用测试"><a href="#nginx-keepalived-高可用测试" class="header-anchor">#</a> Nginx+Keepalived 高可用测试</h3> <p>关闭主节点 Nginx，测试 VIP 是否漂移到备节点服务器。<br>
在 Nginx Master 执行 pkill nginx<br>
在 Nginx Backup，ip addr 命令查看已成功绑定 VIP。</p> <h3 id="访问负载均衡器测试"><a href="#访问负载均衡器测试" class="header-anchor">#</a> 访问负载均衡器测试</h3> <p>找 K8s 集群中任意一个节点，使用 curl 查看 K8s 版本测试，使用 VIP 访问：<br>
可以正确获取到 K8s 版本信息，说明负载均衡器搭建正常。该请求数据流程：curl -&gt; vip(nginx) -&gt; apiserver<br>
通过查看 Nginx 日志也可以看到转发 apiserver IP：</p> <h3 id="修改所有-worker-node-连接-lb-vip"><a href="#修改所有-worker-node-连接-lb-vip" class="header-anchor">#</a> 修改所有 Worker Node 连接 LB VIP</h3> <p>试想下，虽然我们增加了 Master2 和负载均衡器，但是我们是从单 Master 架构扩容的，也<br>
就是说目前所有的 Node 组件连接都还是 Master1，如果不改为连接 VIP 走负载均衡器，那<br>
么 Master 还是单点故障。<br>
因此接下来就是要改所有 Node 组件配置文件中的连接 apiserver IP：<br>
也就是通过 kubectl get node 命令查看到的节点。<br>
在上述所有 Worker Node 执行：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>yum <span class="token function">install</span> epel-release -y
yum <span class="token function">install</span> nginx keepalived -y
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/nginx/nginx.conf <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;EOF&quot;
user nginx; 
worker_processes auto; 
error_log /var/log/nginx/error.log; 
pid /run/nginx.pid; 
include /usr/share/nginx/modules/*.conf; 
events {
worker_connections 1024; 
}

# 四层负载均衡，为两台 Master apiserver 组件提供负载均衡

stream {
log_format main '$remote_addr $upstream_addr - [$time_local] $status
$upstream_bytes_sent'; 
access_log /var/log/nginx/k8s-access.log main; 
upstream k8s-apiserver {
server 192.168.31.71:6443; # Master1 APISERVER IP: PORT
server 192.168.31.74:6443; # Master2 APISERVER IP: PORT
}
server {
listen 6443; 
proxy_pass k8s-apiserver; 
}
}
http {
log_format main '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '
'$status $body_bytes_sent &quot;$http_referer&quot; '
'&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;'; 
access_log /var/log/nginx/access.log main; 
sendfile on; 
tcp_nopush on; 
tcp_nodelay on; 
keepalive_timeout 65; 
types_hash_max_size 2048; 
include /etc/nginx/mime.types; 
default_type application/octet-stream; 
server {
listen 80 default_server; 
server_name _; 
location / {
}
}
}
EOF</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/keepalived/keepalived.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
global_defs {
notification_email {
acassen@firewall.loc
failover@firewall.loc
sysadmin@firewall.loc
}
notification_email_from Alexandre. Cassen@firewall.loc
smtp_server 127.0.0.1
smtp_connect_timeout 30
router_id NGINX_MASTER
}
vrrp_script check_nginx {
script &quot;/etc/keepalived/check_nginx.sh&quot;
}
vrrp_instance VI_1 {
state MASTER
interface ens33
virtual_router_id 51 # VRRP 路由 ID 实例，每个实例是唯一的
priority 100 # 优先级，备服务器设置 90
advert_int 1 # 指定 VRRP 心跳包通告间隔时间，默认 1 秒
authentication {
auth_type PASS
auth_pass 1111
}

# 虚拟 IP

virtual_ipaddress {
192.168.31.88/24
}
track_script {
check_nginx
}
}
EOF</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span>/etc/keepalived/check_nginx.sh <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;EOF&quot;
#!/bin/bash
count=$(ps -ef |grep nginx |egrep -cv &quot;grep|$$&quot;)
if [ &quot;$count&quot; -eq 0 ]; then
exit 1
else
exit 0
fi
EOF</span>
<span class="token function">chmod</span> +x /etc/keepalived/check_nginx.sh
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/keepalived/keepalived.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
global_defs {
notification_email {
acassen@firewall.loc
failover@firewall.loc
sysadmin@firewall.loc
}
notification_email_from Alexandre. Cassen@firewall.loc
smtp_server 127.0.0.1
smtp_connect_timeout 30
router_id NGINX_BACKUP
}
vrrp_script check_nginx {
script &quot;/etc/keepalived/check_nginx.sh&quot;
}
vrrp_instance VI_1 {
state BACKUP
interface ens33
virtual_router_id 51 # VRRP 路由 ID 实例，每个实例是唯一的
priority 90
advert_int 1
authentication {
auth_type PASS
auth_pass 1111
}
virtual_ipaddress {
192.168.31.88/24
}
track_script {
check_nginx
}
}
EOF</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span>/etc/keepalived/check_nginx.sh <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;EOF&quot;
#!/bin/bash
count=$(ps -ef |grep nginx |egrep -cv &quot;grep|$$&quot;)
if [ &quot;$count&quot; -eq 0 ]; then
exit 1
else
exit 0
fi
EOF</span>
<span class="token function">chmod</span> +x /etc/keepalived/check_nginx.sh
systemctl daemon-reload
systemctl start nginx
systemctl start keepalived
systemctl <span class="token builtin class-name">enable</span> nginx
systemctl <span class="token builtin class-name">enable</span> keepalived
<span class="token function">ip</span> a
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK, UP, LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN group
default qlen <span class="token number">1000</span>
link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
valid_lft forever preferred_lft forever
inet6 ::1/128 scope <span class="token function">host</span>
valid_lft forever preferred_lft forever
<span class="token number">2</span>: ens33: <span class="token operator">&lt;</span>BROADCAST, MULTICAST, UP, LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc pfifo_fast state UP
group default qlen <span class="token number">1000</span>
link/ether 00:0c:29:04:f7:2c brd ff:ff:ff:ff:ff:ff
inet <span class="token number">192.168</span>.31.80/24 brd <span class="token number">192.168</span>.31.255 scope global noprefixroute ens33
valid_lft forever preferred_lft forever
inet <span class="token number">192.168</span>.31.88/24 scope global secondary ens33
valid_lft forever preferred_lft forever
inet6 fe80::20c:29ff:fe04:f72c/64 scope <span class="token function">link</span>
valid_lft forever preferred_lft forever
<span class="token function">curl</span> -k https://192.168.31.88:6443/version
<span class="token punctuation">{</span>
<span class="token string">&quot;major&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>, 
<span class="token string">&quot;minor&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;18&quot;</span>, 
<span class="token string">&quot;gitVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;v1.18.3&quot;</span>, 
<span class="token string">&quot;gitCommit&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2e7996e3e2712684bc73f0dec0200d64eec7fe40&quot;</span>, 
<span class="token string">&quot;gitTreeState&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;clean&quot;</span>, 
<span class="token string">&quot;buildDate&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2020-05-20T12:43:34Z&quot;</span>, 
<span class="token string">&quot;goVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;go1.13.9&quot;</span>, 
<span class="token string">&quot;compiler&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;gc&quot;</span>, 
<span class="token string">&quot;platform&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;linux/amd64&quot;</span>
<span class="token punctuation">}</span>
<span class="token function">tail</span> /var/log/nginx/k8s-access.log -f
<span class="token number">192.168</span>.31.81 <span class="token number">192.168</span>.31.71:6443 - <span class="token punctuation">[</span><span class="token number">30</span>/May/2020:11:15:10 +0800<span class="token punctuation">]</span> <span class="token number">200</span> <span class="token number">422</span>
<span class="token number">192.168</span>.31.81 <span class="token number">192.168</span>.31.74:6443 - <span class="token punctuation">[</span><span class="token number">30</span>/May/2020:11:15:26 +0800<span class="token punctuation">]</span> <span class="token number">200</span> <span class="token number">422</span>
角色
IP
k8s-master1
<span class="token number">192.168</span>.31.71
k8s-master2
<span class="token number">192.168</span>.31.74
k8s-node1
<span class="token number">192.168</span>.31.72
k8s-node2
<span class="token number">192.168</span>.31.73
<span class="token function">sed</span> -i <span class="token string">'s#192.168.31.71:6443#192.168.31.88:6443#'</span> /opt/kubernetes/cfg/*
systemctl restart kubelet
systemctl restart kube-proxy
kubectl get node
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/21/2021, 1:25:38 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html" class="prev">
        核心技术-Helm
      </a></span> <span class="next"><a href="/blog/系统组件与架构设计/K8S/24kubernetes 部署项目.html">
        部署项目
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.77332b34.js" defer></script><script src="/blog/assets/js/3.21e2e031.js" defer></script><script src="/blog/assets/js/169.64dd7e3e.js" defer></script>
  </body>
</html>
