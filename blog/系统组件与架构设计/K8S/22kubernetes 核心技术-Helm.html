<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>核心技术-Helm | 一名GO+PHP工程师</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/blog/assets/css/0.styles.b3aba94c.css" as="style"><link rel="preload" href="/blog/assets/js/app.d06cb661.js" as="script"><link rel="preload" href="/blog/assets/js/3.21e2e031.js" as="script"><link rel="preload" href="/blog/assets/js/48.e3917371.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.0db5da5f.js"><link rel="prefetch" href="/blog/assets/js/100.0ab1f3ab.js"><link rel="prefetch" href="/blog/assets/js/101.a8ccfd88.js"><link rel="prefetch" href="/blog/assets/js/102.0efc78d7.js"><link rel="prefetch" href="/blog/assets/js/103.adbd37a7.js"><link rel="prefetch" href="/blog/assets/js/104.161b590d.js"><link rel="prefetch" href="/blog/assets/js/105.eaae1ece.js"><link rel="prefetch" href="/blog/assets/js/106.9b961ba0.js"><link rel="prefetch" href="/blog/assets/js/107.df9ba599.js"><link rel="prefetch" href="/blog/assets/js/108.a5880443.js"><link rel="prefetch" href="/blog/assets/js/109.0dca298c.js"><link rel="prefetch" href="/blog/assets/js/11.896719ab.js"><link rel="prefetch" href="/blog/assets/js/110.91c6d5de.js"><link rel="prefetch" href="/blog/assets/js/111.4db6087d.js"><link rel="prefetch" href="/blog/assets/js/112.bb76db96.js"><link rel="prefetch" href="/blog/assets/js/113.9b314292.js"><link rel="prefetch" href="/blog/assets/js/114.b05dc902.js"><link rel="prefetch" href="/blog/assets/js/115.6a21a21a.js"><link rel="prefetch" href="/blog/assets/js/116.1fd8cdf3.js"><link rel="prefetch" href="/blog/assets/js/117.193b54e8.js"><link rel="prefetch" href="/blog/assets/js/118.d91f7ec2.js"><link rel="prefetch" href="/blog/assets/js/119.857d484f.js"><link rel="prefetch" href="/blog/assets/js/12.31b18145.js"><link rel="prefetch" href="/blog/assets/js/120.c2fc1bab.js"><link rel="prefetch" href="/blog/assets/js/121.5bda4d33.js"><link rel="prefetch" href="/blog/assets/js/122.af2613ff.js"><link rel="prefetch" href="/blog/assets/js/123.b7cb0f42.js"><link rel="prefetch" href="/blog/assets/js/124.c284df07.js"><link rel="prefetch" href="/blog/assets/js/125.8bba790f.js"><link rel="prefetch" href="/blog/assets/js/126.93757c80.js"><link rel="prefetch" href="/blog/assets/js/127.7e5150c1.js"><link rel="prefetch" href="/blog/assets/js/128.3498b329.js"><link rel="prefetch" href="/blog/assets/js/129.18a4e993.js"><link rel="prefetch" href="/blog/assets/js/13.b861bbee.js"><link rel="prefetch" href="/blog/assets/js/130.66047656.js"><link rel="prefetch" href="/blog/assets/js/131.0490c1bf.js"><link rel="prefetch" href="/blog/assets/js/132.9fd5bbe5.js"><link rel="prefetch" href="/blog/assets/js/133.d3b9807e.js"><link rel="prefetch" href="/blog/assets/js/134.6a6cf86d.js"><link rel="prefetch" href="/blog/assets/js/135.1132a9d3.js"><link rel="prefetch" href="/blog/assets/js/136.41c7a62b.js"><link rel="prefetch" href="/blog/assets/js/137.50106a44.js"><link rel="prefetch" href="/blog/assets/js/138.87124965.js"><link rel="prefetch" href="/blog/assets/js/139.e5597dd8.js"><link rel="prefetch" href="/blog/assets/js/14.507ab95b.js"><link rel="prefetch" href="/blog/assets/js/140.88de4f35.js"><link rel="prefetch" href="/blog/assets/js/141.85f894e1.js"><link rel="prefetch" href="/blog/assets/js/142.e385a422.js"><link rel="prefetch" href="/blog/assets/js/143.002698c9.js"><link rel="prefetch" href="/blog/assets/js/144.d9a69e4f.js"><link rel="prefetch" href="/blog/assets/js/145.95b58ec4.js"><link rel="prefetch" href="/blog/assets/js/146.0ff38d15.js"><link rel="prefetch" href="/blog/assets/js/147.1aad7186.js"><link rel="prefetch" href="/blog/assets/js/148.f24cd187.js"><link rel="prefetch" href="/blog/assets/js/149.0941e789.js"><link rel="prefetch" href="/blog/assets/js/15.977c5e43.js"><link rel="prefetch" href="/blog/assets/js/150.6514db42.js"><link rel="prefetch" href="/blog/assets/js/151.dcf981a0.js"><link rel="prefetch" href="/blog/assets/js/152.6a733b47.js"><link rel="prefetch" href="/blog/assets/js/153.5c3f3c49.js"><link rel="prefetch" href="/blog/assets/js/154.416cc51a.js"><link rel="prefetch" href="/blog/assets/js/155.ed89ea70.js"><link rel="prefetch" href="/blog/assets/js/156.e514afd4.js"><link rel="prefetch" href="/blog/assets/js/157.c01cdccb.js"><link rel="prefetch" href="/blog/assets/js/158.71dda3a8.js"><link rel="prefetch" href="/blog/assets/js/159.33fa138a.js"><link rel="prefetch" href="/blog/assets/js/16.6fa11a53.js"><link rel="prefetch" href="/blog/assets/js/160.41012461.js"><link rel="prefetch" href="/blog/assets/js/161.70993729.js"><link rel="prefetch" href="/blog/assets/js/162.a36e72f7.js"><link rel="prefetch" href="/blog/assets/js/163.35e7409e.js"><link rel="prefetch" href="/blog/assets/js/164.14f9bf58.js"><link rel="prefetch" href="/blog/assets/js/165.d4170a5d.js"><link rel="prefetch" href="/blog/assets/js/166.8eb8df1e.js"><link rel="prefetch" href="/blog/assets/js/167.b4296d08.js"><link rel="prefetch" href="/blog/assets/js/168.03f7c431.js"><link rel="prefetch" href="/blog/assets/js/169.2b833606.js"><link rel="prefetch" href="/blog/assets/js/17.02da0577.js"><link rel="prefetch" href="/blog/assets/js/170.b4639eea.js"><link rel="prefetch" href="/blog/assets/js/171.58868926.js"><link rel="prefetch" href="/blog/assets/js/172.253bc96e.js"><link rel="prefetch" href="/blog/assets/js/173.3ad021fe.js"><link rel="prefetch" href="/blog/assets/js/174.849bcbbd.js"><link rel="prefetch" href="/blog/assets/js/175.29aea4e3.js"><link rel="prefetch" href="/blog/assets/js/176.6e26a58e.js"><link rel="prefetch" href="/blog/assets/js/177.fb85b7c2.js"><link rel="prefetch" href="/blog/assets/js/178.7f4bf5e6.js"><link rel="prefetch" href="/blog/assets/js/18.c814f6a6.js"><link rel="prefetch" href="/blog/assets/js/19.931178d2.js"><link rel="prefetch" href="/blog/assets/js/2.aec18661.js"><link rel="prefetch" href="/blog/assets/js/20.94381428.js"><link rel="prefetch" href="/blog/assets/js/21.27a6dcf4.js"><link rel="prefetch" href="/blog/assets/js/22.d9c7ba8d.js"><link rel="prefetch" href="/blog/assets/js/23.00b0c454.js"><link rel="prefetch" href="/blog/assets/js/24.5f5891aa.js"><link rel="prefetch" href="/blog/assets/js/25.87af5ecb.js"><link rel="prefetch" href="/blog/assets/js/26.ba71a98d.js"><link rel="prefetch" href="/blog/assets/js/27.3b1f36b4.js"><link rel="prefetch" href="/blog/assets/js/28.26227207.js"><link rel="prefetch" href="/blog/assets/js/29.98c46495.js"><link rel="prefetch" href="/blog/assets/js/30.47d3f732.js"><link rel="prefetch" href="/blog/assets/js/31.c8b903eb.js"><link rel="prefetch" href="/blog/assets/js/32.763b7b98.js"><link rel="prefetch" href="/blog/assets/js/33.a689a6fc.js"><link rel="prefetch" href="/blog/assets/js/34.1089c1c5.js"><link rel="prefetch" href="/blog/assets/js/35.86d13f87.js"><link rel="prefetch" href="/blog/assets/js/36.77d3c045.js"><link rel="prefetch" href="/blog/assets/js/37.6c8b6e4d.js"><link rel="prefetch" href="/blog/assets/js/38.434945a5.js"><link rel="prefetch" href="/blog/assets/js/39.0324fbbf.js"><link rel="prefetch" href="/blog/assets/js/4.3e9c545c.js"><link rel="prefetch" href="/blog/assets/js/40.f3ba0aed.js"><link rel="prefetch" href="/blog/assets/js/41.27044d8f.js"><link rel="prefetch" href="/blog/assets/js/42.1fd5a43b.js"><link rel="prefetch" href="/blog/assets/js/43.451622f4.js"><link rel="prefetch" href="/blog/assets/js/44.5b40696f.js"><link rel="prefetch" href="/blog/assets/js/45.3dcc7c91.js"><link rel="prefetch" href="/blog/assets/js/46.0bd04509.js"><link rel="prefetch" href="/blog/assets/js/47.59ab9778.js"><link rel="prefetch" href="/blog/assets/js/49.cffe09bd.js"><link rel="prefetch" href="/blog/assets/js/5.548a74f6.js"><link rel="prefetch" href="/blog/assets/js/50.10849ea7.js"><link rel="prefetch" href="/blog/assets/js/51.29fb5c68.js"><link rel="prefetch" href="/blog/assets/js/52.d2042f8d.js"><link rel="prefetch" href="/blog/assets/js/53.8a5c3d60.js"><link rel="prefetch" href="/blog/assets/js/54.0f846846.js"><link rel="prefetch" href="/blog/assets/js/55.f1fdd6ae.js"><link rel="prefetch" href="/blog/assets/js/56.c2bf89f1.js"><link rel="prefetch" href="/blog/assets/js/57.93329ad3.js"><link rel="prefetch" href="/blog/assets/js/58.ddd651ef.js"><link rel="prefetch" href="/blog/assets/js/59.ad2296e2.js"><link rel="prefetch" href="/blog/assets/js/6.c31c16f8.js"><link rel="prefetch" href="/blog/assets/js/60.92d4a127.js"><link rel="prefetch" href="/blog/assets/js/61.2fe87550.js"><link rel="prefetch" href="/blog/assets/js/62.24bf6999.js"><link rel="prefetch" href="/blog/assets/js/63.2f87f55d.js"><link rel="prefetch" href="/blog/assets/js/64.68cd3b45.js"><link rel="prefetch" href="/blog/assets/js/65.b2920db4.js"><link rel="prefetch" href="/blog/assets/js/66.18d74400.js"><link rel="prefetch" href="/blog/assets/js/67.ac26e1fe.js"><link rel="prefetch" href="/blog/assets/js/68.b6f86cb6.js"><link rel="prefetch" href="/blog/assets/js/69.134a204b.js"><link rel="prefetch" href="/blog/assets/js/7.9e783835.js"><link rel="prefetch" href="/blog/assets/js/70.d56e0998.js"><link rel="prefetch" href="/blog/assets/js/71.e8314430.js"><link rel="prefetch" href="/blog/assets/js/72.78fc6941.js"><link rel="prefetch" href="/blog/assets/js/73.2bacb1ea.js"><link rel="prefetch" href="/blog/assets/js/74.3c8755ec.js"><link rel="prefetch" href="/blog/assets/js/75.36ca899a.js"><link rel="prefetch" href="/blog/assets/js/76.a0981293.js"><link rel="prefetch" href="/blog/assets/js/77.de031445.js"><link rel="prefetch" href="/blog/assets/js/78.b41b3078.js"><link rel="prefetch" href="/blog/assets/js/79.f314f893.js"><link rel="prefetch" href="/blog/assets/js/8.5c76926d.js"><link rel="prefetch" href="/blog/assets/js/80.389c0b37.js"><link rel="prefetch" href="/blog/assets/js/81.04f50a1e.js"><link rel="prefetch" href="/blog/assets/js/82.db879ca5.js"><link rel="prefetch" href="/blog/assets/js/83.e89b8863.js"><link rel="prefetch" href="/blog/assets/js/84.07410b58.js"><link rel="prefetch" href="/blog/assets/js/85.d3e35fad.js"><link rel="prefetch" href="/blog/assets/js/86.52351591.js"><link rel="prefetch" href="/blog/assets/js/87.c4ebf9a8.js"><link rel="prefetch" href="/blog/assets/js/88.09fc332a.js"><link rel="prefetch" href="/blog/assets/js/89.8b302469.js"><link rel="prefetch" href="/blog/assets/js/9.a64cd1e6.js"><link rel="prefetch" href="/blog/assets/js/90.391f76ed.js"><link rel="prefetch" href="/blog/assets/js/91.d1662d38.js"><link rel="prefetch" href="/blog/assets/js/92.a65aa479.js"><link rel="prefetch" href="/blog/assets/js/93.bc850b53.js"><link rel="prefetch" href="/blog/assets/js/94.7dc858d7.js"><link rel="prefetch" href="/blog/assets/js/95.6755e920.js"><link rel="prefetch" href="/blog/assets/js/96.7e3abf55.js"><link rel="prefetch" href="/blog/assets/js/97.16a7a60a.js"><link rel="prefetch" href="/blog/assets/js/98.a84fee2e.js"><link rel="prefetch" href="/blog/assets/js/99.c4b1cfd7.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.b3aba94c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">一名GO+PHP工程师</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://gitee.com/ColinWWL/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://gitee.com/ColinWWL/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/blog/系统组件与架构设计/K8S/1kubernetes 概述" class="sidebar-heading clickable open"><span>K8S</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/系统组件与架构设计/K8S/1kubernetes 概述.html" class="sidebar-link">概述</a></li><li><a href="/blog/系统组件与架构设计/K8S/2kubernetes 集群搭建-kubeadm方式 .html" class="sidebar-link">集群搭建(kubeadm 方式)</a></li><li><a href="/blog/系统组件与架构设计/K8S/4kubernetes 集群 YAML 文件详解.html" class="sidebar-link">集群 YAML 文件详解</a></li><li><a href="/blog/系统组件与架构设计/K8S/5kubernetes 集群命令行工具 kubectl.html" class="sidebar-link">集群命令行工具 kubectl</a></li><li><a href="/blog/系统组件与架构设计/K8S/6kubernetes 核心技术-Pod.html" class="sidebar-link">核心技术-Pod</a></li><li><a href="/blog/系统组件与架构设计/K8S/7kubernetes 核心技术-Label.html" class="sidebar-link">核心技术-Label</a></li><li><a href="/blog/系统组件与架构设计/K8S/8kubernetes 核心技术-Controller 控制器.html" class="sidebar-link">核心技术-Controller 控制器</a></li><li><a href="/blog/系统组件与架构设计/K8S/9kubernetes 核心技术-Volume.html" class="sidebar-link">核心技术-Volume</a></li><li><a href="/blog/系统组件与架构设计/K8S/10 kubernetes 核心技术-PVC 和 PV.html" class="sidebar-link">核心技术-PVC 和 PV</a></li><li><a href="/blog/系统组件与架构设计/K8S/11kubernetes 核心技术-Secret.html" class="sidebar-link">核心技术-Secret</a></li><li><a href="/blog/系统组件与架构设计/K8S/12kubernetes 核心技术-configMap.html" class="sidebar-link">核心技术-configMap</a></li><li><a href="/blog/系统组件与架构设计/K8S/13kubernetes 核心技术-Namespace.html" class="sidebar-link">核心技术-Namespace</a></li><li><a href="/blog/系统组件与架构设计/K8S/14kubernetes 核心技术-Service.html" class="sidebar-link">核心技术-Service</a></li><li><a href="/blog/系统组件与架构设计/K8S/18kubernetes 核心技术-探针.html" class="sidebar-link">核心技术-探针</a></li><li><a href="/blog/系统组件与架构设计/K8S/19kubernetes 核心技术-调度器.html" class="sidebar-link">核心技术-调度器</a></li><li><a href="/blog/系统组件与架构设计/K8S/20kubernetes 核心技术-集群安全机制 RBAC.html" class="sidebar-link">核心技术-集群安全机制 RBAC</a></li><li><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html" class="active sidebar-link">核心技术-Helm</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#helm-引入" class="sidebar-link">Helm 引入</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#helm-介绍" class="sidebar-link">Helm 介绍</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#helm-v3-变化" class="sidebar-link">Helm v3 变化</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#helm-客户端" class="sidebar-link">Helm 客户端</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#部署-helm-客户端" class="sidebar-link">部署 helm 客户端</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#配置国内-chart-仓库" class="sidebar-link">配置国内 chart 仓库</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#helm-基本使用" class="sidebar-link">helm 基本使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#使用-chart-部署一个应用" class="sidebar-link">使用 chart 部署一个应用</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#安装前自定义-chart-配置选项" class="sidebar-link">安装前自定义 chart 配置选项</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#构建一个-helm-chart" class="sidebar-link">构建一个 Helm Chart</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#chart-模板" class="sidebar-link">chart 模板</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#调试" class="sidebar-link">调试</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#内置对象" class="sidebar-link">内置对象</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#values" class="sidebar-link">Values</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#升级、回滚和删除" class="sidebar-link">升级、回滚和删除</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#管道与函数" class="sidebar-link">管道与函数</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#流程控制" class="sidebar-link">流程控制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#if" class="sidebar-link">if</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#with" class="sidebar-link">with</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#变量" class="sidebar-link">变量</a></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#命名模板" class="sidebar-link">命名模板</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/系统组件与架构设计/K8S/22kubernetes 核心技术-Helm.html#开发自己的-chart" class="sidebar-link">开发自己的 chart</a></li></ul></li><li><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html" class="sidebar-link">高可用集群搭建</a></li><li><a href="/blog/系统组件与架构设计/K8S/24kubernetes 部署项目.html" class="sidebar-link">部署项目</a></li><li><a href="/blog/系统组件与架构设计/K8S/25kubernetes-部署性能监控平台.html" class="sidebar-link">部署性能监控平台</a></li><li><a href="/blog/系统组件与架构设计/K8S/Web界面Dashboard.html" class="sidebar-link">Web界面Dashboard</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="核心技术-helm"><a href="#核心技术-helm" class="header-anchor">#</a> 核心技术-Helm</h1> <h2 id="helm-引入"><a href="#helm-引入" class="header-anchor">#</a> Helm 引入</h2> <p>K8S 上的应用对象，都是由特定的资源描述组成，包括 deployment、service 等。都保存各自文件中或者集中写到一个配置文件。然后 kubectl apply –f 部署。如果应用只由一个或几个这样的服务组成，上面部署方式足够了。而对于一个复杂的应用，会有很多类似上面的资源描述文件，例如微服务架构应用，组成应用的服务可能多达十个，几十个。如果有更新或回滚应用的需求，可能要修改和维护所涉及的大量资源文件，而这种组织和管理应用的方式就显得力不从心了。且由于缺少对发布过的应用版本管理和控制，使Kubernetes 上的应用维护和更新等面临诸多的挑战，主要面临以下问题：</p> <ul><li>如何将这些服务作为一个整体管理</li> <li>这些资源文件如何高效复用</li> <li>不支持应用级别的版本管理</li></ul> <h2 id="helm-介绍"><a href="#helm-介绍" class="header-anchor">#</a> Helm 介绍</h2> <p>Helm 是一个 Kubernetes 的包管理工具，就像 Linux 下的包管理器，如 yum/apt 等，可以很方便的将之前打包好的 yaml 文件部署到 kubernetes 上。</p> <p>Helm 有 3 个重要概念：</p> <ul><li><p>helm：一个命令行客户端工具，主要用于 Kubernetes 应用 chart 的创建、打包、发布和管理。</p></li> <li><p>Chart：应用描述，一系列用于描述 k8s 资源相关文件的集合。</p></li> <li><p>Release：基于 Chart 的部署实体，一个 chart 被 Helm 运行后将会生成对应的一个</p></li></ul> <h2 id="helm-v3-变化"><a href="#helm-v3-变化" class="header-anchor">#</a> Helm v3 变化</h2> <p>2019 年 11 月 13 日， Helm 团队发布 Helm v3 的第一个稳定版本。</p> <p>该版本主要变化如下：</p> <p>架构变化：</p> <ul><li><p>最明显的变化是 Tiller 的删除</p></li> <li><p>Release 名称可以在不同命名空间重用</p></li></ul> <p><img src="/blog/assets/img/2021-04-23-10-51-56.3ff5d5a6.png" alt=""></p> <ul><li><p>支持将 Chart 推送至 Docker 镜像仓库中</p></li> <li><p>使用 JSONSchema 验证 chart values</p></li> <li><p>其他</p></li></ul> <h2 id="helm-客户端"><a href="#helm-客户端" class="header-anchor">#</a> Helm 客户端</h2> <h3 id="部署-helm-客户端"><a href="#部署-helm-客户端" class="header-anchor">#</a> 部署 helm 客户端</h3> <p>Helm 客户端下载地址：https://github.com/helm/helm/releases</p> <p>解压移动到/usr/bin/目录即可。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">wget</span> https://get.helm.sh/helm-vv3.2.1-linux-amd64.tar.gz

<span class="token function">tar</span> zxvf helm-v3.2.1-linux-amd64.tar.gz

<span class="token function">mv</span> linux-amd64/helm /usr/bin/
</code></pre></div><p>helm 常用命令</p> <p><img src="/blog/assets/img/2021-04-23-10-52-33.c0c0e165.png" alt=""><br> <img src="/blog/assets/img/2021-04-23-10-52-57.1155597f.png" alt=""><br> <img src="/blog/assets/img/2021-04-23-10-53-21.8fc7aa01.png" alt=""></p> <h3 id="配置国内-chart-仓库"><a href="#配置国内-chart-仓库" class="header-anchor">#</a> 配置国内 chart 仓库</h3> <ul><li><p>微软仓库（http://mirror.azure.cn/kubernetes/charts/）这个仓库推荐，基本上官网有的 chart 这里都有。</p></li> <li><p>阿里云仓库（https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts ）</p></li> <li><p>官方仓库（https://hub.kubeapps.com/charts/incubator）官方 chart 仓库，国内有点不好使。</p></li></ul> <p>添加存储库</p> <div class="language-bash extra-class"><pre class="language-bash"><code>helm repo <span class="token function">add</span> stable http://mirror.azure.cn/kubernetes/charts

helm repo <span class="token function">add</span> aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts

helm repo update
</code></pre></div><p>查看配置的存储库</p> <div class="language-bash extra-class"><pre class="language-bash"><code>helm repo list

helm search repo stable
</code></pre></div><p>删除存储库：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>helm repo remove aliyun
</code></pre></div><h2 id="helm-基本使用"><a href="#helm-基本使用" class="header-anchor">#</a> helm 基本使用</h2> <p>主要介绍三个命令：</p> <ul><li><p>chart install</p></li> <li><p>chart upgrade</p></li> <li><p>chart rollback</p></li></ul> <h3 id="使用-chart-部署一个应用"><a href="#使用-chart-部署一个应用" class="header-anchor">#</a> 使用 chart 部署一个应用</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#查找 chart</span>

<span class="token comment"># helm search repo weave</span>

NAME CHART VERSION APP VERSION DESCRIPTION

aliyun/weave-cloud <span class="token number">0.1</span>.2 Weave Cloud is a add-on

to Kubernetes <span class="token function">which</span> pro<span class="token punctuation">..</span>.

aliyun/weave-scope <span class="token number">0.9</span>.21.6.5 A Helm chart <span class="token keyword">for</span> the Weave Scope

cluster visual<span class="token punctuation">..</span>.

stable/weave-cloud <span class="token number">0.3</span>.71.4.0 Weave Cloud is a add-on to Kubernetes

<span class="token function">which</span> pro<span class="token punctuation">..</span>.

stable/weave-scope <span class="token number">1.1</span>.101.12.0 A Helm chart <span class="token keyword">for</span> the Weave Scope

cluster visual<span class="token punctuation">..</span>.

<span class="token comment">#查看 chrt 信息</span>

<span class="token comment"># helm show chart stable/mysql</span>

<span class="token comment">#安装包</span>

<span class="token comment"># helm install ui stable/weave-scope</span>

<span class="token comment">#查看发布状态</span>

<span class="token comment"># helm list</span>

NAME NAMESPACE REVISION UPDATED

STATUS CHART APP VERSION

ui default <span class="token number">12020</span>-05-2817:45:01.696109626 +0800 CST deployed

weave-scope-1.1.101.12.0

<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># helm status ui</span>

NAME: ui

LAST DEPLOYED: Thu May <span class="token number">2817</span>:45:012020

NAMESPACE: default

STATUS: deployed

REVISION: <span class="token number">1</span>

NOTES:

You should now be able to access the Scope frontend <span class="token keyword">in</span> your web browser, by

using kubectl port-forward:

kubectl -n default port-forward <span class="token variable"><span class="token variable">$(</span>kubectl -n default get endpoints <span class="token punctuation">\</span>

ui-weave-scope -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'{.subsets[0].addresses[0].targetRef.name}'</span><span class="token variable">)</span></span>

<span class="token number">8080</span>:4040

<span class="token keyword">then</span> browsing to http://localhost:8080/.

For <span class="token function">more</span> details on using Weave Scope, see the Weave Scope documentation:

https://www.weave.works/docs/scope/latest/introducing/

<span class="token comment">#修改 service Type: NodePort 即可访问 ui</span>

</code></pre></div><h3 id="安装前自定义-chart-配置选项"><a href="#安装前自定义-chart-配置选项" class="header-anchor">#</a> 安装前自定义 chart 配置选项</h3> <p>自定义选项是因为并不是所有的 chart 都能按照默认配置运行成功，可能会需要一些环境依赖，例如 PV。</p> <p>所以我们需要自定义 chart 配置选项，安装过程中有两种方法可以传递配置数据：</p> <ul><li><p>--values（或-f）：指定带有覆盖的 YAML 文件。这可以多次指定，最右边的文件优先</p></li> <li><p>--set：在命令行上指定替代。如果两者都用，--set 优先级高</p></li> <li><p>--values 使用，先将修改的变量写到一个文件中</p></li></ul> <h1 id="helm-show-values-stable-mysql"><a href="#helm-show-values-stable-mysql" class="header-anchor">#</a> helm show values stable/mysql</h1> <div class="language-yaml extra-class"><pre class="language-yaml"><code>
<span class="token comment"># catconfig.yaml</span>

<span class="token key atrule">persistence</span><span class="token punctuation">:</span>

<span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">storageClass</span><span class="token punctuation">:</span> <span class="token string">&quot;managed-nfs-storage&quot;</span>

<span class="token key atrule">accessMode</span><span class="token punctuation">:</span> ReadWriteOnce

<span class="token key atrule">size</span><span class="token punctuation">:</span> 8Gi

<span class="token key atrule">mysqlUser</span><span class="token punctuation">:</span> <span class="token string">&quot;k8s&quot;</span>

<span class="token key atrule">mysqlPassword</span><span class="token punctuation">:</span> <span class="token string">&quot;123456&quot;</span>

<span class="token key atrule">mysqlDatabase</span><span class="token punctuation">:</span> <span class="token string">&quot;k8s&quot;</span>

<span class="token comment"># helm install db -f config.yaml stable/mysql</span>

<span class="token comment"># kubectl get pods</span>

NAME READY STATUS RESTARTS AGE

db<span class="token punctuation">-</span>mysql<span class="token punctuation">-</span>57485b68dc<span class="token punctuation">-</span>4xjhv 1/1 Running 0 8m51s

<span class="token comment"># kubectl run -it db-client --rm --restart=Never --image=mysql:5.7 -- bash</span>

If you don't see a command prompt<span class="token punctuation">,</span> try pressing enter.

root@db<span class="token punctuation">-</span>client<span class="token punctuation">:</span>/<span class="token comment"># mysql -hdb-mysql -uk8s -p123456</span>

<span class="token key atrule">mysql</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>Warning<span class="token punctuation">]</span> Using a password on the command line interface can be insecure.

Welcome to the MySQL monitor. Commands end with ; or \\g.

Your MySQL connection id is 36

<span class="token key atrule">Server version</span><span class="token punctuation">:</span> 5.7.30 MySQL Community Server (GPL)

Copyright (c) 2000<span class="token punctuation">,</span> <span class="token number">2020</span><span class="token punctuation">,</span> Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its

affiliates. Other names may be trademarks of their respective

owners.

Type 'help; ' or '\\h'for help. Type '\\c' to clear the current input statement.

mysql<span class="token punctuation">&gt;</span> show databases; 

+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>+

<span class="token punctuation">|</span> Database <span class="token punctuation">|</span>

+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>+

<span class="token punctuation">|</span> information_schema <span class="token punctuation">|</span>

<span class="token punctuation">|</span> k8s <span class="token punctuation">|</span>

+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>+

</code></pre></div><p>以上将创建具有名称的默认 MySQL 用户 k8s，并授予此用户访问新创建的 k8s 数据库的权限，但将接受该图表的所有其余默认值。</p> <p>命令行替代变量：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>helm <span class="token function">install</span> db --set persistence.storageClass<span class="token operator">=</span><span class="token string">&quot;managed-nfs-storage&quot;</span>
stable/mysql
</code></pre></div><p>也可以把 chart 包下载下来查看详情：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>helm pull stable/mysql --untar
</code></pre></div><p>values yaml 与 set 使用：</p> <p>该 helm install 命令可以从多个来源安装：</p> <ul><li><p>chart 存储库</p></li> <li><p>本地 chart 存档（helm install foo-0.1.1.tgz）</p></li> <li><p>chart 目录（helm install path/to/foo）</p></li> <li><p>完整的 URL（helm install https://example.com/charts/foo-1.2.3.tgz）</p></li></ul> <h2 id="构建一个-helm-chart"><a href="#构建一个-helm-chart" class="header-anchor">#</a> 构建一个 Helm Chart</h2> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># helm create mychart</span>

Creating mychart

<span class="token comment"># tree mychart/</span>

mychart/

├── charts

├── Chart.yaml

├── templates

│ ├── deployment.yaml

│ ├── _helpers.tpl

│ ├── ingress.yaml

│ ├── NOTES.txt

│ └── service.yaml

└── values.yaml
</code></pre></div><ul><li><p>Chart.yaml：用于描述这个 Chart 的基本信息，包括名字、描述信息以及版本等。</p></li> <li><p>values.yaml ：用于存储 templates 目录中模板文件中用到变量的值。</p></li> <li><p>Templates： 目录里面存放所有 yaml 模板文件。</p></li> <li><p>charts：目录里存放这个 chart 依赖的所有子 chart。</p></li> <li><p>NOTES.txt ：用于介绍 Chart 帮助信息， helm install 部署后展示给用户。例如：</p></li></ul> <p>如何使用这个 Chart、列出缺省的设置等。</p> <ul><li>_helpers.tpl：放置模板助手的地方，可以在整个 chart 中重复使用</li></ul> <p>创建 Chart 后，接下来就是将其部署：</p> <p>helm install web mychart/</p> <p>也可以打包推送的 charts 仓库共享别人使用。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># helm package mychart/</span>

mychart-0.1.0.tgz
</code></pre></div><h3 id="chart-模板"><a href="#chart-模板" class="header-anchor">#</a> chart 模板</h3> <p>Helm 最核心的就是模板，即模板化的 K8S manifests 文件。它本质上就是一个 Go 的 template 模板。Helm 在 Go template 模板的基础上，还会增加很多东西。如一些自定义的元数据信息、扩展的库以及一些类似于编程形式的工作流，例如 条件语句、管道等等。这些东西都会使得我们的模板变得更加丰富。有了模板，我们怎么把我们的配置融入进去呢？用的就是这个 values 文件。这两部分内容其实就是 chart 的核心功能。接下来，部署 nginx 应用，熟悉模板使用</p> <div class="language-bash extra-class"><pre class="language-bash"><code>helm create nginx

<span class="token function">vim</span> nginx/Chart.yaml
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v2

<span class="token key atrule">name</span><span class="token punctuation">:</span> nginx

<span class="token key atrule">description</span><span class="token punctuation">:</span> A Helm chart for Kubernetes

<span class="token key atrule">type</span><span class="token punctuation">:</span> application

<span class="token key atrule">version</span><span class="token punctuation">:</span> 0.1.0

<span class="token key atrule">appVersion</span><span class="token punctuation">:</span> <span class="token number">1.15</span>

<span class="token comment"># vim nginx/values.yaml</span>

<span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>

<span class="token key atrule">image</span><span class="token punctuation">:</span> nginx

<span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token number">1.15</span>

<span class="token key atrule">serviceport</span><span class="token punctuation">:</span> <span class="token number">80</span>

<span class="token key atrule">targetport</span><span class="token punctuation">:</span> <span class="token number">80</span>

<span class="token key atrule">label</span><span class="token punctuation">:</span> nginx

<span class="token comment"># vim nginx/templates/NOTES.txt</span>

hello

<span class="token comment"># vim nginx/templates/deployment.yaml</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1

<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment

<span class="token key atrule">metadata</span><span class="token punctuation">:</span>

<span class="token key atrule">labels</span><span class="token punctuation">:</span>

<span class="token key atrule">app</span><span class="token punctuation">:</span>  . Values.label 

<span class="token key atrule">name</span><span class="token punctuation">:</span>  . Release. Name 

<span class="token key atrule">spec</span><span class="token punctuation">:</span>

<span class="token key atrule">replicas</span><span class="token punctuation">:</span>  . Values.replicas 

<span class="token key atrule">selector</span><span class="token punctuation">:</span>

<span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>

<span class="token key atrule">app</span><span class="token punctuation">:</span>  . Values.label 

<span class="token key atrule">template</span><span class="token punctuation">:</span>

<span class="token key atrule">metadata</span><span class="token punctuation">:</span>

<span class="token key atrule">labels</span><span class="token punctuation">:</span>

<span class="token key atrule">app</span><span class="token punctuation">:</span>  . Values.label 

<span class="token key atrule">spec</span><span class="token punctuation">:</span>

<span class="token key atrule">containers</span><span class="token punctuation">:</span>

 <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span>  <span class="token key atrule">. Values.image</span> <span class="token punctuation">:</span> . Values.tag 

<span class="token key atrule">name</span><span class="token punctuation">:</span> web

<span class="token comment"># vim nginx/templates/service.yaml</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1

<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service

<span class="token key atrule">metadata</span><span class="token punctuation">:</span>

<span class="token key atrule">labels</span><span class="token punctuation">:</span>

<span class="token key atrule">app</span><span class="token punctuation">:</span>  . Values.label 

<span class="token key atrule">name</span><span class="token punctuation">:</span>  . Release. Name 

<span class="token key atrule">spec</span><span class="token punctuation">:</span>

<span class="token key atrule">ports</span><span class="token punctuation">:</span>

 <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>  . Values.serviceport 

<span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP

<span class="token key atrule">targetPort</span><span class="token punctuation">:</span>  . Values.targetport 

<span class="token key atrule">selector</span><span class="token punctuation">:</span>

<span class="token key atrule">app</span><span class="token punctuation">:</span>  . Values.label 

<span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort

<span class="token comment">#查看实际的模板被渲染过后的资源文件</span>

<span class="token comment"># helm get manifest web</span>

<span class="token comment"># helm install web nginx/</span>

<span class="token key atrule">NAME</span><span class="token punctuation">:</span> web

<span class="token key atrule">LAST DEPLOYED</span><span class="token punctuation">:</span> Fri May 2916<span class="token punctuation">:</span>09<span class="token punctuation">:</span><span class="token number">462020</span>

<span class="token key atrule">NAMESPACE</span><span class="token punctuation">:</span> default

<span class="token key atrule">STATUS</span><span class="token punctuation">:</span> deployed

<span class="token key atrule">REVISION</span><span class="token punctuation">:</span> <span class="token number">1</span>

<span class="token key atrule">TEST SUITE</span><span class="token punctuation">:</span> None

<span class="token key atrule">NOTES</span><span class="token punctuation">:</span>

hello

</code></pre></div><h1 id="helm-list"><a href="#helm-list" class="header-anchor">#</a> helm list</h1> <p>NAME NAMESPACE REVISION UPDATED</p> <p>STATUS CHART APP VERSION</p> <p>web default 12020-05-2916:09:46.608457282 +0800 CST deployed</p> <p>nginx-0.1.01.15</p> <h1 id="kubectl-get-pod"><a href="#kubectl-get-pod" class="header-anchor">#</a> kubectl get pod</h1> <p>NAME READY STATUS RESTARTS AGE</p> <p>web-5675686b8-7wtqk 1/1 Running 0 25s</p> <p>web-5675686b8-f72hk 1/1 Running 0 25s</p> <p>web-5675686b8-k4kqr 1/1 Running 0 25s</p> <p>这个 deployment 就是一个 Go template 的模板，这里定义的 Release 模板对象属于 Helm</p> <p>内置的一种对象，是从 values 文件中读取出来的。这样一来，我们可以将需要变化的地方</p> <p>都定义变量。</p> <h3 id="调试"><a href="#调试" class="header-anchor">#</a> 调试</h3> <p>Helm 也提供了--dry-run --debug 调试参数，帮助你验证模板正确性。在执行 helm install 时候带上这两个参数就可以把对应的 values 值和渲染的资源清单打印出来，而不会真正的去部署一个 release。</p> <p>比如我们来调试上面创建的 chart 包：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>helm <span class="token function">install</span> web --dry-run nginx/
</code></pre></div><h3 id="内置对象"><a href="#内置对象" class="header-anchor">#</a> 内置对象</h3> <p>刚刚我们使用 . Release. Name将 release 的名称插入到模板中。这里的 Release 就</p> <p>是 Helm 的内置对象，下面是一些常用的内置对象：</p> <p>Release. Name release 名称</p> <p>Release. Name release 名字</p> <p>Release. Namespace release 命名空间</p> <p>Release. Service release 服务的名称</p> <p>Release. Revision release 修订版本号，从 1 开始累加</p> <h3 id="values"><a href="#values" class="header-anchor">#</a> Values</h3> <p>Values 对象是为 Chart 模板提供值，这个对象的值有 4 个来源：</p> <ul><li><p>chart 包中的 values.yaml 文件</p></li> <li><p>父 chart 包的 values.yaml 文件</p></li> <li><p>通过 helm install 或者 helm upgrade 的 -f 或者 --values 参数传入的自定义的 yaml 文件</p></li> <li><p>通过 --set 参数传入的值</p></li></ul> <p>chart 的 values.yaml 提供的值可以被用户提供的 values 文件覆盖，而该文件同样可以被 --set 提供的参数所覆盖。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>helm upgrade web --set <span class="token assign-left variable">replicas</span><span class="token operator">=</span><span class="token number">5</span> nginx/
</code></pre></div><p>Release &quot;web&quot; has been upgraded. Happy Helming!</p> <p>NAME: web</p> <p>LAST DEPLOYED: Fri May 2916:34:172020</p> <p>NAMESPACE: default</p> <p>STATUS: deployed</p> <p>REVISION: 2</p> <p>TEST SUITE: None</p> <p>NOTES:</p> <p>hello</p> <div class="language-bash extra-class"><pre class="language-bash"><code>helm <span class="token function">history</span> web
</code></pre></div><p>REVISION UPDATED STATUS CHART APP</p> <p>VERSION DESCRIPTION</p> <p>1 Fri May 2916:33:562020 superseded nginx-0.1.01.15</p> <p>Install complete</p> <p>2 Fri May 2916:34:172020 deployed nginx-0.1.01.15</p> <p>Upgrade complete</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl get pod
</code></pre></div><p>NAME READY STATUS RESTARTS AGE</p> <p>web-5675686b8-7n7bg 1/1 Running 0 54s</p> <p>web-5675686b8-9vf28 1/1 Running 0 33s</p> <p>web-5675686b8-9wkgz 1/1 Running 0 54s</p> <p>web-5675686b8-jdrhr 1/1 Running 0 54s</p> <p>web-5675686b8-rrrxc 1/1 Running 0 33s</p> <h3 id="升级、回滚和删除"><a href="#升级、回滚和删除" class="header-anchor">#</a> 升级、回滚和删除</h3> <p>发布新版本的 chart 时，或者当您要更改发布的配置时，可以使用该 helm upgrade 命令。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>helm upgrade --set <span class="token assign-left variable">imageTag</span><span class="token operator">=</span><span class="token number">1.17</span> web nginx
helm upgrade -f values.yaml web nginx
</code></pre></div><p>如果在发布后没有达到预期的效果，则可以使用 helm rollback 回滚到之前的版本。</p> <p>例如将应用回滚到第一个版本：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># helm rollback web 1</span>
</code></pre></div><p>卸载发行版，请使用以下 helm uninstall 命令：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># helm uninstall web</span>
</code></pre></div><p>查看历史版本配置信息</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># helm get all --revision 1 web</span>
</code></pre></div><h3 id="管道与函数"><a href="#管道与函数" class="header-anchor">#</a> 管道与函数</h3> <p>前面讲的模块，其实就是将值传给模板引擎进行渲染，模板引擎还支持对拿到数据进行二次处理。</p> <p>例如从. Values 中读取的值变成字符串，可以使用 quote 函数实现：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">vi</span> templates/deployment.yaml
</code></pre></div><p>app:  quote . Values.label.app</p> <div class="language-bash extra-class"><pre class="language-bash"><code>helm <span class="token function">install</span> --dry-run web <span class="token punctuation">..</span>/mychart/
</code></pre></div><p>project: ms</p> <p>app: &quot;nginx&quot;</p> <p>quote . Values.label.app 将后面的值作为参数传递给 quote 函数。</p> <p>模板函数调用语法为：functionName arg1 arg2...</p> <p>另外还会经常使用一个 default 函数，该函数允许在模板中指定默认值，以防止该值被忽</p> <p>略掉。</p> <p>例如忘记定义，执行 helm install 会因为缺少字段无法创建资源，这时就可以定义一个</p> <p>默认值。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># catvalues.yaml</span>

replicas: <span class="token number">2</span>

<span class="token comment"># cat templates/deployment.yaml</span>

apiVersion: apps/v1

kind: Deployment

metadata:

name:  <span class="token builtin class-name">.</span> Release. Name -deployment

 - name:  <span class="token builtin class-name">.</span> Values.name <span class="token operator">|</span> default <span class="token string">&quot;nginx&quot;</span> 

</code></pre></div><p>其他函数：</p> <ul><li><p>缩进： . Values.resources | indent 12</p></li> <li><p>大写： upper . Values.resources</p></li> <li><p>首字母大写： title . Values.resources</p></li></ul> <h2 id="流程控制"><a href="#流程控制" class="header-anchor">#</a> 流程控制</h2> <p>流程控制是为模板提供了一种能力，满足更复杂的数据逻辑处理。</p> <p>Helm 模板语言提供以下流程控制语句：</p> <ul><li><p>if/else 条件块</p></li> <li><p>with 指定范围</p></li> <li><p>range 循环块</p></li></ul> <h3 id="if"><a href="#if" class="header-anchor">#</a> if</h3> <p>if/else 块是用于在模板中有条件地包含文本块的方法，条件块的基本结构如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code> <span class="token keyword">if</span> PIPELINE 

<span class="token comment"># Do something</span>

 elseif OTHER PIPELINE 

<span class="token comment"># Do something else</span>

 <span class="token keyword">else</span> 

<span class="token comment"># Default case</span>

 end 

示例

<span class="token comment"># catvalues.yaml</span>

devops: k8

<span class="token comment"># cat templates/deployment.yaml</span>

<span class="token punctuation">..</span>.

template:

metadata:

labels:

app: nginx

 <span class="token keyword">if</span> eq <span class="token builtin class-name">.</span> Values.devops <span class="token string">&quot;k8s&quot;</span> 

devops: <span class="token number">123</span>

 <span class="token keyword">else</span> 

devops: <span class="token number">456</span>

 end 

在上面条件语句使用了 eq 运算符判断是否相等，除此之外，还支持

ne、 lt、 gt、 and、 or 等运算符。

注意数据类型。

通过模板引擎来渲染一下，会得到如下结果：

<span class="token comment"># helm install --dry-run web ../mychart/</span>

<span class="token punctuation">..</span>.

labels:

app: nginx

devops: <span class="token number">456</span>

可以看到渲染出来会有多余的空行，这是因为当模板引擎运行时，会将控制指令删除，所

有之前占的位置也就空白了，需要使用 - <span class="token keyword">if</span> <span class="token punctuation">..</span>. 的方式消除此空行：

<span class="token comment"># cat templates/deploymemt.yaml</span>

<span class="token punctuation">..</span>.

env:

 - ifeq <span class="token builtin class-name">.</span> Values.env.hello <span class="token string">&quot;world&quot;</span> 

 - name: hello

value: <span class="token number">123</span>

 - end 

现在是不是没有多余的空格了，如果使用-需谨慎，比如上面模板文件中：

<span class="token comment"># cat templates/deploymemt.yaml</span>

<span class="token punctuation">..</span>.

env:

 - ifeq <span class="token builtin class-name">.</span> Values.env.hello <span class="token string">&quot;world&quot;</span> -

 - hello: <span class="token boolean">true</span>

 - end 

这会渲染成：

env:- hello: <span class="token boolean">true</span>

因为-它删除了双方的换行符。

条件判断就是判断条件是否为真，如果值为以下几种情况则为 false：

 一个布尔类型的 <span class="token boolean">false</span>

 一个数字 零

 一个 空的字符串

 一个空的集合（ map、 slice、 tuple、 dict、 array）

除了上面的这些情况外，其他所有条件都为 真。

例如，判断一个空的数组

<span class="token comment"># catvalues.yaml</span>

resources: <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment"># limits:</span>

<span class="token comment"># cpu: 100m</span>

<span class="token comment"># memory: 128Mi</span>

<span class="token comment"># requests:</span>

<span class="token comment"># cpu: 100m</span>

<span class="token comment"># memory: 128Mi</span>

<span class="token comment"># cat templates/deploymemt.yaml</span>

<span class="token punctuation">..</span>.

spec:

containers:

 - image: nginx:1.16

name: nginx

 - <span class="token keyword">if</span> <span class="token builtin class-name">.</span> Values.resources 

resources:

 toYaml <span class="token builtin class-name">.</span> Values.resources <span class="token operator">|</span> indent <span class="token number">10</span> 

 - end 

例如，判断一个布尔值

<span class="token comment"># catvalues.yaml</span>

service:

type: ClusterIP

port: <span class="token number">80</span>

ingress:

enabled: <span class="token boolean">true</span>

host: example.ctnrs.com

<span class="token comment"># cat templates/ingress.yaml</span>

 - <span class="token keyword">if</span> <span class="token builtin class-name">.</span> Values.ingress.enabled -

apiVersion: networking.k8s.io/v1beta1

kind: Ingress

metadata:

name:  <span class="token builtin class-name">.</span> Release. Name -ingress

spec:

rules:

 - host:  <span class="token builtin class-name">.</span> Values.ingress.host 

http:

paths:

 - path: /

backend:

serviceName:  <span class="token builtin class-name">.</span> Release. Name 

servicePort:  <span class="token builtin class-name">.</span> Values.service.port 

 end 

<span class="token number">7.2</span>、range

在 Helm 模板语言中，使用 range 关键字来进行循环操作。

我们在 values.yaml 文件中添加上一个变量列表：

<span class="token comment"># catvalues.yaml</span>

test:

 - <span class="token number">1</span>

 - <span class="token number">2</span>

 - <span class="token number">3</span>

循环打印该列表：

apiVersion: v1

kind: ConfigMap

metadata:

name:  <span class="token builtin class-name">.</span> Release. Name 

data:

test: <span class="token operator">|</span>

 - range <span class="token builtin class-name">.</span> Values.test 

 <span class="token builtin class-name">.</span> 

 - end 

循环内部我们使用的是一个 .，这是因为当前的作用域就在当前循环内，这个 <span class="token builtin class-name">.</span> 引用的

当前读取的元素。
</code></pre></div><h3 id="with"><a href="#with" class="header-anchor">#</a> with</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>with ：控制变量作用域。

还记得之前我们的 <span class="token builtin class-name">.</span> Release.xxx或者 <span class="token builtin class-name">.</span> Values.xxx吗？其中的 <span class="token builtin class-name">.</span> 就是表示对

当前范围的引用， <span class="token builtin class-name">.</span> Values 就是告诉模板在当前范围中查找 Values 对象的值。

而 with 语句就可以来控制变量的作用域范围，其语法和一个简单的 <span class="token keyword">if</span> 语句比较类似：

 with PIPELINE 

<span class="token comment"># restricted scope</span>

 end 

with 语句可以允许将当前范围 <span class="token builtin class-name">.</span> 设置为特定的对象，比如我们前面一直使用

的 <span class="token builtin class-name">.</span> Values.label，我们可以使用 with 来将 <span class="token builtin class-name">.</span> 范围指向 <span class="token builtin class-name">.</span> Values.label：

<span class="token comment"># catvalues.yaml</span>

<span class="token punctuation">..</span>.

nodeSelector:

team: a

gpu: <span class="token function">yes</span>

<span class="token comment"># cat templates/deployment.yaml</span>

apiVersion: apps/v1

kind: Deployment

metadata:

name:  <span class="token builtin class-name">.</span> Release. Name -deployment

spec:

replicas: <span class="token number">1</span>

selector:

matchLabels:

app: nginx

template:

metadata:

labels:

app: nginx

spec:

 - with <span class="token builtin class-name">.</span> Values.nodeSelector 

nodeSelector:

team:  .team 

gpu:  .gpu 

 - end 

containers:

 - image: nginx:1.16

name: nginx

优化后：

 - with <span class="token builtin class-name">.</span> Values.nodeSelector 

nodeSelector:

 - toYaml <span class="token builtin class-name">.</span> <span class="token operator">|</span> nindent <span class="token number">8</span> 

 - end 

上面增加了一个 - with <span class="token builtin class-name">.</span> Values.nodeSelector xxx - end 的一个块，这样的话

就可以在当前的块里面直接引用 .team 和 .gpu 了。

with 是一个循环构造。使用. Values.nodeSelector 中的值：将其转换为 Yaml。

toYaml 之后的点是循环中. Values.nodeSelector 的当前值
</code></pre></div><h3 id="变量"><a href="#变量" class="header-anchor">#</a> 变量</h3> <p>变量，在模板中，使用变量的场合不多，但我们将看到如何使用它来简化代码，并更好地</p> <p>利用 with 和 range。</p> <p>问题 1：获取数组键值</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># cat ../values.yaml</span>

env:

NAME: <span class="token string">&quot;gateway&quot;</span>

JAVA_OPTS: <span class="token string">&quot;-Xmx1G&quot;</span>

<span class="token comment"># catdeployment.yaml</span>

<span class="token punctuation">..</span>.

env:

 - range <span class="token variable">$k</span>, <span class="token variable">$v</span> :<span class="token operator">=</span> <span class="token builtin class-name">.</span> Values.env 

 - name:  <span class="token variable">$k</span> 

value:  <span class="token variable">$v</span> <span class="token operator">|</span> quote 

 - end 

结果如下

env:

 - name: JAVA_OPTS

value: <span class="token string">&quot;-Xmx1G&quot;</span>

 - name: NAME

value: <span class="token string">&quot;gateway&quot;</span> 上面在 range 循环中使用 <span class="token variable">$key</span> 和 <span class="token variable">$value</span> 两个变量来接收后面列表循环的键和值。

问题 <span class="token number">2</span>：with 中不能使用内置对象

with 语句块内不能再 <span class="token builtin class-name">.</span> Release. Name 对象，否则报错。

我们可以将该对象赋值给一个变量可以来解决这个问题：

apiVersion: apps/v1

kind: Deployment

metadata:

name:  <span class="token builtin class-name">.</span> Release. Name -deployment

spec:

replicas:  <span class="token builtin class-name">.</span> Values.replicas 

template:

metadata:

labels:

project:  <span class="token builtin class-name">.</span> Values.label.project 

app:  quote <span class="token builtin class-name">.</span> Values.label.app 

 - with <span class="token builtin class-name">.</span> Values.label 

project:  .project 

app:  .app 

release:  <span class="token builtin class-name">.</span> Release. Name 

 - end 

上面会出错

 - <span class="token variable">$releaseName</span> :<span class="token operator">=</span> <span class="token builtin class-name">.</span> Release. Name -

 - with <span class="token builtin class-name">.</span> Values.label 

project:  .project 

app:  .app 

release:  <span class="token variable">$releaseName</span> 

<span class="token comment"># 或者可以使用$符号, 引入全局命名空间</span>

release:  $. Release. Name 

 - end 

可以看到在 with 语句上面增加了一句 -<span class="token variable">$releaseName</span>:<span class="token operator">=</span>. Release. Name-，其

中 <span class="token variable">$releaseName</span> 就是后面的对象的一个引用变量，它的形式就是 <span class="token variable">$name</span>，赋值操作使

用 :<span class="token operator">=</span>，这样 with 语句块内部的 <span class="token variable">$releaseName</span> 变量仍然指向的是 <span class="token builtin class-name">.</span> Release. Name
</code></pre></div><h3 id="命名模板"><a href="#命名模板" class="header-anchor">#</a> 命名模板</h3> <p>需要复用代码的地方用。</p> <p>命名模板：使用 define 定义，template 引入，在 templates 目录中默认下划线开头的文</p> <p>件为公共模板(helpers.tpl)</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># cat _helpers.tpl</span>

 - define <span class="token string">&quot;demo.fullname&quot;</span> -

 - <span class="token builtin class-name">.</span> Chart. Name -- <span class="token builtin class-name">.</span> Release. Name 

 - end -

<span class="token comment"># catdeployment.yaml</span>

apiVersion: apps/v1

kind: Deployment

metadata:

name:  template<span class="token string">&quot;demo.fullname&quot;</span> <span class="token builtin class-name">.</span> 

<span class="token punctuation">..</span>.

template 指令是将一个模板包含在另一个模板中的方法。但是，template 函数不能用于Go 模板管道。为了解决该问题，增加 include 功能。

<span class="token comment"># cat _helpers.tpl</span>

 - define <span class="token string">&quot;demo.labels&quot;</span> -

app:  template<span class="token string">&quot;demo.fullname&quot;</span> <span class="token builtin class-name">.</span> 

chart: <span class="token string">&quot; . Chart. Name - . Chart. Version &quot;</span>

release: <span class="token string">&quot; . Release. Name &quot;</span>

 - end -

<span class="token comment"># catdeployment.yaml</span>

apiVersion: apps/v1

kind: Deployment

metadata:

name:  include<span class="token string">&quot;demo.fullname&quot;</span> <span class="token builtin class-name">.</span> 

labels:

 - include <span class="token string">&quot;demo.labels&quot;</span> <span class="token builtin class-name">.</span> <span class="token operator">|</span> nindent <span class="token number">4</span> 

<span class="token punctuation">..</span>. 上面包含一个名为 demo.labels 的模板，然后将值 <span class="token builtin class-name">.</span> 传递给模板，最后将该模板的输出传递给 nindent 函数。

</code></pre></div><h2 id="开发自己的-chart"><a href="#开发自己的-chart" class="header-anchor">#</a> 开发自己的 chart</h2> <ul><li><p>先创建模板</p></li> <li><p>修改 Chart.yaml，Values.yaml，添加常用的变量</p></li> <li><p>在 templates 目录下创建部署镜像所需要的 yaml 文件，并变量引用 yaml 里经常变动的字段</p></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/21/2021, 1:25:38 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/系统组件与架构设计/K8S/20kubernetes 核心技术-集群安全机制 RBAC.html" class="prev">
        核心技术-集群安全机制 RBAC
      </a></span> <span class="next"><a href="/blog/系统组件与架构设计/K8S/23kubernetes 高可用集群搭建.html">
        高可用集群搭建
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.d06cb661.js" defer></script><script src="/blog/assets/js/3.21e2e031.js" defer></script><script src="/blog/assets/js/48.e3917371.js" defer></script>
  </body>
</html>
