<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SQL优化案例实践 | 一名GO+PHP工程师</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/blog/assets/css/0.styles.b3aba94c.css" as="style"><link rel="preload" href="/blog/assets/js/app.3a2a0635.js" as="script"><link rel="preload" href="/blog/assets/js/3.21e2e031.js" as="script"><link rel="preload" href="/blog/assets/js/76.af8a1eb5.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.d053698b.js"><link rel="prefetch" href="/blog/assets/js/100.d5cb88cb.js"><link rel="prefetch" href="/blog/assets/js/101.6bbce255.js"><link rel="prefetch" href="/blog/assets/js/102.968ea43c.js"><link rel="prefetch" href="/blog/assets/js/103.c5c5130e.js"><link rel="prefetch" href="/blog/assets/js/104.161b590d.js"><link rel="prefetch" href="/blog/assets/js/105.eaae1ece.js"><link rel="prefetch" href="/blog/assets/js/106.8bdfd9bf.js"><link rel="prefetch" href="/blog/assets/js/107.c9b230ac.js"><link rel="prefetch" href="/blog/assets/js/108.a5880443.js"><link rel="prefetch" href="/blog/assets/js/109.bab44539.js"><link rel="prefetch" href="/blog/assets/js/11.bc7d0bf1.js"><link rel="prefetch" href="/blog/assets/js/110.7ba602f1.js"><link rel="prefetch" href="/blog/assets/js/111.a11c7d35.js"><link rel="prefetch" href="/blog/assets/js/112.bb76db96.js"><link rel="prefetch" href="/blog/assets/js/113.9b314292.js"><link rel="prefetch" href="/blog/assets/js/114.f28a4d47.js"><link rel="prefetch" href="/blog/assets/js/115.6a21a21a.js"><link rel="prefetch" href="/blog/assets/js/116.1fd8cdf3.js"><link rel="prefetch" href="/blog/assets/js/117.193b54e8.js"><link rel="prefetch" href="/blog/assets/js/118.d91f7ec2.js"><link rel="prefetch" href="/blog/assets/js/119.857d484f.js"><link rel="prefetch" href="/blog/assets/js/12.2003a6c5.js"><link rel="prefetch" href="/blog/assets/js/120.c2fc1bab.js"><link rel="prefetch" href="/blog/assets/js/121.e93dfc27.js"><link rel="prefetch" href="/blog/assets/js/122.0ea0246a.js"><link rel="prefetch" href="/blog/assets/js/123.31436cd9.js"><link rel="prefetch" href="/blog/assets/js/124.6b522c49.js"><link rel="prefetch" href="/blog/assets/js/125.7be39e4f.js"><link rel="prefetch" href="/blog/assets/js/126.8b8a9b2d.js"><link rel="prefetch" href="/blog/assets/js/127.7d06eb7f.js"><link rel="prefetch" href="/blog/assets/js/128.3498b329.js"><link rel="prefetch" href="/blog/assets/js/129.b4fdbe4d.js"><link rel="prefetch" href="/blog/assets/js/13.d2837ebd.js"><link rel="prefetch" href="/blog/assets/js/130.4acdc8e4.js"><link rel="prefetch" href="/blog/assets/js/131.ef9fa33c.js"><link rel="prefetch" href="/blog/assets/js/132.1f9b4bbb.js"><link rel="prefetch" href="/blog/assets/js/133.a417b118.js"><link rel="prefetch" href="/blog/assets/js/134.6a6cf86d.js"><link rel="prefetch" href="/blog/assets/js/135.313b60a3.js"><link rel="prefetch" href="/blog/assets/js/136.2c3aff88.js"><link rel="prefetch" href="/blog/assets/js/137.50106a44.js"><link rel="prefetch" href="/blog/assets/js/138.87124965.js"><link rel="prefetch" href="/blog/assets/js/139.cb5c4cb6.js"><link rel="prefetch" href="/blog/assets/js/14.48fb5c32.js"><link rel="prefetch" href="/blog/assets/js/140.9719663d.js"><link rel="prefetch" href="/blog/assets/js/141.b0090c83.js"><link rel="prefetch" href="/blog/assets/js/142.e385a422.js"><link rel="prefetch" href="/blog/assets/js/143.9d960553.js"><link rel="prefetch" href="/blog/assets/js/144.e3ef5a71.js"><link rel="prefetch" href="/blog/assets/js/145.95b58ec4.js"><link rel="prefetch" href="/blog/assets/js/146.92cd1d56.js"><link rel="prefetch" href="/blog/assets/js/147.1aad7186.js"><link rel="prefetch" href="/blog/assets/js/148.b0a6ba25.js"><link rel="prefetch" href="/blog/assets/js/149.cf51c7a4.js"><link rel="prefetch" href="/blog/assets/js/15.977c5e43.js"><link rel="prefetch" href="/blog/assets/js/150.8961d634.js"><link rel="prefetch" href="/blog/assets/js/151.d4337140.js"><link rel="prefetch" href="/blog/assets/js/152.d4fcbdac.js"><link rel="prefetch" href="/blog/assets/js/153.8f0df288.js"><link rel="prefetch" href="/blog/assets/js/154.3108e3fe.js"><link rel="prefetch" href="/blog/assets/js/155.1c76998b.js"><link rel="prefetch" href="/blog/assets/js/156.14a1e6f8.js"><link rel="prefetch" href="/blog/assets/js/157.2a90db8a.js"><link rel="prefetch" href="/blog/assets/js/158.f649eaa4.js"><link rel="prefetch" href="/blog/assets/js/159.bde474db.js"><link rel="prefetch" href="/blog/assets/js/16.cc3bb18b.js"><link rel="prefetch" href="/blog/assets/js/160.da7deb2a.js"><link rel="prefetch" href="/blog/assets/js/161.5124a074.js"><link rel="prefetch" href="/blog/assets/js/162.7f4358a0.js"><link rel="prefetch" href="/blog/assets/js/163.76da1c99.js"><link rel="prefetch" href="/blog/assets/js/164.ebc9b6a7.js"><link rel="prefetch" href="/blog/assets/js/165.f7cbff8f.js"><link rel="prefetch" href="/blog/assets/js/166.5bcaa3dd.js"><link rel="prefetch" href="/blog/assets/js/167.b4296d08.js"><link rel="prefetch" href="/blog/assets/js/168.27dc81ce.js"><link rel="prefetch" href="/blog/assets/js/169.4614ac4e.js"><link rel="prefetch" href="/blog/assets/js/17.180fd8e8.js"><link rel="prefetch" href="/blog/assets/js/170.e41001f5.js"><link rel="prefetch" href="/blog/assets/js/171.0724bbd4.js"><link rel="prefetch" href="/blog/assets/js/172.2d5b541f.js"><link rel="prefetch" href="/blog/assets/js/173.f03b20a0.js"><link rel="prefetch" href="/blog/assets/js/174.092074fb.js"><link rel="prefetch" href="/blog/assets/js/175.bbae3a5c.js"><link rel="prefetch" href="/blog/assets/js/176.2380b0cf.js"><link rel="prefetch" href="/blog/assets/js/177.67fa30a9.js"><link rel="prefetch" href="/blog/assets/js/178.7f4bf5e6.js"><link rel="prefetch" href="/blog/assets/js/18.fa5bec70.js"><link rel="prefetch" href="/blog/assets/js/19.82d0b6cb.js"><link rel="prefetch" href="/blog/assets/js/2.cf693890.js"><link rel="prefetch" href="/blog/assets/js/20.8d88eb5f.js"><link rel="prefetch" href="/blog/assets/js/21.04aa936c.js"><link rel="prefetch" href="/blog/assets/js/22.6f38dceb.js"><link rel="prefetch" href="/blog/assets/js/23.00b0c454.js"><link rel="prefetch" href="/blog/assets/js/24.4949647c.js"><link rel="prefetch" href="/blog/assets/js/25.f090d9de.js"><link rel="prefetch" href="/blog/assets/js/26.64e9b11e.js"><link rel="prefetch" href="/blog/assets/js/27.f6f1b280.js"><link rel="prefetch" href="/blog/assets/js/28.ba46dc32.js"><link rel="prefetch" href="/blog/assets/js/29.08dd160e.js"><link rel="prefetch" href="/blog/assets/js/30.1f6b9a8b.js"><link rel="prefetch" href="/blog/assets/js/31.edcef4fa.js"><link rel="prefetch" href="/blog/assets/js/32.763b7b98.js"><link rel="prefetch" href="/blog/assets/js/33.10fa82ac.js"><link rel="prefetch" href="/blog/assets/js/34.783e6db1.js"><link rel="prefetch" href="/blog/assets/js/35.86d13f87.js"><link rel="prefetch" href="/blog/assets/js/36.c81ca450.js"><link rel="prefetch" href="/blog/assets/js/37.6c8b6e4d.js"><link rel="prefetch" href="/blog/assets/js/38.fed1555d.js"><link rel="prefetch" href="/blog/assets/js/39.d8367356.js"><link rel="prefetch" href="/blog/assets/js/4.33e3eeff.js"><link rel="prefetch" href="/blog/assets/js/40.890bdfe6.js"><link rel="prefetch" href="/blog/assets/js/41.351a2bb7.js"><link rel="prefetch" href="/blog/assets/js/42.7dc0997f.js"><link rel="prefetch" href="/blog/assets/js/43.b1eb7b31.js"><link rel="prefetch" href="/blog/assets/js/44.96773f8a.js"><link rel="prefetch" href="/blog/assets/js/45.14984c3f.js"><link rel="prefetch" href="/blog/assets/js/46.360c94b5.js"><link rel="prefetch" href="/blog/assets/js/47.6ba6e036.js"><link rel="prefetch" href="/blog/assets/js/48.7e30092c.js"><link rel="prefetch" href="/blog/assets/js/49.cffe09bd.js"><link rel="prefetch" href="/blog/assets/js/5.93c02369.js"><link rel="prefetch" href="/blog/assets/js/50.10849ea7.js"><link rel="prefetch" href="/blog/assets/js/51.29fb5c68.js"><link rel="prefetch" href="/blog/assets/js/52.c183fd4d.js"><link rel="prefetch" href="/blog/assets/js/53.2102d53f.js"><link rel="prefetch" href="/blog/assets/js/54.a7def65b.js"><link rel="prefetch" href="/blog/assets/js/55.e1462b05.js"><link rel="prefetch" href="/blog/assets/js/56.d35a7dec.js"><link rel="prefetch" href="/blog/assets/js/57.f908b76a.js"><link rel="prefetch" href="/blog/assets/js/58.8c699c1a.js"><link rel="prefetch" href="/blog/assets/js/59.013048e6.js"><link rel="prefetch" href="/blog/assets/js/6.bf46d9ef.js"><link rel="prefetch" href="/blog/assets/js/60.96011719.js"><link rel="prefetch" href="/blog/assets/js/61.c57dc954.js"><link rel="prefetch" href="/blog/assets/js/62.24bf6999.js"><link rel="prefetch" href="/blog/assets/js/63.2f87f55d.js"><link rel="prefetch" href="/blog/assets/js/64.68cd3b45.js"><link rel="prefetch" href="/blog/assets/js/65.d1a0e0c0.js"><link rel="prefetch" href="/blog/assets/js/66.d694b5d5.js"><link rel="prefetch" href="/blog/assets/js/67.1d93ad03.js"><link rel="prefetch" href="/blog/assets/js/68.7a922734.js"><link rel="prefetch" href="/blog/assets/js/69.e8dc5f21.js"><link rel="prefetch" href="/blog/assets/js/7.965a7048.js"><link rel="prefetch" href="/blog/assets/js/70.0ab39b68.js"><link rel="prefetch" href="/blog/assets/js/71.32fb9ba8.js"><link rel="prefetch" href="/blog/assets/js/72.d7621fb4.js"><link rel="prefetch" href="/blog/assets/js/73.f0b18643.js"><link rel="prefetch" href="/blog/assets/js/74.f4b27305.js"><link rel="prefetch" href="/blog/assets/js/75.d52134dd.js"><link rel="prefetch" href="/blog/assets/js/77.be15b0d2.js"><link rel="prefetch" href="/blog/assets/js/78.d456dcce.js"><link rel="prefetch" href="/blog/assets/js/79.12735350.js"><link rel="prefetch" href="/blog/assets/js/8.78eeb959.js"><link rel="prefetch" href="/blog/assets/js/80.2120e0e9.js"><link rel="prefetch" href="/blog/assets/js/81.04f50a1e.js"><link rel="prefetch" href="/blog/assets/js/82.db879ca5.js"><link rel="prefetch" href="/blog/assets/js/83.e89b8863.js"><link rel="prefetch" href="/blog/assets/js/84.07410b58.js"><link rel="prefetch" href="/blog/assets/js/85.d3e35fad.js"><link rel="prefetch" href="/blog/assets/js/86.f855e246.js"><link rel="prefetch" href="/blog/assets/js/87.bf22bce7.js"><link rel="prefetch" href="/blog/assets/js/88.6ed1a43d.js"><link rel="prefetch" href="/blog/assets/js/89.50e298db.js"><link rel="prefetch" href="/blog/assets/js/9.009d1183.js"><link rel="prefetch" href="/blog/assets/js/90.391f76ed.js"><link rel="prefetch" href="/blog/assets/js/91.d1662d38.js"><link rel="prefetch" href="/blog/assets/js/92.a65aa479.js"><link rel="prefetch" href="/blog/assets/js/93.bc850b53.js"><link rel="prefetch" href="/blog/assets/js/94.7dc858d7.js"><link rel="prefetch" href="/blog/assets/js/95.fce3d2c0.js"><link rel="prefetch" href="/blog/assets/js/96.7e3abf55.js"><link rel="prefetch" href="/blog/assets/js/97.64d3b035.js"><link rel="prefetch" href="/blog/assets/js/98.fdb7d67a.js"><link rel="prefetch" href="/blog/assets/js/99.9a416d3b.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.b3aba94c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">一名GO+PHP工程师</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://gitee.com/ColinWWL/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://gitee.com/ColinWWL/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/blog/数据库/Mysql/1视图-触发器-存储过程" class="sidebar-heading clickable open"><span>Mysql</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/数据库/Mysql/1视图-触发器-存储过程.html" class="sidebar-link">视图，存储过程，触发器</a></li><li><a href="/blog/数据库/Mysql/2物化视图-事务.html" class="sidebar-link">物化视图-事务</a></li><li><a href="/blog/数据库/Mysql/3事务日志与锁初体验.html" class="sidebar-link">事务与锁</a></li><li><a href="/blog/数据库/Mysql/4事务隔离与锁的关系.html" class="sidebar-link">事务隔离与锁的关系</a></li><li><a href="/blog/数据库/Mysql/5锁机制与数据库结构.html" class="sidebar-link">锁机制与数据库结构</a></li><li><a href="/blog/数据库/Mysql/6数据库文件.html" class="sidebar-link">数据库结构</a></li><li><a href="/blog/数据库/Mysql/7结构与存储引擎.html" class="sidebar-link">数据库结构详解</a></li><li><a href="/blog/数据库/Mysql/8发现问题.html" class="sidebar-link">问题发现</a></li><li><a href="/blog/数据库/Mysql/9数据库的基础设计.html" class="sidebar-link">数据库基础设计与表设计</a></li><li><a href="/blog/数据库/Mysql/10数据库字段选择与sql执行.html" class="sidebar-link">数据表字段选择与SQL执行流程</a></li><li><a href="/blog/数据库/Mysql/11sql分析.html" class="sidebar-link">sql分析</a></li><li><a href="/blog/数据库/Mysql/12explain实例与IO操作.html" class="sidebar-link">explain实例与IO操作</a></li><li><a href="/blog/数据库/Mysql/13SQL执行IO操作及索引基础.html" class="sidebar-link">SQL执行IO操作及索引基础</a></li><li><a href="/blog/数据库/Mysql/14索引基础.html" class="sidebar-link">索引基础</a></li><li><a href="/blog/数据库/Mysql/15SQL优化实例.html" class="active sidebar-link">SQL优化案例实践</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/数据库/Mysql/16join初步.html" class="sidebar-link">join 初步</a></li><li><a href="/blog/数据库/Mysql/17join优化思路.html" class="sidebar-link">join优化以及条件解析</a></li><li><a href="/blog/数据库/Mysql/20索引总结iCP与where提取.html" class="sidebar-link">索引总结iCP与where提取</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="sql优化案例实践"><a href="#sql优化案例实践" class="header-anchor">#</a> SQL优化案例实践</h1> <p>MySQL5.7 中文文档 https://www.docs4dev.com/docs/zh/mysql/5.7/reference/group-by-handling.html</p> <p><img src="/blog/assets/img/1222.e3f6aec3.png" alt=""></p> <div class="language-sql extra-class"><pre class="language-sql"><code>  根据数据表的一些建立的规则稍加调整一下数据表中的字段

  单表
  <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>customers1<span class="token punctuation">`</span> <span class="token punctuation">(</span>
      <span class="token comment">-- 身份证</span>
      <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
      <span class="token comment">-- 姓名</span>
      <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
      <span class="token comment">-- 城市名</span>
      <span class="token punctuation">`</span>city<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
      <span class="token comment">-- 性别：M（男），G（女）</span>
      <span class="token punctuation">`</span>gender<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
      <span class="token comment">-- 出生日期</span>
      <span class="token punctuation">`</span>birthdate<span class="token punctuation">`</span> <span class="token keyword">date</span>  <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
      <span class="token comment">-- 手机号</span>
      <span class="token punctuation">`</span>mobile<span class="token punctuation">`</span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
      <span class="token comment">-- 照片</span>
      <span class="token punctuation">`</span>photo<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
      <span class="token comment">-- 月薪</span>
      <span class="token punctuation">`</span>monthsalary<span class="token punctuation">`</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
      <span class="token comment">-- 年奖金额</span>
      <span class="token punctuation">`</span>yearbonus<span class="token punctuation">`</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
      <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8
  分表
  <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>customers<span class="token punctuation">`</span> <span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>city<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>gender<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>birthdate<span class="token punctuation">`</span> <span class="token keyword">date</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>mobile<span class="token punctuation">`</span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>photo<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8

  <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>salary<span class="token punctuation">`</span> <span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>monthsalary<span class="token punctuation">`</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>yearbonus<span class="token punctuation">`</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8

  <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">table</span> <span class="token keyword">force</span> <span class="token keyword">index</span><span class="token punctuation">(</span>PRI<span class="token punctuation">)</span> <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">(</span>强制使用主键<span class="token punctuation">)</span>
  <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">table</span> <span class="token keyword">ignore</span> <span class="token keyword">index</span><span class="token punctuation">(</span>PRI<span class="token punctuation">)</span> <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">(</span>禁止使用主键<span class="token punctuation">)</span>
</code></pre></div><h3 id="_1-没有主键的表的问题"><a href="#_1-没有主键的表的问题" class="header-anchor">#</a> 1. 没有主键的表的问题</h3> <p>没有主键索引的情况：https://www.jianshu.com/p/6c70402993eb<br>
大家可以看看这个链接吧,相对来说更加的详细</p> <h3 id="_2-列出没有手机号码-或者没有照片-或者没有年奖金的客户姓名"><a href="#_2-列出没有手机号码-或者没有照片-或者没有年奖金的客户姓名" class="header-anchor">#</a> 2. 列出没有手机号码，或者没有照片，或者没有年奖金的客户姓名</h3> <p>对于数据表调整，把一些允许为空的字段修改为 0 或其他特殊字符代替，这里我们把一些字段改为默认值为0表示null：解释</p> <p>尽量避免NULL很多表都包含可为NULL（空值）的列，即使应用程序并不需要保存NULL也是如此，这是因为可为NULL是列的默认属性。通常情况下最好指定列为NOTNULL，除非真的需要存储NULL值。</p> <p>如果查询中包含可为NULL的列，对MySQL来说更难优化，因为可为NULL的列使得索引、索引统计和值比较都更复杂。可为NULL的列会使用更多的存储空间，在MySQL里也需要特殊处理。当可为NULL的列被索引时，每个索引记录需要一个额外的字节，在MyISAM里甚至还可能导致固定大小的索引（例如只有一个整数列的索引）变成可变大小的索引。</p> <p>通常把可为NULL的列改为NOT NULL带来的性能提升比较小，所以（调优时）没有必要首先在现有schema中查找并修改掉这种情况，除非确定这会导致问题。但是，如果计划在列上建索引，就应该尽量避免设计成可为NULL的列。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">update</span> customers1 <span class="token keyword">set</span> yearbonus  <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">where</span> yearbonus  <span class="token operator">is</span> <span class="token boolean">null</span>
<span class="token keyword">update</span> customers1 <span class="token keyword">set</span> mobile <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">where</span> mobile <span class="token operator">is</span> <span class="token boolean">null</span>
<span class="token keyword">update</span> customers1 <span class="token keyword">set</span> photo  <span class="token operator">=</span> <span class="token number">0</span> wher e photo  <span class="token operator">is</span> <span class="token boolean">null</span>

<span class="token keyword">select</span> name<span class="token punctuation">,</span>photo<span class="token punctuation">,</span>mobile<span class="token punctuation">,</span>yearbonus <span class="token keyword">from</span> customers1 <span class="token keyword">where</span> photo <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">or</span> mobile <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">or</span> yearbonus <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre></div><p>如上便是我们所需要执行的SQL语句，也就是说实际上我们所进行的优化就是针对于or的请下的优化</p> <p>通过explain分析一下上面的SQL</p> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span>photo<span class="token punctuation">,</span>mobile<span class="token punctuation">,</span>yearbonus <span class="token keyword">from</span> customers1 <span class="token keyword">where</span> photo <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">or</span> mobile <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">or</span> yearbonus <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>      <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>    <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> customers1 <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">1310946</span> <span class="token operator">|</span>    <span class="token number">27.10</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.04</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span><span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> table_name
<span class="token operator">+</span><span class="token comment">------------+------------+-----------------------------+--------------+-------------+-----------+-------------+------------+</span>
<span class="token operator">|</span> <span class="token keyword">Table</span>      <span class="token operator">|</span> Non_unique <span class="token operator">|</span> Key_name                    <span class="token operator">|</span> Seq_in_index <span class="token operator">|</span> Column_name <span class="token operator">|</span> Collation <span class="token operator">|</span> Cardinality <span class="token operator">|</span> Index_type <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+------------+-----------------------------+--------------+-------------+-----------+-------------+------------+</span>
<span class="token operator">|</span> customers1 <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>                     <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> id          <span class="token operator">|</span> A         <span class="token operator">|</span>     <span class="token number">1310881</span> <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>
<span class="token operator">|</span> customers1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_gender_city_monthsalary <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> gender      <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>
<span class="token operator">|</span> customers1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_gender_city_monthsalary <span class="token operator">|</span>            <span class="token number">2</span> <span class="token operator">|</span> city        <span class="token operator">|</span> A         <span class="token operator">|</span>          <span class="token number">21</span> <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>
<span class="token operator">|</span> customers1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_gender_city_monthsalary <span class="token operator">|</span>            <span class="token number">3</span> <span class="token operator">|</span> monthsalary <span class="token operator">|</span> A         <span class="token operator">|</span>     <span class="token number">1310946</span> <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+------------+-----------------------------+--------------+-------------+-----------+-------------+------------+</span>
<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre></div><p>分别对于上面三个条件定义单独的索引</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">alter</span> <span class="token keyword">table</span> customers1 <span class="token keyword">add</span> <span class="token keyword">index</span> idx_photo<span class="token punctuation">(</span>photo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> customers1 <span class="token keyword">add</span> <span class="token keyword">index</span> idx_mobile<span class="token punctuation">(</span>mobile<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> customers1 <span class="token keyword">add</span> <span class="token keyword">index</span> idx_yearbonus<span class="token punctuation">(</span>yearbonus<span class="token punctuation">)</span><span class="token punctuation">;</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> customers1<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------------+------------+-----------------------------+--------------+-------------+-----------+-------------+------------+</span>
<span class="token operator">|</span> <span class="token keyword">Table</span>      <span class="token operator">|</span> Non_unique <span class="token operator">|</span> Key_name                    <span class="token operator">|</span> Seq_in_index <span class="token operator">|</span> Column_name <span class="token operator">|</span> Collation <span class="token operator">|</span> Cardinality <span class="token operator">|</span> Index_type <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+------------+-----------------------------+--------------+-------------+-----------+-------------+------------+</span>
<span class="token operator">|</span> customers1 <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>                     <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> id          <span class="token operator">|</span> A         <span class="token operator">|</span>     <span class="token number">1310881</span> <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>
<span class="token operator">|</span> customers1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_gender_city_monthsalary <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> gender      <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>
<span class="token operator">|</span> customers1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_gender_city_monthsalary <span class="token operator">|</span>            <span class="token number">2</span> <span class="token operator">|</span> city        <span class="token operator">|</span> A         <span class="token operator">|</span>          <span class="token number">21</span> <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>
<span class="token operator">|</span> customers1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_gender_city_monthsalary <span class="token operator">|</span>            <span class="token number">3</span> <span class="token operator">|</span> monthsalary <span class="token operator">|</span> A         <span class="token operator">|</span>     <span class="token number">1310946</span> <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>
<span class="token operator">|</span> customers1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_photo                   <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> photo       <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>
<span class="token operator">|</span> customers1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_mobile                  <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> mobile      <span class="token operator">|</span> A         <span class="token operator">|</span>      <span class="token number">697873</span> <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>
<span class="token operator">|</span> customers1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_yearbonus               <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> yearbonus   <span class="token operator">|</span> A         <span class="token operator">|</span>        <span class="token number">9996</span> <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+------------+-----------------------------+--------------+-------------+-----------+-------------+------------+</span>
<span class="token number">7</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

然后再通过分析
mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span>photo<span class="token punctuation">,</span>mobile<span class="token punctuation">,</span>yearbonus <span class="token keyword">from</span> customers1 <span class="token keyword">where</span> photo <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">or</span> mobile <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">or</span> yearbonus <span class="token operator">=</span> <span class="token number">0</span> \G<span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
           id: <span class="token number">1</span>
  select_type: <span class="token keyword">SIMPLE</span>
        <span class="token keyword">table</span>: customers1
   partitions: <span class="token boolean">NULL</span>
         <span class="token keyword">type</span>: <span class="token keyword">ALL</span>
possible_keys: idx_photo<span class="token punctuation">,</span>idx_mobile<span class="token punctuation">,</span>idx_yearbonus
          <span class="token keyword">key</span>: <span class="token boolean">NULL</span>
      key_len: <span class="token boolean">NULL</span>
          ref: <span class="token boolean">NULL</span>
         <span class="token keyword">rows</span>: <span class="token number">1310946</span>
     filtered: <span class="token number">27.10</span>
        Extra: <span class="token keyword">Using</span> <span class="token keyword">where</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token keyword">warnings</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre></div><p>发现并没有使用到所以定一点的索引，主要是因为出现多个索引做联合操作是（多个OR条件），对结果的合并、排序等操作需要费大量的CPU和内存资源，特别是当其中的某些索引的选择性不高，需要返回合并大量数据时，查询成本更高。所以这种情况下还不如走全表扫描。</p> <p>官方对于OR的解释 https://dev.mysql.com/doc/refman/5.7/en/index-merge-optimization.html</p> <p>可以通过union all / union 进行优化，union all 主要是将两个select语句的结果作为一个整体显示出来</p> <p>union和union all的区别是,union会自动压缩多个结果集合中的重复结果，而union all则将所有的结果全部显示出来，不管是不是重复。</p> <div class="language-sql extra-class"><pre class="language-sql"><code>通过<span class="token keyword">explain</span>分析
<span class="token keyword">explain</span>
<span class="token keyword">select</span> name <span class="token keyword">from</span> customers1 <span class="token keyword">where</span> photo <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> name <span class="token keyword">from</span> customers1 <span class="token keyword">where</span> mobile <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> name <span class="token keyword">from</span> customers1 <span class="token keyword">where</span> yearbonus <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token operator">+</span><span class="token comment">----+-------------+------------+------+---------------+---------------+---------+-------+--------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>      <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>           <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------+---------------+---------------+---------+-------+--------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> customers1 <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> idx_photo     <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">577859</span> <span class="token operator">|</span>    <span class="token number">10.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> customers1 <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> idx_mobile    <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">577859</span> <span class="token operator">|</span>    <span class="token number">10.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> customers1 <span class="token operator">|</span> ref  <span class="token operator">|</span> idx_yearbonus <span class="token operator">|</span> idx_yearbonus <span class="token operator">|</span> <span class="token number">5</span>       <span class="token operator">|</span> const <span class="token operator">|</span> <span class="token number">288929</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------+---------------+---------------+---------+-------+--------+----------+-------------+</span>
</code></pre></div><p>索引使用注意：<font color="red">1. 字符串字段索引值不加引号会失效</font></p> <p>当前的所建立的索引实际上并不是特别的好因为会引起回表，为了与更好的效果因此先重新定义索引，根据三条SQL创建对应的SQL</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">alter</span> <span class="token keyword">table</span> customers1 <span class="token keyword">drop</span> <span class="token keyword">index</span> idx_photo<span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> customers1 <span class="token keyword">drop</span> <span class="token keyword">index</span> idx_mobile<span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> customers1 <span class="token keyword">drop</span> <span class="token keyword">index</span> idx_yearbonus<span class="token punctuation">;</span>

<span class="token keyword">alter</span> <span class="token keyword">table</span> customers1 <span class="token keyword">add</span> <span class="token keyword">index</span> idx_yearbonus_name<span class="token punctuation">(</span>yearbonus<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">-- 1</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> customers1 <span class="token keyword">add</span> <span class="token keyword">index</span> idx_moblie_name<span class="token punctuation">(</span>mobile<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">-- 2</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> customers1 <span class="token keyword">add</span> <span class="token keyword">index</span> idx_name_photo<span class="token punctuation">(</span>name<span class="token punctuation">,</span>photo<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">-- 3</span>
</code></pre></div><p>如上1,2创建的索引问题不大,3相信很多的疑问，因为这有违背之前所讲的索引挑选的原则，就是优先选择与where 之后的字段作为索引以及最左侧的索引，但是现在选择name为最左侧；这其实在建立的时候我们需要思考当前的这个索引在建立之后可重复用的情况，实际项目操作中我们很少有单独的根据图片去查询用户的信息，更多的时候我们会选择根据用户的某一些信息来查询用户的图片所以在3建立的时候我们需要选择与name作为最左侧查询；</p> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span> <span class="token keyword">select</span> name <span class="token keyword">from</span> customers1 <span class="token keyword">where</span> photo <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+-------+---------------+----------------+---------+--------+----------+--------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>      <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>            <span class="token operator">|</span> key_len <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+-------+---------------+----------------+---------+--------+----------+--------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> customers1 <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> idx_name_photo <span class="token operator">|</span> <span class="token number">124</span>     <span class="token operator">|</span> <span class="token number">577859</span> <span class="token operator">|</span>    <span class="token number">10.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+-------+---------------+----------------+---------+--------+----------+--------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

别忘了在对于做出分析

<span class="token keyword">explain</span>
<span class="token keyword">select</span> name <span class="token keyword">from</span> customers1 <span class="token keyword">where</span> photo <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> name <span class="token keyword">from</span> customers1 <span class="token keyword">where</span> mobile <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> name <span class="token keyword">from</span> customers1 <span class="token keyword">where</span> yearbonus <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_4-覆盖索引"><a href="#_4-覆盖索引" class="header-anchor">#</a> 4. 覆盖索引</h3> <p>对于上面的3SQLmysql的操作</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">explain</span> <span class="token keyword">select</span> name <span class="token keyword">from</span> customers1 <span class="token keyword">where</span> photo <span class="token operator">=</span> <span class="token string">'0'</span> <span class="token operator">and</span> gender <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> customers1 <span class="token keyword">where</span> photo <span class="token operator">=</span> <span class="token string">'0'</span> <span class="token punctuation">;</span>
</code></pre></div><p>a. 查询哪些索引满足where 字段的最左匹配的字段<br>
b. 查询获取的字段是否都在某一些索引中<br>
c. 根据b找到索引再去匹配where 中的字段是否也包含</p> <p>辅助索引:子节点 =&gt; 主键id, 它自己的索引值, 联合索引的其他字段值</p> <h3 id="_5-区间分组统计查询"><a href="#_5-区间分组统计查询" class="header-anchor">#</a> 5. 区间分组统计查询</h3> <p>这个地方需要使用elt,interval,在查询中有些时候我们是需要进行区间分组</p> <div class="language-sql extra-class"><pre class="language-sql"><code>先用一个小表演示一下操作
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>class<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>score<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">21</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8
</code></pre></div><p>数据自己添加，统计个分数区间数据<br>
比如现在统计&lt;50,&lt;50、50-60、60-70、70-80、80-90、90-100、&gt;=100分数区间的人数<br>
利用 INTERVAL 划出7个区间；再利用 elt 函数将7个区间分别返回一个列名，如下SQL：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> elt<span class="token punctuation">(</span>
  <span class="token keyword">INTERVAL</span><span class="token punctuation">(</span>score<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">'&lt;50'</span><span class="token punctuation">,</span> <span class="token string">'50-60'</span><span class="token punctuation">,</span> <span class="token string">'60-70'</span><span class="token punctuation">,</span> <span class="token string">'70-80'</span><span class="token punctuation">,</span> <span class="token string">'80-90'</span><span class="token punctuation">,</span> <span class="token string">'90-100'</span><span class="token punctuation">,</span> <span class="token string">'&gt;=100'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> score_level<span class="token punctuation">,</span>
  <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> counts
<span class="token keyword">FROM</span> class
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> elt<span class="token punctuation">(</span>
  <span class="token keyword">INTERVAL</span><span class="token punctuation">(</span>score<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">'&lt;50'</span><span class="token punctuation">,</span> <span class="token string">'50-60'</span><span class="token punctuation">,</span> <span class="token string">'60-70'</span><span class="token punctuation">,</span> <span class="token string">'70-80'</span><span class="token punctuation">,</span> <span class="token string">'80-90'</span><span class="token punctuation">,</span> <span class="token string">'90-100'</span><span class="token punctuation">,</span> <span class="token string">'&gt;=100'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------------+--------+</span>
<span class="token operator">|</span> score_level <span class="token operator">|</span> counts <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+--------+</span>
<span class="token operator">|</span> <span class="token number">50</span><span class="token operator">-</span><span class="token number">60</span>       <span class="token operator">|</span>      <span class="token number">4</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">60</span><span class="token operator">-</span><span class="token number">70</span>       <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">70</span><span class="token operator">-</span><span class="token number">80</span>       <span class="token operator">|</span>      <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">80</span><span class="token operator">-</span><span class="token number">90</span>       <span class="token operator">|</span>      <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token number">50</span>         <span class="token operator">|</span>     <span class="token number">11</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+--------+</span>

自定义排序：
<span class="token keyword">SELECT</span> elt<span class="token punctuation">(</span>
  <span class="token keyword">INTERVAL</span><span class="token punctuation">(</span>score<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token string">'1/&lt;50'</span><span class="token punctuation">,</span> <span class="token string">'2/50-60'</span><span class="token punctuation">,</span> <span class="token string">'3/60-70'</span><span class="token punctuation">,</span> <span class="token string">'4/70-80'</span><span class="token punctuation">,</span> <span class="token string">'5/80-90'</span><span class="token punctuation">,</span> <span class="token string">'6/90-100'</span><span class="token punctuation">,</span> <span class="token string">'7/&gt;=100'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> score_level<span class="token punctuation">,</span>
  <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> counts
<span class="token keyword">FROM</span> class
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> elt<span class="token punctuation">(</span>
  <span class="token keyword">INTERVAL</span><span class="token punctuation">(</span>score<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">'1/&lt;50'</span><span class="token punctuation">,</span> <span class="token string">'2/50-60'</span><span class="token punctuation">,</span> <span class="token string">'3/60-70'</span><span class="token punctuation">,</span> <span class="token string">'4/70-80'</span><span class="token punctuation">,</span> <span class="token string">'5/80-90'</span><span class="token punctuation">,</span> <span class="token string">'6/90-100'</span><span class="token punctuation">,</span> <span class="token string">'7/&gt;=100'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_6-不同年龄段-0到100岁之间-每10岁为一个年龄段-的客户平均年收入"><a href="#_6-不同年龄段-0到100岁之间-每10岁为一个年龄段-的客户平均年收入" class="header-anchor">#</a> 6. 不同年龄段(0到100岁之间，每10岁为一个年龄段)的客户平均年收入</h3> <blockquote><p>创建索引从上可以得知我们可以通过给birthdate, monthsalary, yearbonus 这三个字段定义索引就可以起到很好地效果，但是如何定义，索引字段顺序如何选择？</p></blockquote> <p>通常来说对于联合索引的选择最好是要选择与区分度比较高的作为索引的第一例，不过这并不一定是最好的选择只能说是大部分很实用；在实际中你还需要根据查询的频繁度去考虑这个前后的关系；<strong>当不需要考虑排序和分组时，讲选择性最高的列放在前面通常是很好的</strong> 这时候索引作用只是用于优化where条件的查询。在这种情况下，这样设计的索引确实能够最快地过滤出需要的行，对于在WHERE子句中只使用了索引部分前缀列的查询来说选择性也更高。然而，性能不只是依赖于所有索引列的选择性（整体基数），也和查询条件的具体值有关，也就是和值的分布有关。</p> <p>如上的SQL可通过按经验法则来做，因为经验法则考虑的是全局基数和选择性，而不是某个具体查询：查找方式主要是统计数据对于总数据量的分布范围，选择与常作为条件并且分布相对多的字段</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span>
  <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> yearbonus<span class="token punctuation">)</span><span class="token operator">/</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> year_select<span class="token punctuation">,</span>
  <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> monthsalary<span class="token punctuation">)</span><span class="token operator">/</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> mon_select<span class="token punctuation">,</span>
  <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> TIMESTAMPDIFF<span class="token punctuation">(</span><span class="token keyword">YEAR</span><span class="token punctuation">,</span> birthdate<span class="token punctuation">,</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> bir_select<span class="token punctuation">,</span>
  <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> counts
<span class="token keyword">from</span> customers1<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------------+------------+------------+--------+</span>
<span class="token operator">|</span> year_select <span class="token operator">|</span> mon_select <span class="token operator">|</span> bir_select <span class="token operator">|</span> counts <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+------------+------------+--------+</span>
<span class="token operator">|</span>      <span class="token number">0.0167</span> <span class="token operator">|</span>     <span class="token number">0.7515</span> <span class="token operator">|</span>     <span class="token number">0.0002</span> <span class="token operator">|</span> <span class="token number">600000</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------+------------+------------+--------+</span>

monthsalary的选择性更高，索引答案是将其作为索引列的第一列因此索引的建立就是
<span class="token keyword">alter</span> <span class="token keyword">table</span> customers1 <span class="token keyword">add</span> <span class="token keyword">index</span> idx_monthsalary_yearbonus_birthdate<span class="token punctuation">(</span>monthsalary<span class="token punctuation">,</span>yearbonus<span class="token punctuation">,</span>birthdate<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">explain</span>
<span class="token keyword">select</span>
		elt<span class="token punctuation">(</span><span class="token keyword">interval</span><span class="token punctuation">(</span>TIMESTAMPDIFF<span class="token punctuation">(</span><span class="token keyword">YEAR</span><span class="token punctuation">,</span> birthdate<span class="token punctuation">,</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token string">'0-10'</span><span class="token punctuation">,</span> <span class="token string">'10-20'</span><span class="token punctuation">,</span> <span class="token string">'20-30'</span><span class="token punctuation">,</span> <span class="token string">'30-40'</span><span class="token punctuation">,</span> <span class="token string">'40-50'</span><span class="token punctuation">,</span> <span class="token string">'50-60'</span><span class="token punctuation">,</span> <span class="token string">'60-70'</span><span class="token punctuation">,</span> <span class="token string">'70-80'</span><span class="token punctuation">,</span> <span class="token string">'80-90'</span><span class="token punctuation">,</span> <span class="token string">'90-100'</span><span class="token punctuation">,</span> <span class="token string">'100&gt;'</span>
		<span class="token punctuation">)</span> <span class="token keyword">as</span> age_level<span class="token punctuation">,</span> <span class="token function">avg</span><span class="token punctuation">(</span><span class="token punctuation">(</span>monthsalary <span class="token operator">*</span> <span class="token number">12</span> <span class="token operator">+</span> yearbonus<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> income
<span class="token keyword">from</span> customers1
<span class="token keyword">group</span> <span class="token keyword">by</span>
	elt<span class="token punctuation">(</span><span class="token keyword">interval</span><span class="token punctuation">(</span>TIMESTAMPDIFF<span class="token punctuation">(</span><span class="token keyword">YEAR</span><span class="token punctuation">,</span> birthdate<span class="token punctuation">,</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token string">'0-10'</span><span class="token punctuation">,</span> <span class="token string">'10-20'</span><span class="token punctuation">,</span> <span class="token string">'20-30'</span><span class="token punctuation">,</span> <span class="token string">'30-40'</span><span class="token punctuation">,</span> <span class="token string">'40-50'</span><span class="token punctuation">,</span> <span class="token string">'50-60'</span><span class="token punctuation">,</span> <span class="token string">'60-70'</span><span class="token punctuation">,</span> <span class="token string">'70-80'</span><span class="token punctuation">,</span> <span class="token string">'80-90'</span><span class="token punctuation">,</span> <span class="token string">'90-100'</span><span class="token punctuation">,</span> <span class="token string">'100&gt;'</span>
  <span class="token punctuation">)</span> \G<span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
           id: <span class="token number">1</span>
  select_type: <span class="token keyword">SIMPLE</span>
        <span class="token keyword">table</span>: customers1
   partitions: <span class="token boolean">NULL</span>
         <span class="token keyword">type</span>: <span class="token keyword">index</span>
possible_keys: idx_monthsalary_yearbonus_birthdate
          <span class="token keyword">key</span>: idx_monthsalary_yearbonus_birthdate
      key_len: <span class="token number">13</span>
          ref: <span class="token boolean">NULL</span>
         <span class="token keyword">rows</span>: <span class="token number">577859</span>
     filtered: <span class="token number">100.00</span>
        Extra: <span class="token keyword">Using</span> <span class="token keyword">index</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">temporary</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> filesort
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

可以看到使用了索引
</code></pre></div><h3 id="_7-mysql5-7函数索引"><a href="#_7-mysql5-7函数索引" class="header-anchor">#</a> 7. mysql5.7函数索引</h3> <p>测试</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> customers1 <span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> birthdate<span class="token punctuation">(</span>birthdate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> customers1 <span class="token keyword">where</span> TIMESTAMPDIFF<span class="token punctuation">(</span><span class="token keyword">YEAR</span><span class="token punctuation">,</span> birthdate<span class="token punctuation">,</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre></div><p>MySQL5.7 函数索引 https://dev.mysql.com/doc/refman/5.7/en/create-table-generated-columns.html</p> <p>函数索引：MySQL所谓的函数索引其实在本质上解释还是btree索引，实现的方式主要是通过在数据表中新增一个字段用来存放函数字段列，然后对这个字段定义一个索引。</p> <div class="language-sql extra-class"><pre class="language-sql"><code>创建函数索引
<span class="token number">1</span>、添加一个虚拟的字段
<span class="token keyword">alter</span> <span class="token keyword">table</span> class <span class="token keyword">add</span> <span class="token keyword">column</span> scorce_generated <span class="token keyword">int</span>  generated always <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token function">ROUND</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2</span>、添加索引
<span class="token keyword">alter</span> <span class="token keyword">table</span> class <span class="token keyword">add</span> <span class="token keyword">key</span> idx_scorce_generated<span class="token punctuation">(</span>scorce_generated<span class="token punctuation">)</span><span class="token punctuation">;</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> class<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------+------------+----------------------+--------------+------------------+-----------+-------------+------------+---------+---------------+</span>
<span class="token operator">|</span> <span class="token keyword">Table</span> <span class="token operator">|</span> Non_unique <span class="token operator">|</span> Key_name             <span class="token operator">|</span> Seq_in_index <span class="token operator">|</span> Column_name      <span class="token operator">|</span> Collation <span class="token operator">|</span> Cardinality <span class="token operator">|</span> Index_type <span class="token operator">|</span> <span class="token keyword">Comment</span> <span class="token operator">|</span> Index_comment <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+------------+----------------------+--------------+------------------+-----------+-------------+------------+---------+---------------+</span>
<span class="token operator">|</span> class <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>              <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> id               <span class="token operator">|</span> A         <span class="token operator">|</span>          <span class="token number">20</span> <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>         <span class="token operator">|</span>               <span class="token operator">|</span>
<span class="token operator">|</span> class <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_scorce_generated <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> scorce_generated <span class="token operator">|</span> A         <span class="token operator">|</span>          <span class="token number">18</span> <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>         <span class="token operator">|</span>               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+------------+----------------------+--------------+------------------+-----------+-------------+------------+---------+---------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

官方例子 直接在创建数据表的时候添加这个操作
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> triangle <span class="token punctuation">(</span>
  sidea <span class="token keyword">DOUBLE</span><span class="token punctuation">,</span>
  sideb <span class="token keyword">DOUBLE</span><span class="token punctuation">,</span>
  sidec <span class="token keyword">DOUBLE</span> <span class="token keyword">AS</span> <span class="token punctuation">(</span>SQRT<span class="token punctuation">(</span>sidea <span class="token operator">*</span> sidea <span class="token operator">+</span> sideb <span class="token operator">*</span> sideb<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> triangle <span class="token punctuation">(</span>sidea<span class="token punctuation">,</span> sideb<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

如下是语法
col_name data_type <span class="token punctuation">[</span>GENERATED ALWAYS<span class="token punctuation">]</span> <span class="token keyword">AS</span> <span class="token punctuation">(</span>expr<span class="token punctuation">)</span>
  <span class="token punctuation">[</span>VIRTUAL <span class="token operator">|</span> STORED<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span><span class="token punctuation">]</span>
  <span class="token punctuation">[</span><span class="token keyword">UNIQUE</span> <span class="token punctuation">[</span><span class="token keyword">KEY</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">PRIMARY</span><span class="token punctuation">]</span> <span class="token keyword">KEY</span><span class="token punctuation">]</span>
  <span class="token punctuation">[</span><span class="token keyword">COMMENT</span> <span class="token string">'string'</span><span class="token punctuation">]</span>
</code></pre></div><h4 id="_8-group问题"><a href="#_8-group问题" class="header-anchor">#</a> 8. group问题</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token number">1</span>、MySQL中MAX函数与<span class="token keyword">Group</span> <span class="token keyword">By</span>一起使用的注意事项
条件：同一个user_role
业务：根据权限分组查询user_id最大的数据

MySQL <span class="token number">5.5</span> 版本

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> user_role<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+---------+---------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> user_id <span class="token operator">|</span> role_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+---------+---------+</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span>       <span class="token number">3</span> <span class="token operator">|</span>       <span class="token number">3</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span>       <span class="token number">4</span> <span class="token operator">|</span>       <span class="token number">4</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span>       <span class="token number">0</span> <span class="token operator">|</span>       <span class="token number">0</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">11</span> <span class="token operator">|</span>      <span class="token number">17</span> <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">13</span> <span class="token operator">|</span>      <span class="token number">19</span> <span class="token operator">|</span>       <span class="token number">3</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">16</span> <span class="token operator">|</span>      <span class="token number">22</span> <span class="token operator">|</span>       <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">18</span> <span class="token operator">|</span>      <span class="token number">24</span> <span class="token operator">|</span>       <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">19</span> <span class="token operator">|</span>      <span class="token number">25</span> <span class="token operator">|</span>       <span class="token number">3</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">22</span> <span class="token operator">|</span>      <span class="token number">31</span> <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+---------+---------+</span>
<span class="token number">9</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

如下就是我们平时的<span class="token keyword">SQL</span>写法

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>role_id<span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> <span class="token keyword">from</span> user_role <span class="token keyword">group</span> <span class="token keyword">by</span> role_id<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+---------+--------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> role_id <span class="token operator">|</span> <span class="token function">max</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+---------+--------------+</span>
<span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span>       <span class="token number">0</span> <span class="token operator">|</span>            <span class="token number">0</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">11</span> <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span>           <span class="token number">31</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">16</span> <span class="token operator">|</span>       <span class="token number">2</span> <span class="token operator">|</span>           <span class="token number">24</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span>       <span class="token number">3</span> <span class="token operator">|</span>           <span class="token number">25</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span>       <span class="token number">4</span> <span class="token operator">|</span>            <span class="token number">4</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+---------+--------------+</span>
<span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

但是会很容易的发现实际上数据并不对比如我们查询id为<span class="token number">11</span>的数据，user_id并不是<span class="token number">31</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> user_role <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+---------+---------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> user_id <span class="token operator">|</span> role_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+---------+---------+</span>
<span class="token operator">|</span> <span class="token number">11</span> <span class="token operator">|</span>      <span class="token number">17</span> <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+---------+---------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

所以这里需要注意一下！！！<span class="token keyword">SQL</span>改为如下方式：
<span class="token keyword">select</span> id<span class="token punctuation">,</span>role_id<span class="token punctuation">,</span>user_id <span class="token keyword">from</span> <span class="token punctuation">(</span>
	<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> user_role <span class="token keyword">order</span> <span class="token keyword">by</span> user_id <span class="token keyword">desc</span>
<span class="token punctuation">)</span> <span class="token keyword">as</span> a <span class="token keyword">group</span> <span class="token keyword">by</span> role_id
<span class="token operator">+</span><span class="token comment">----+---------+---------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> role_id <span class="token operator">|</span> user_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+---------+---------+</span>
<span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span>       <span class="token number">0</span> <span class="token operator">|</span>       <span class="token number">0</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">22</span> <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span>      <span class="token number">31</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">18</span> <span class="token operator">|</span>       <span class="token number">2</span> <span class="token operator">|</span>      <span class="token number">24</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">19</span> <span class="token operator">|</span>       <span class="token number">3</span> <span class="token operator">|</span>      <span class="token number">25</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span>       <span class="token number">4</span> <span class="token operator">|</span>       <span class="token number">4</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+---------+---------+</span>
<span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

测试id <span class="token operator">=</span> <span class="token number">22</span> 数据

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> user_role <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">22</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+---------+---------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> user_id <span class="token operator">|</span> role_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+---------+---------+</span>
<span class="token operator">|</span> <span class="token number">22</span> <span class="token operator">|</span>      <span class="token number">31</span> <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+---------+---------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

切换为MySQL <span class="token number">5.7</span> 测试 <span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>∑<span class="token punctuation">(</span>ﾟДﾟノ<span class="token punctuation">)</span>ノ 然后发现又是一个坑 （<span class="token operator">*</span>゜Д゜）σ凸←自爆按钮

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>role_id<span class="token punctuation">,</span>user_id <span class="token keyword">from</span> <span class="token punctuation">(</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> user_role <span class="token keyword">order</span> <span class="token keyword">by</span> user_id <span class="token keyword">desc</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> a <span class="token keyword">group</span> <span class="token keyword">by</span> role_id<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+---------+---------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> role_id <span class="token operator">|</span> user_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+---------+---------+</span>
<span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span>       <span class="token number">0</span> <span class="token operator">|</span>       <span class="token number">0</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">11</span> <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span>      <span class="token number">17</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">16</span> <span class="token operator">|</span>       <span class="token number">2</span> <span class="token operator">|</span>      <span class="token number">22</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span>       <span class="token number">3</span> <span class="token operator">|</span>       <span class="token number">3</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span>       <span class="token number">4</span> <span class="token operator">|</span>       <span class="token number">4</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+---------+---------+</span>
<span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

数据不对呀<span class="token punctuation">(</span>〃＞皿＜<span class="token punctuation">)</span>

实际上MySQL <span class="token number">5.7</span> 对于<span class="token keyword">SQL</span>进行了改写
mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>role_id<span class="token punctuation">,</span>user_id <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> user_role <span class="token keyword">order</span> <span class="token keyword">by</span> user_id <span class="token keyword">desc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> a <span class="token keyword">group</span> <span class="token keyword">by</span> role_id<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------+------------+------+------+------+----------+---------------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>     <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------+------------+------+------+------+----------+---------------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> user_role <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">9</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">temporary</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> filesort <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-----------+------------+------+------+------+----------+---------------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">warnings</span> \G<span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
  <span class="token keyword">Level</span>: Note
   Code: <span class="token number">1003</span>
Message: <span class="token comment">/* select#1 */</span> <span class="token keyword">select</span> <span class="token punctuation">`</span>mysql12<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>user_role<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>mysql12<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>user_role<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>role_id<span class="token punctuation">`</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>role_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>mysql12<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>user_role<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> <span class="token keyword">from</span> <span class="token punctuation">`</span>mysql12<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>user_role<span class="token punctuation">`</span> <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token punctuation">`</span>mysql12<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>user_role<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>role_id<span class="token punctuation">`</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

ERROR:
<span class="token keyword">No</span> query specified

官方的解释：https:<span class="token comment">//bugs.mysql.com/bug.php?id=80131</span>

那么可实行的方法：
<span class="token number">1</span>、
<span class="token keyword">select</span> u<span class="token punctuation">.</span>id<span class="token punctuation">,</span>u<span class="token punctuation">.</span>role_id<span class="token punctuation">,</span>u<span class="token punctuation">.</span>user_id <span class="token keyword">from</span> user_role u<span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> max_user_id<span class="token punctuation">,</span>role_id <span class="token keyword">from</span> user_role <span class="token keyword">group</span> <span class="token keyword">by</span> role_id <span class="token punctuation">)</span>
<span class="token keyword">as</span> a <span class="token keyword">where</span> a<span class="token punctuation">.</span>max_user_id <span class="token operator">=</span> u<span class="token punctuation">.</span>user_id <span class="token operator">and</span> a<span class="token punctuation">.</span>role_id <span class="token operator">=</span> u<span class="token punctuation">.</span>role_id
<span class="token operator">+</span><span class="token comment">----+---------+---------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> role_id <span class="token operator">|</span> user_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+---------+---------+</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span>       <span class="token number">4</span> <span class="token operator">|</span>       <span class="token number">4</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span>       <span class="token number">0</span> <span class="token operator">|</span>       <span class="token number">0</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">18</span> <span class="token operator">|</span>       <span class="token number">2</span> <span class="token operator">|</span>      <span class="token number">24</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">19</span> <span class="token operator">|</span>       <span class="token number">3</span> <span class="token operator">|</span>      <span class="token number">25</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">22</span> <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span>      <span class="token number">31</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+---------+---------+</span>
<span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token number">2</span>、
<span class="token keyword">select</span>
	u<span class="token punctuation">.</span>id<span class="token punctuation">,</span>u<span class="token punctuation">.</span>role_id<span class="token punctuation">,</span>u<span class="token punctuation">.</span>user_id
<span class="token keyword">from</span>
	user_role u <span class="token keyword">left</span> <span class="token keyword">join</span> user_role a <span class="token keyword">on</span> u<span class="token punctuation">.</span>role_id <span class="token operator">=</span> a<span class="token punctuation">.</span>role_id <span class="token operator">and</span> u<span class="token punctuation">.</span>user_id <span class="token operator">&lt;</span> a<span class="token punctuation">.</span>user_id
<span class="token keyword">where</span>
	a<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">;</span>

推介<span class="token number">1</span>把容易理解，相对来说效率高一些

关于MySQL5<span class="token punctuation">.</span><span class="token number">7</span> <span class="token keyword">group</span> 与 <span class="token keyword">order</span> 问题 还有解决方法就是

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>role_id<span class="token punctuation">,</span>user_id <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> user_role <span class="token keyword">order</span> <span class="token keyword">by</span> user_id <span class="token keyword">desc</span> <span class="token keyword">limit</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">100</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> a <span class="token keyword">group</span> <span class="token keyword">by</span> role_id<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+---------+---------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> role_id <span class="token operator">|</span> user_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+---------+---------+</span>
<span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span>       <span class="token number">0</span> <span class="token operator">|</span>       <span class="token number">0</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">22</span> <span class="token operator">|</span>       <span class="token number">1</span> <span class="token operator">|</span>      <span class="token number">31</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">18</span> <span class="token operator">|</span>       <span class="token number">2</span> <span class="token operator">|</span>      <span class="token number">24</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">19</span> <span class="token operator">|</span>       <span class="token number">3</span> <span class="token operator">|</span>      <span class="token number">25</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span>       <span class="token number">4</span> <span class="token operator">|</span>       <span class="token number">4</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+---------+---------+</span>
<span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

必须要加上<span class="token keyword">limit</span> 才可以
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/21/2021, 1:25:38 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/数据库/Mysql/14索引基础.html" class="prev">
        索引基础
      </a></span> <span class="next"><a href="/blog/数据库/Mysql/16join初步.html">
        join 初步
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.3a2a0635.js" defer></script><script src="/blog/assets/js/3.21e2e031.js" defer></script><script src="/blog/assets/js/76.af8a1eb5.js" defer></script>
  </body>
</html>
